<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>APM:Libraries: libraries/AC_WPNav/AC_WPNav.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">APM:Libraries
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_bc0718b08fb2015b8e59c47b2805f60c.html">libraries</a></li><li class="navelem"><a class="el" href="dir_5cde218765bee285f5f28a6d4508184e.html">AC_WPNav</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">AC_WPNav.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="AC__WPNav_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="AP__HAL_8h.html">AP_HAL/AP_HAL.h</a>&gt;</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="AC__WPNav_8h.html">AC_WPNav.h</a>&quot;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">extern</span> <span class="keyword">const</span> <a class="code" href="classAP__HAL_1_1HAL.html">AP_HAL::HAL</a>&amp; <a class="code" href="AC__WPNav_8cpp.html#ae08c3ca4ba26b63cda0bb3e3c6c02785">hal</a>;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">const</span> <a class="code" href="structAP__Param_1_1GroupInfo.html">AP_Param::GroupInfo</a> <a class="code" href="classAC__WPNav.html#a2016e7949dc1d451bdfd72285ea38cec">AC_WPNav::var_info</a>[] = {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    <span class="comment">// index 0 was used for the old orientation matrix</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    <span class="comment">// @Param: SPEED</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    <span class="comment">// @DisplayName: Waypoint Horizontal Speed Target</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    <span class="comment">// @Description: Defines the speed in cm/s which the aircraft will attempt to maintain horizontally during a WP mission</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    <span class="comment">// @Units: cm/s</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    <span class="comment">// @Range: 20 2000</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    <span class="comment">// @Increment: 50</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;    <span class="comment">// @User: Standard</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;SPEED&quot;</span>,       0, <a class="code" href="classAC__WPNav.html">AC_WPNav</a>, _wp_speed_cms, <a class="code" href="AC__WPNav_8h.html#afd0c5b0592bf3eaffe783f3323d5fa8a">WPNAV_WP_SPEED</a>),</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    <span class="comment">// @Param: RADIUS</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    <span class="comment">// @DisplayName: Waypoint Radius</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    <span class="comment">// @Description: Defines the distance from a waypoint, that when crossed indicates the wp has been hit.</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    <span class="comment">// @Units: cm</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    <span class="comment">// @Range: 100 1000</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    <span class="comment">// @Increment: 1</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    <span class="comment">// @User: Standard</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;RADIUS&quot;</span>,      1, <a class="code" href="classAC__WPNav.html">AC_WPNav</a>, _wp_radius_cm, <a class="code" href="AC__WPNav_8h.html#a299b77621fbad732495365c3d7ba70c2">WPNAV_WP_RADIUS</a>),</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;    <span class="comment">// @Param: SPEED_UP</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    <span class="comment">// @DisplayName: Waypoint Climb Speed Target</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    <span class="comment">// @Description: Defines the speed in cm/s which the aircraft will attempt to maintain while climbing during a WP mission</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <span class="comment">// @Units: cm/s</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    <span class="comment">// @Range: 10 1000</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    <span class="comment">// @Increment: 50</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    <span class="comment">// @User: Standard</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;SPEED_UP&quot;</span>,    2, <a class="code" href="classAC__WPNav.html">AC_WPNav</a>, _wp_speed_up_cms, <a class="code" href="AC__WPNav_8h.html#ab7e7ba5b4c350908eb8e2f50674f81b7">WPNAV_WP_SPEED_UP</a>),</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    <span class="comment">// @Param: SPEED_DN</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    <span class="comment">// @DisplayName: Waypoint Descent Speed Target</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <span class="comment">// @Description: Defines the speed in cm/s which the aircraft will attempt to maintain while descending during a WP mission</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <span class="comment">// @Units: cm/s</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <span class="comment">// @Range: 10 500</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="comment">// @Increment: 10</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <span class="comment">// @User: Standard</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;SPEED_DN&quot;</span>,    3, <a class="code" href="classAC__WPNav.html">AC_WPNav</a>, _wp_speed_down_cms, <a class="code" href="AC__WPNav_8h.html#a3f11d50939feb2deddb76540c377632e">WPNAV_WP_SPEED_DOWN</a>),</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="comment">// @Param: LOIT_SPEED</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="comment">// @DisplayName: Loiter Horizontal Maximum Speed</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="comment">// @Description: Defines the maximum speed in cm/s which the aircraft will travel horizontally while in loiter mode</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="comment">// @Units: cm/s</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="comment">// @Range: 20 2000</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="comment">// @Increment: 50</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <span class="comment">// @User: Standard</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;LOIT_SPEED&quot;</span>,  4, <a class="code" href="classAC__WPNav.html">AC_WPNav</a>, _loiter_speed_cms, <a class="code" href="AC__WPNav_8h.html#a4e866b737efa684995b6f4f1fa2cb8d5">WPNAV_LOITER_SPEED</a>),</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="comment">// @Param: ACCEL</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="comment">// @DisplayName: Waypoint Acceleration </span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="comment">// @Description: Defines the horizontal acceleration in cm/s/s used during missions</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <span class="comment">// @Units: cm/s/s</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="comment">// @Range: 50 500</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="comment">// @Increment: 10</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="comment">// @User: Standard</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;ACCEL&quot;</span>,       5, <a class="code" href="classAC__WPNav.html">AC_WPNav</a>, _wp_accel_cms, <a class="code" href="AC__WPNav_8h.html#a0a35073f3a0ea9c0873a2d4327a8619f">WPNAV_ACCELERATION</a>),</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="comment">// @Param: ACCEL_Z</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">// @DisplayName: Waypoint Vertical Acceleration</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="comment">// @Description: Defines the vertical acceleration in cm/s/s used during missions</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <span class="comment">// @Units: cm/s/s</span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="comment">// @Range: 50 500</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="comment">// @Increment: 10</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="comment">// @User: Standard</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;ACCEL_Z&quot;</span>,     6, <a class="code" href="classAC__WPNav.html">AC_WPNav</a>, _wp_accel_z_cms, <a class="code" href="AC__WPNav_8h.html#ab26b1996242bdebba7fee78f241f52c3">WPNAV_WP_ACCEL_Z_DEFAULT</a>),</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="comment">// @Param: LOIT_JERK</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="comment">// @DisplayName: Loiter maximum jerk</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="comment">// @Description: Loiter maximum jerk in cm/s/s/s</span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="comment">// @Units: cm/s/s/s</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="comment">// @Range: 500 5000</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="comment">// @Increment: 1</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="comment">// @User: Advanced</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;LOIT_JERK&quot;</span>,   7, <a class="code" href="classAC__WPNav.html">AC_WPNav</a>, _loiter_jerk_max_cmsss, <a class="code" href="AC__WPNav_8h.html#afaee23265da0f07dc72f1c225bffbef9">WPNAV_LOITER_JERK_MAX_DEFAULT</a>),</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="comment">// @Param: LOIT_MAXA</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="comment">// @DisplayName: Loiter maximum acceleration</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="comment">// @Description: Loiter maximum acceleration in cm/s/s.  Higher values cause the copter to accelerate and stop more quickly.</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="comment">// @Units: cm/s/s</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <span class="comment">// @Range: 100 981</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="comment">// @Increment: 1</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="comment">// @User: Advanced</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;LOIT_MAXA&quot;</span>,   8, <a class="code" href="classAC__WPNav.html">AC_WPNav</a>, _loiter_accel_cmss, <a class="code" href="AC__WPNav_8h.html#a9bbb7bad46d20edbe3fa0e06c9b2d14e">WPNAV_LOITER_ACCEL</a>),</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="comment">// @Param: LOIT_MINA</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="comment">// @DisplayName: Loiter minimum acceleration</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="comment">// @Description: Loiter minimum acceleration in cm/s/s. Higher values stop the copter more quickly when the stick is centered, but cause a larger jerk when the copter stops.</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="comment">// @Units: cm/s/s</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <span class="comment">// @Range: 25 250</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="comment">// @Increment: 1</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <span class="comment">// @User: Advanced</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;LOIT_MINA&quot;</span>,   9, <a class="code" href="classAC__WPNav.html">AC_WPNav</a>, _loiter_accel_min_cmss, <a class="code" href="AC__WPNav_8h.html#a64569eb424dab8704616603a54f01ca4">WPNAV_LOITER_ACCEL_MIN</a>),</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="comment">// @Param: RFND_USE</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="comment">// @DisplayName: Use rangefinder for terrain following</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <span class="comment">// @Description: This controls the use of a rangefinder for terrain following</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="comment">// @Values: 0:Disable,1:Enable</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="comment">// @User: Advanced</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;RFND_USE&quot;</span>,   10, <a class="code" href="classAC__WPNav.html">AC_WPNav</a>, _rangefinder_use, 1),</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    </div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <a class="code" href="AP__Param_8h.html#a0f9acb038a5283b964b862aea8cc5051">AP_GROUPEND</a></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;};</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">// Default constructor.</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment">// Note that the Vector/Matrix constructors already implicitly zero</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">// their values.</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00113"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#acaa26f2ac17e44be2ddac9d0d04bb542">  113</a></span>&#160;<a class="code" href="classAC__WPNav.html#acaa26f2ac17e44be2ddac9d0d04bb542">AC_WPNav::AC_WPNav</a>(<span class="keyword">const</span> <a class="code" href="classAP__InertialNav.html">AP_InertialNav</a>&amp; inav, <span class="keyword">const</span> <a class="code" href="classAP__AHRS__View.html">AP_AHRS_View</a>&amp; <a class="code" href="ModuleTest_8cpp.html#a0a15280249072432f8c559cc00d09dee">ahrs</a>, <a class="code" href="classAC__PosControl.html">AC_PosControl</a>&amp; pos_control, <span class="keyword">const</span> <a class="code" href="classAC__AttitudeControl.html">AC_AttitudeControl</a>&amp; attitude_control) :</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    _inav(inav),</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    _ahrs(ahrs),</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    _pos_control(pos_control),</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    _attitude_control(attitude_control),</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    _pilot_accel_fwd_cms(0),</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    _pilot_accel_rgt_cms(0),</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    _wp_last_update(0),</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    _wp_step(0),</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    _track_length(0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    _track_desired(0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    _limited_speed_xy_cms(0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    _track_accel(0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    _track_speed(0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    _track_leash_length(0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    _slow_down_dist(0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    _spline_time(0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    _spline_time_scale(0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    _spline_vel_scaler(0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    _yaw(0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>)</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;{</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <a class="code" href="classAP__Param.html#a5f6dcfce1c0a79cf5bd81283e22f3201">AP_Param::setup_object_defaults</a>(<span class="keyword">this</span>, <a class="code" href="classAC__WPNav.html#a2016e7949dc1d451bdfd72285ea38cec">var_info</a>);</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <span class="comment">// init flags</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#af5ad1453ba2999e97f239a1ee99d1ec1">reached_destination</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ad8a49f0a80a119c6cdf901807227251b">fast_waypoint</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ab897171ec9375958f7305e81feedf201">slowing_down</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#a093c5f28780c35169320486da9b13a43">recalc_wp_leash</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#a212e8bdfd1e8dfb5585f8616d37416c8">new_wp_destination</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#afe76f469a51fa8525915518f9ca7f42b">segment_type</a> = <a class="code" href="classAC__WPNav.html#a40589bfae2c593c46a05e53601954311a6aef631564494d1c7bc74592e39d2ad7">SEGMENT_STRAIGHT</a>;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="comment">// sanity check loiter speed</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <a class="code" href="classAC__WPNav.html#a1e63036613974da2e10198975df8af01">_loiter_speed_cms</a> = <a class="code" href="AP__Math_8h.html#a5c0b5c82749ac54970b2699d3c10ee9b">MAX</a>(<a class="code" href="classAC__WPNav.html#a1e63036613974da2e10198975df8af01">_loiter_speed_cms</a>, <a class="code" href="AC__WPNav_8h.html#a27f238a17bad0c20692630a6173e888f">WPNAV_LOITER_SPEED_MIN</a>);</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;}</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div><div class="line"><a name="l00153"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a3bd3abac616805d338d31255d76e978e">  153</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#aeff9bc9c5ec596b91408145d615b236f">AC_WPNav::init_loiter_target</a>(<span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; position, <span class="keywordtype">bool</span> reset_I)</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;{</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="comment">// initialise position controller</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ae1676c283b03793693b7c94cecdcd0b2">init_xy_controller</a>(reset_I);</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <span class="comment">// initialise pos controller speed, acceleration and jerk</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aeb636a56d87a2495d86e394ff6ac7549">set_speed_xy</a>(<a class="code" href="classAC__WPNav.html#a1e63036613974da2e10198975df8af01">_loiter_speed_cms</a>);</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a5e47fd89f68af7f00d9bd59cfcb422a8">set_accel_xy</a>(<a class="code" href="classAC__WPNav.html#a00c096173bddaaf24655ef9f43e9eae9">_loiter_accel_cmss</a>);</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#adfe1243326de1130e9a5a7d031c00ebb">set_jerk_xy</a>(<a class="code" href="classAC__WPNav.html#a9f10e2f0ea7959fe4f8206cef358e049">_loiter_jerk_max_cmsss</a>);</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="comment">// set target position</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a1acdd0aec3b36ec2fad0b05cbca0c252">set_xy_target</a>(position.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>, position.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>);</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="comment">// initialise feed forward velocity to zero</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a86db328ce60f79e07a417e55bb5deb5f">set_desired_velocity_xy</a>(0,0);</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="comment">// initialise desired accel and add fake wind</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <a class="code" href="classAC__WPNav.html#a72ad66f06a4ace213b5f53898e9ee2fb">_loiter_desired_accel</a>.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a> = 0;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <a class="code" href="classAC__WPNav.html#a72ad66f06a4ace213b5f53898e9ee2fb">_loiter_desired_accel</a>.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a> = 0;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="comment">// initialise pilot input</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <a class="code" href="classAC__WPNav.html#adfbcedde5162905fbfe40f4f395ee6cc">_pilot_accel_fwd_cms</a> = 0;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <a class="code" href="classAC__WPNav.html#a06f91bbbcdecb2132214a8d6de0dd5d8">_pilot_accel_rgt_cms</a> = 0;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;}</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div><div class="line"><a name="l00179"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#aeff9bc9c5ec596b91408145d615b236f">  179</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#aeff9bc9c5ec596b91408145d615b236f">AC_WPNav::init_loiter_target</a>()</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;{</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; curr_pos = <a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#a39348dd51a8c32fe16d01dfef284e31a">get_position</a>();</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; curr_vel = <a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#a5bfad40c8a4e0ca98aa09c80e17c4ff5">get_velocity</a>();</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="comment">// initialise position controller</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ae1676c283b03793693b7c94cecdcd0b2">init_xy_controller</a>();</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="comment">// sanity check loiter speed</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <a class="code" href="classAC__WPNav.html#a1e63036613974da2e10198975df8af01">_loiter_speed_cms</a> = <a class="code" href="AP__Math_8h.html#a5c0b5c82749ac54970b2699d3c10ee9b">MAX</a>(<a class="code" href="classAC__WPNav.html#a1e63036613974da2e10198975df8af01">_loiter_speed_cms</a>, <a class="code" href="AC__WPNav_8h.html#a27f238a17bad0c20692630a6173e888f">WPNAV_LOITER_SPEED_MIN</a>);</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="comment">// initialise pos controller speed and acceleration</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aeb636a56d87a2495d86e394ff6ac7549">set_speed_xy</a>(<a class="code" href="classAC__WPNav.html#a1e63036613974da2e10198975df8af01">_loiter_speed_cms</a>);</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a5e47fd89f68af7f00d9bd59cfcb422a8">set_accel_xy</a>(<a class="code" href="classAC__WPNav.html#a00c096173bddaaf24655ef9f43e9eae9">_loiter_accel_cmss</a>);</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#adfe1243326de1130e9a5a7d031c00ebb">set_jerk_xy</a>(<a class="code" href="classAC__WPNav.html#a9f10e2f0ea7959fe4f8206cef358e049">_loiter_jerk_max_cmsss</a>);</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="comment">// set target position</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a1acdd0aec3b36ec2fad0b05cbca0c252">set_xy_target</a>(curr_pos.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>, curr_pos.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>);</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="comment">// move current vehicle velocity into feed forward velocity</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a86db328ce60f79e07a417e55bb5deb5f">set_desired_velocity_xy</a>(curr_vel.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>, curr_vel.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>);</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="comment">// initialise desired accel and add fake wind</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <a class="code" href="classAC__WPNav.html#a72ad66f06a4ace213b5f53898e9ee2fb">_loiter_desired_accel</a>.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a> = (<a class="code" href="classAC__WPNav.html#a00c096173bddaaf24655ef9f43e9eae9">_loiter_accel_cmss</a>)*curr_vel.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>/<a class="code" href="classAC__WPNav.html#a1e63036613974da2e10198975df8af01">_loiter_speed_cms</a>;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <a class="code" href="classAC__WPNav.html#a72ad66f06a4ace213b5f53898e9ee2fb">_loiter_desired_accel</a>.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a> = (<a class="code" href="classAC__WPNav.html#a00c096173bddaaf24655ef9f43e9eae9">_loiter_accel_cmss</a>)*curr_vel.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>/<a class="code" href="classAC__WPNav.html#a1e63036613974da2e10198975df8af01">_loiter_speed_cms</a>;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <span class="comment">// initialise pilot input</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <a class="code" href="classAC__WPNav.html#adfbcedde5162905fbfe40f4f395ee6cc">_pilot_accel_fwd_cms</a> = 0;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <a class="code" href="classAC__WPNav.html#a06f91bbbcdecb2132214a8d6de0dd5d8">_pilot_accel_rgt_cms</a> = 0;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;}</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;</div><div class="line"><a name="l00211"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a9b3fd8fd5c74d31ebffa89cdf98f570a">  211</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a9b3fd8fd5c74d31ebffa89cdf98f570a">AC_WPNav::loiter_soften_for_landing</a>()</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;{</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; curr_pos = <a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#a39348dd51a8c32fe16d01dfef284e31a">get_position</a>();</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="comment">// set target position to current position</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a1acdd0aec3b36ec2fad0b05cbca0c252">set_xy_target</a>(curr_pos.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>, curr_pos.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>);</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ac150947d527995a72dff6ad0921a1891">freeze_ff_xy</a>();</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;}</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;</div><div class="line"><a name="l00221"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a8821ae5e4e14b610f8c24f4d0bdc64d6">  221</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a8821ae5e4e14b610f8c24f4d0bdc64d6">AC_WPNav::set_pilot_desired_acceleration</a>(<span class="keywordtype">float</span> control_roll, <span class="keywordtype">float</span> control_pitch)</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;{</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="comment">// convert pilot input to desired acceleration in cm/s/s</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <a class="code" href="classAC__WPNav.html#adfbcedde5162905fbfe40f4f395ee6cc">_pilot_accel_fwd_cms</a> = -control_pitch * <a class="code" href="classAC__WPNav.html#a00c096173bddaaf24655ef9f43e9eae9">_loiter_accel_cmss</a> / 4500.0f;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <a class="code" href="classAC__WPNav.html#a06f91bbbcdecb2132214a8d6de0dd5d8">_pilot_accel_rgt_cms</a> = control_roll * <a class="code" href="classAC__WPNav.html#a00c096173bddaaf24655ef9f43e9eae9">_loiter_accel_cmss</a> / 4500.0f;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;}</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div><div class="line"><a name="l00229"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a2b0f45cd553e217e5ee44dfef68a674c">  229</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a2b0f45cd553e217e5ee44dfef68a674c">AC_WPNav::get_loiter_stopping_point_xy</a>(<a class="code" href="classVector3.html">Vector3f</a>&amp; stopping_point)<span class="keyword"> const</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a4054e2d2dc53b9b0c2fd26898781af89">get_stopping_point_xy</a>(stopping_point);</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;}</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div><div class="line"><a name="l00236"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a3dbf7bda89b127cdc81bca29e2af25de">  236</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a3dbf7bda89b127cdc81bca29e2af25de">AC_WPNav::calc_loiter_desired_velocity</a>(<span class="keywordtype">float</span> nav_dt, <span class="keywordtype">float</span> ekfGndSpdLimit)</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;{</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="comment">// calculate a loiter speed limit which is the minimum of the value set by the WPNAV_LOITER_SPEED</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="comment">// parameter and the value set by the EKF to observe optical flow limits</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="keywordtype">float</span> gnd_speed_limit_cms = <a class="code" href="AP__Math_8h.html#a6b187a3fa1e9f663e89175e7e8e213d6">MIN</a>(<a class="code" href="classAC__WPNav.html#a1e63036613974da2e10198975df8af01">_loiter_speed_cms</a>,ekfGndSpdLimit*100.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>);</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    gnd_speed_limit_cms = <a class="code" href="AP__Math_8h.html#a5c0b5c82749ac54970b2699d3c10ee9b">MAX</a>(gnd_speed_limit_cms, <a class="code" href="AC__WPNav_8h.html#a27f238a17bad0c20692630a6173e888f">WPNAV_LOITER_SPEED_MIN</a>);</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <span class="comment">// range check nav_dt</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <span class="keywordflow">if</span>( nav_dt &lt; 0 ) {</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    }</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aeb636a56d87a2495d86e394ff6ac7549">set_speed_xy</a>(gnd_speed_limit_cms);</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a5e47fd89f68af7f00d9bd59cfcb422a8">set_accel_xy</a>(<a class="code" href="classAC__WPNav.html#a00c096173bddaaf24655ef9f43e9eae9">_loiter_accel_cmss</a>);</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#adfe1243326de1130e9a5a7d031c00ebb">set_jerk_xy</a>(<a class="code" href="classAC__WPNav.html#a9f10e2f0ea7959fe4f8206cef358e049">_loiter_jerk_max_cmsss</a>);</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="comment">// rotate pilot input to lat/lon frame</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <a class="code" href="structVector2.html">Vector2f</a> desired_accel;</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    desired_accel.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a> = (<a class="code" href="classAC__WPNav.html#adfbcedde5162905fbfe40f4f395ee6cc">_pilot_accel_fwd_cms</a>*<a class="code" href="classAC__WPNav.html#ada2525084222dd59a209b2d1870dbdd3">_ahrs</a>.<a class="code" href="classAP__AHRS__View.html#a3f98bb641a87a41f52f532747ca7c9b5">cos_yaw</a>() - <a class="code" href="classAC__WPNav.html#a06f91bbbcdecb2132214a8d6de0dd5d8">_pilot_accel_rgt_cms</a>*<a class="code" href="classAC__WPNav.html#ada2525084222dd59a209b2d1870dbdd3">_ahrs</a>.<a class="code" href="classAP__AHRS__View.html#a5cba0e970b7df616645025113e75ee41">sin_yaw</a>());</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    desired_accel.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a> = (<a class="code" href="classAC__WPNav.html#adfbcedde5162905fbfe40f4f395ee6cc">_pilot_accel_fwd_cms</a>*<a class="code" href="classAC__WPNav.html#ada2525084222dd59a209b2d1870dbdd3">_ahrs</a>.<a class="code" href="classAP__AHRS__View.html#a5cba0e970b7df616645025113e75ee41">sin_yaw</a>() + <a class="code" href="classAC__WPNav.html#a06f91bbbcdecb2132214a8d6de0dd5d8">_pilot_accel_rgt_cms</a>*<a class="code" href="classAC__WPNav.html#ada2525084222dd59a209b2d1870dbdd3">_ahrs</a>.<a class="code" href="classAP__AHRS__View.html#a3f98bb641a87a41f52f532747ca7c9b5">cos_yaw</a>());</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="comment">// calculate the difference</span></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <a class="code" href="structVector2.html">Vector2f</a> des_accel_diff = (desired_accel - <a class="code" href="classAC__WPNav.html#a72ad66f06a4ace213b5f53898e9ee2fb">_loiter_desired_accel</a>);</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="comment">// constrain and scale the desired acceleration</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    <span class="keywordtype">float</span> des_accel_change_total = <a class="code" href="AP__Math_8h.html#a2c34476e01b9988589e9be01e6c8b5f0">norm</a>(des_accel_diff.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a>, des_accel_diff.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a>);</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keywordtype">float</span> accel_change_max = <a class="code" href="classAC__WPNav.html#a9f10e2f0ea7959fe4f8206cef358e049">_loiter_jerk_max_cmsss</a> * nav_dt;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    </div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a9f10e2f0ea7959fe4f8206cef358e049">_loiter_jerk_max_cmsss</a> &gt; 0.0f &amp;&amp; des_accel_change_total &gt; accel_change_max &amp;&amp; des_accel_change_total &gt; 0.0f) {</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        des_accel_diff.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a> = accel_change_max * des_accel_diff.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a>/des_accel_change_total;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        des_accel_diff.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a> = accel_change_max * des_accel_diff.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a>/des_accel_change_total;</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    }</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    </div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <span class="comment">// adjust the desired acceleration</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <a class="code" href="classAC__WPNav.html#a72ad66f06a4ace213b5f53898e9ee2fb">_loiter_desired_accel</a> += des_accel_diff;</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="comment">// get pos_control&#39;s feed forward velocity</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a> &amp;desired_vel_3d = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a3d9cd8d29a9ce76bb5b6d757aac7626f">get_desired_velocity</a>();</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <a class="code" href="structVector2.html">Vector2f</a> desired_vel(desired_vel_3d.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>,desired_vel_3d.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>);</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="comment">// add pilot commanded acceleration</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    desired_vel.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a> += <a class="code" href="classAC__WPNav.html#a72ad66f06a4ace213b5f53898e9ee2fb">_loiter_desired_accel</a>.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a> * nav_dt;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    desired_vel.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a> += <a class="code" href="classAC__WPNav.html#a72ad66f06a4ace213b5f53898e9ee2fb">_loiter_desired_accel</a>.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a> * nav_dt;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="keywordtype">float</span> desired_speed = desired_vel.<a class="code" href="structVector2.html#ad8ebafde96f43521d3647e2552387529">length</a>();</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(desired_speed)) {</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        <a class="code" href="structVector2.html">Vector2f</a> desired_vel_norm = desired_vel/desired_speed;</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="keywordtype">float</span> drag_speed_delta = -<a class="code" href="classAC__WPNav.html#a00c096173bddaaf24655ef9f43e9eae9">_loiter_accel_cmss</a>*nav_dt*desired_speed/gnd_speed_limit_cms;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#adfbcedde5162905fbfe40f4f395ee6cc">_pilot_accel_fwd_cms</a> == 0 &amp;&amp; <a class="code" href="classAC__WPNav.html#a06f91bbbcdecb2132214a8d6de0dd5d8">_pilot_accel_rgt_cms</a> == 0) {</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;            drag_speed_delta = <a class="code" href="AP__Math_8h.html#a6b187a3fa1e9f663e89175e7e8e213d6">MIN</a>(drag_speed_delta,<a class="code" href="AP__Math_8h.html#a5c0b5c82749ac54970b2699d3c10ee9b">MAX</a>(-<a class="code" href="classAC__WPNav.html#a472f9c88311c7c7b04fdfa4446663fad">_loiter_accel_min_cmss</a>*nav_dt, -2.0f*desired_speed*nav_dt));</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        }</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        desired_speed = <a class="code" href="AP__Math_8h.html#a5c0b5c82749ac54970b2699d3c10ee9b">MAX</a>(desired_speed+drag_speed_delta,0.0f);</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        desired_vel = desired_vel_norm*desired_speed;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    }</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="comment">// Apply EKF limit to desired velocity -  this limit is calculated by the EKF and adjusted as required to ensure certain sensor limits are respected (eg optical flow sensing)</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    <span class="keywordtype">float</span> horizSpdDem = sqrtf(<a class="code" href="AP__Math_8h.html#a0375e3d67fd3911cacee5c3e1408c0f2">sq</a>(desired_vel.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a>) + <a class="code" href="AP__Math_8h.html#a0375e3d67fd3911cacee5c3e1408c0f2">sq</a>(desired_vel.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a>));</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <span class="keywordflow">if</span> (horizSpdDem &gt; gnd_speed_limit_cms) {</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        desired_vel.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a> = desired_vel.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a> * gnd_speed_limit_cms / horizSpdDem;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        desired_vel.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a> = desired_vel.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a> * gnd_speed_limit_cms / horizSpdDem;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    }</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    <span class="comment">// Limit the velocity to prevent fence violations</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a3af4062bf565318b87f922ff2ae613d0">_avoid</a> != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        <a class="code" href="classAC__WPNav.html#a3af4062bf565318b87f922ff2ae613d0">_avoid</a>-&gt;<a class="code" href="classAC__Avoid.html#abee541d127ce0da1fe6be54f987a0779">adjust_velocity</a>(<a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a96d87c601aa6866bd9a743d024a08c51">get_pos_xy_kP</a>(), <a class="code" href="classAC__WPNav.html#a00c096173bddaaf24655ef9f43e9eae9">_loiter_accel_cmss</a>, desired_vel);</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    }</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="comment">// send adjusted feed forward velocity back to position controller</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a86db328ce60f79e07a417e55bb5deb5f">set_desired_velocity_xy</a>(desired_vel.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a>,desired_vel.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a>);</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;}</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00311"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a7f711c7661c335417cbcc28f9546688c">  311</a></span>&#160;int32_t <a class="code" href="classAC__WPNav.html#a7f711c7661c335417cbcc28f9546688c">AC_WPNav::get_loiter_bearing_to_target</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classAC__WPNav.html#acdde881fbaae3bc13155a34ee88a6e48">get_bearing_cd</a>(<a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#a39348dd51a8c32fe16d01dfef284e31a">get_position</a>(), <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a6b3617b946ffd6935c11a63629f186ec">get_pos_target</a>());</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;}</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">// update_loiter - run the loiter controller - gets called at 100hz (APM) or 400hz (PX4)</span></div><div class="line"><a name="l00317"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a0a434270245fd8641352af387700dc82">  317</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a0a434270245fd8641352af387700dc82">AC_WPNav::update_loiter</a>(<span class="keywordtype">float</span> ekfGndSpdLimit, <span class="keywordtype">float</span> ekfNavVelGainScaler)</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;{</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="comment">// calculate dt</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="keywordtype">float</span> dt = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aba69e5af4db360bb85275fe843f7e95e">time_since_last_xy_update</a>();</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="comment">// run at poscontrol update rate.</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="comment">// TODO: run on user input to reduce latency, maybe if (user_input || dt &gt;= _pos_control.get_dt_xy())</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="keywordflow">if</span> (dt &gt;= <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ab4a37d0f0ce8ea8038758158f8d06562">get_dt_xy</a>()) {</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="comment">// sanity check dt</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keywordflow">if</span> (dt &gt;= 0.2<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            dt = 0.0f;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        }</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        <span class="comment">// initialise pos controller speed and acceleration</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aeb636a56d87a2495d86e394ff6ac7549">set_speed_xy</a>(<a class="code" href="classAC__WPNav.html#a1e63036613974da2e10198975df8af01">_loiter_speed_cms</a>);</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a5e47fd89f68af7f00d9bd59cfcb422a8">set_accel_xy</a>(<a class="code" href="classAC__WPNav.html#a00c096173bddaaf24655ef9f43e9eae9">_loiter_accel_cmss</a>);</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#adfe1243326de1130e9a5a7d031c00ebb">set_jerk_xy</a>(<a class="code" href="classAC__WPNav.html#a9f10e2f0ea7959fe4f8206cef358e049">_loiter_jerk_max_cmsss</a>);</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        <a class="code" href="classAC__WPNav.html#a3dbf7bda89b127cdc81bca29e2af25de">calc_loiter_desired_velocity</a>(dt,ekfGndSpdLimit);</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a497c1799c10d146b6f2e2b542889c083">update_xy_controller</a>(<a class="code" href="classAC__PosControl.html#a773f0830b9aa2c591f5fb2dd6287997cae87925feecc2a1b521da706d92404e2b">AC_PosControl::XY_MODE_POS_LIMITED_AND_VEL_FF</a>, ekfNavVelGainScaler, <span class="keyword">true</span>);</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    }</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;}</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;</div><div class="line"><a name="l00341"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a2ed86e41fc51c2ea822711ea95d055f0">  341</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a2ed86e41fc51c2ea822711ea95d055f0">AC_WPNav::init_brake_target</a>(<span class="keywordtype">float</span> accel_cmss)</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;{</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; curr_vel = <a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#a5bfad40c8a4e0ca98aa09c80e17c4ff5">get_velocity</a>();</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> stopping_point;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <span class="comment">// initialise position controller</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ae1676c283b03793693b7c94cecdcd0b2">init_xy_controller</a>();</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="comment">// initialise pos controller speed and acceleration</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aeb636a56d87a2495d86e394ff6ac7549">set_speed_xy</a>(curr_vel.<a class="code" href="classVector3.html#ac1fd5514e368a1e1c2d13f71eda18345">length</a>());</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a5e47fd89f68af7f00d9bd59cfcb422a8">set_accel_xy</a>(accel_cmss);</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#adfe1243326de1130e9a5a7d031c00ebb">set_jerk_xy</a>(<a class="code" href="classAC__WPNav.html#a9f10e2f0ea7959fe4f8206cef358e049">_loiter_jerk_max_cmsss</a>);</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ac4f923c39399266568b9ae9419a0596f">calc_leash_length_xy</a>();</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a4054e2d2dc53b9b0c2fd26898781af89">get_stopping_point_xy</a>(stopping_point);</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <span class="comment">// set target position</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <a class="code" href="classAC__WPNav.html#aeff9bc9c5ec596b91408145d615b236f">init_loiter_target</a>(stopping_point);</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;}</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment">// update_brake - run the stop controller - gets called at 400hz</span></div><div class="line"><a name="l00362"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#af9d3f98ad44166d4c5d072bf3ba4a3db">  362</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#af9d3f98ad44166d4c5d072bf3ba4a3db">AC_WPNav::update_brake</a>(<span class="keywordtype">float</span> ekfGndSpdLimit, <span class="keywordtype">float</span> ekfNavVelGainScaler)</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;{</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    <span class="comment">// calculate dt</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="keywordtype">float</span> dt = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aba69e5af4db360bb85275fe843f7e95e">time_since_last_xy_update</a>();</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="comment">// run at poscontrol update rate.</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keywordflow">if</span> (dt &gt;= <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ab4a37d0f0ce8ea8038758158f8d06562">get_dt_xy</a>()) {</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <span class="comment">// send adjusted feed forward velocity back to position controller</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a86db328ce60f79e07a417e55bb5deb5f">set_desired_velocity_xy</a>(0,0);</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a497c1799c10d146b6f2e2b542889c083">update_xy_controller</a>(<a class="code" href="classAC__PosControl.html#a773f0830b9aa2c591f5fb2dd6287997cae87925feecc2a1b521da706d92404e2b">AC_PosControl::XY_MODE_POS_LIMITED_AND_VEL_FF</a>, ekfNavVelGainScaler, <span class="keyword">false</span>);</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    }</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;}</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;</div><div class="line"><a name="l00383"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a47964df8ebcc78bb101f328a23187e65">  383</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a47964df8ebcc78bb101f328a23187e65">AC_WPNav::wp_and_spline_init</a>()</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;{</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="comment">// check _wp_accel_cms is reasonable</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a> &lt;= 0) {</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        <a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a>.set_and_save(<a class="code" href="AC__WPNav_8h.html#a0a35073f3a0ea9c0873a2d4327a8619f">WPNAV_ACCELERATION</a>);</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    }</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="comment">// also limit the accel using the maximum lean angle. This</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <span class="comment">// prevents the navigation controller from trying to move the</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    <span class="comment">// target point at an unachievable rate</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="keywordtype">float</span> accel_limit_cms = <a class="code" href="dsp__functions_8cpp.html#a09aece9652e49e731cfcf26eb28ba268">GRAVITY_MSS</a> * 100 * tanf(<a class="code" href="AP__Math_8h.html#a75b14352ec1c95a8276af9a0813cfdc3">radians</a>(<a class="code" href="classAC__WPNav.html#a17bf8df6a841f35e17641984fa46bab0">_attitude_control</a>.<a class="code" href="classAC__AttitudeControl.html#a080c9527e2d43eac62e370fbe61eaa8d">lean_angle_max</a>()*0.01f));</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a> &gt; accel_limit_cms) {</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a>.set(accel_limit_cms);</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    }</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <span class="comment">// initialise position controller</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ae1676c283b03793693b7c94cecdcd0b2">init_xy_controller</a>();</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    <span class="comment">// initialise position controller speed and acceleration</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aeb636a56d87a2495d86e394ff6ac7549">set_speed_xy</a>(<a class="code" href="classAC__WPNav.html#a6341785a5caab8c9addb607d93fb0299">_wp_speed_cms</a>);</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a5e47fd89f68af7f00d9bd59cfcb422a8">set_accel_xy</a>(<a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a>);</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a44ce19c29764128d832fa3c1bc871be4">set_jerk_xy_to_default</a>();</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a4d39e0c0d33f5f6ca20461ad64982e8f">set_speed_z</a>(-<a class="code" href="classAC__WPNav.html#ad63cee44ffeaaf4e18f42571a34093b8">_wp_speed_down_cms</a>, <a class="code" href="classAC__WPNav.html#a9a04a9cd8aeca3ddaf980dcdec86943b">_wp_speed_up_cms</a>);</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ad7ef264f7da50fe3f0e035604fdcfea4">set_accel_z</a>(<a class="code" href="classAC__WPNav.html#a4b59ba145a08beb8fe568c997908e34d">_wp_accel_z_cms</a>);</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ac4f923c39399266568b9ae9419a0596f">calc_leash_length_xy</a>();</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#acac2980eb3698791d55ca8fa260ab5af">calc_leash_length_z</a>();</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;}</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div><div class="line"><a name="l00412"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a0ff7209545f3c7169054b2ee79cd4216">  412</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a0ff7209545f3c7169054b2ee79cd4216">AC_WPNav::set_speed_xy</a>(<span class="keywordtype">float</span> speed_cms)</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;{</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <span class="comment">// range check new target speed and update position controller</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="keywordflow">if</span> (speed_cms &gt;= <a class="code" href="AC__WPNav_8h.html#aafb7b61646d88418a26f138e458ad358">WPNAV_WP_SPEED_MIN</a>) {</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        <a class="code" href="classAC__WPNav.html#a6341785a5caab8c9addb607d93fb0299">_wp_speed_cms</a> = speed_cms;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aeb636a56d87a2495d86e394ff6ac7549">set_speed_xy</a>(<a class="code" href="classAC__WPNav.html#a6341785a5caab8c9addb607d93fb0299">_wp_speed_cms</a>);</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="comment">// flag that wp leash must be recalculated</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#a093c5f28780c35169320486da9b13a43">recalc_wp_leash</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    }</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;}</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div><div class="line"><a name="l00425"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a7e131ba7b7deffa86cbf343c495bdf4e">  425</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAC__WPNav.html#a7e131ba7b7deffa86cbf343c495bdf4e">AC_WPNav::set_wp_destination</a>(<span class="keyword">const</span> <a class="code" href="classLocation__Class.html">Location_Class</a>&amp; destination)</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;{</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    <span class="keywordtype">bool</span> terr_alt;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> dest_neu;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="comment">// convert destination location to vector</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a91b8fa0d48a6fb79a4d7ef38dfc11123">get_vector_NEU</a>(destination, dest_neu, terr_alt)) {</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    }</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <span class="comment">// set target as vector from EKF origin</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classAC__WPNav.html#a7e131ba7b7deffa86cbf343c495bdf4e">set_wp_destination</a>(dest_neu, terr_alt);</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;}</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a38519fcac3a24cf64ec7c37e90fc3e13">  441</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAC__WPNav.html#a7e131ba7b7deffa86cbf343c495bdf4e">AC_WPNav::set_wp_destination</a>(<span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; destination, <span class="keywordtype">bool</span> terrain_alt)</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;{</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> origin;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    <span class="comment">// if waypoint controller is active use the existing position target as the origin</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="namespaceAP__HAL.html#a77dffbb18891996280308e21316ec186">AP_HAL::millis</a>() - <a class="code" href="classAC__WPNav.html#acee5cbca4296027197ee0c892b5dbc38">_wp_last_update</a>) &lt; 1000) {</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        origin = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a6b3617b946ffd6935c11a63629f186ec">get_pos_target</a>();</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        <span class="comment">// if waypoint controller is not active, set origin to reasonable stopping point (using curr pos and velocity)</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a4054e2d2dc53b9b0c2fd26898781af89">get_stopping_point_xy</a>(origin);</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a20ac6348cbb9a1ac803c626c91ec93e5">get_stopping_point_z</a>(origin);</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    }</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    <span class="comment">// convert origin to alt-above-terrain</span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <span class="keywordflow">if</span> (terrain_alt) {</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        <span class="keywordtype">float</span> origin_terr_offset;</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a89a2d6885b96dd09bab36ccda16a6dce">get_terrain_offset</a>(origin_terr_offset)) {</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        }</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;        origin.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> -= origin_terr_offset;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    }</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="comment">// set origin and destination</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classAC__WPNav.html#aa218844a5ba6f88bf67ae4a8f188f962">set_wp_origin_and_destination</a>(origin, destination, terrain_alt);</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;}</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#aa218844a5ba6f88bf67ae4a8f188f962">  470</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAC__WPNav.html#aa218844a5ba6f88bf67ae4a8f188f962">AC_WPNav::set_wp_origin_and_destination</a>(<span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; origin, <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; destination, <span class="keywordtype">bool</span> terrain_alt)</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;{</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="comment">// store origin and destination locations</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <a class="code" href="classAC__WPNav.html#a5d54686767fb1e5c60c8826160e8ac14">_origin</a> = origin;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <a class="code" href="classAC__WPNav.html#ae2eba98522934eaa1968e99ecfa91d93">_destination</a> = destination;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <a class="code" href="classAC__WPNav.html#ad0b9019cec333348644f43112c8b6144">_terrain_alt</a> = terrain_alt;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> pos_delta = <a class="code" href="classAC__WPNav.html#ae2eba98522934eaa1968e99ecfa91d93">_destination</a> - <a class="code" href="classAC__WPNav.html#a5d54686767fb1e5c60c8826160e8ac14">_origin</a>;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <a class="code" href="classAC__WPNav.html#ae16c00c6b3774caf40ae1b3820f95496">_track_length</a> = pos_delta.<a class="code" href="classVector3.html#ac1fd5514e368a1e1c2d13f71eda18345">length</a>(); <span class="comment">// get track length</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="comment">// calculate each axis&#39; percentage of the total distance to the destination</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(<a class="code" href="classAC__WPNav.html#ae16c00c6b3774caf40ae1b3820f95496">_track_length</a>)) {</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        <span class="comment">// avoid possible divide by zero</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> = 0;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;        <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a> = 0;</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> = 0;</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a> = pos_delta/<a class="code" href="classAC__WPNav.html#ae16c00c6b3774caf40ae1b3820f95496">_track_length</a>;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    }</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="comment">// calculate leash lengths</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <a class="code" href="classAC__WPNav.html#a2036d6ad0d72ba04c425a0a68553209b">calculate_wp_leash_length</a>();</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="comment">// initialise yaw heading</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#ae16c00c6b3774caf40ae1b3820f95496">_track_length</a> &gt;= <a class="code" href="AC__WPNav_8h.html#a490177d11b3e775c323cff9462edf5c7">WPNAV_YAW_DIST_MIN</a>) {</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        <a class="code" href="classAC__WPNav.html#ae1e4c1e17634f9e8a672b4ed47b76ad8">_yaw</a> = <a class="code" href="classAC__WPNav.html#acdde881fbaae3bc13155a34ee88a6e48">get_bearing_cd</a>(_origin, <a class="code" href="classAC__WPNav.html#ae2eba98522934eaa1968e99ecfa91d93">_destination</a>);</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        <span class="comment">// set target yaw to current heading target</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        <a class="code" href="classAC__WPNav.html#ae1e4c1e17634f9e8a672b4ed47b76ad8">_yaw</a> = <a class="code" href="classAC__WPNav.html#a17bf8df6a841f35e17641984fa46bab0">_attitude_control</a>.<a class="code" href="classAC__AttitudeControl.html#aec35222c9dee5999aaf029484ea356c9">get_att_target_euler_cd</a>().<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a>;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    }</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="comment">// get origin&#39;s alt-above-terrain</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="keywordtype">float</span> origin_terr_offset = 0.0f;</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="keywordflow">if</span> (terrain_alt) {</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a89a2d6885b96dd09bab36ccda16a6dce">get_terrain_offset</a>(origin_terr_offset)) {</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        }</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    }</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    <span class="comment">// initialise intermediate point to the origin</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ad70a79da0c5dcde97ccf848b03e7356a">set_pos_target</a>(origin + <a class="code" href="vector3_8h.html#af345ad77ba5e240c7ab72b4b2077e754">Vector3f</a>(0,0,origin_terr_offset));</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <a class="code" href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">_track_desired</a> = 0;             <span class="comment">// target is at beginning of track</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#af5ad1453ba2999e97f239a1ee99d1ec1">reached_destination</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ad8a49f0a80a119c6cdf901807227251b">fast_waypoint</a> = <span class="keyword">false</span>;   <span class="comment">// default waypoint back to slow</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ab897171ec9375958f7305e81feedf201">slowing_down</a> = <span class="keyword">false</span>;    <span class="comment">// target is not slowing down yet</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#afe76f469a51fa8525915518f9ca7f42b">segment_type</a> = <a class="code" href="classAC__WPNav.html#a40589bfae2c593c46a05e53601954311a6aef631564494d1c7bc74592e39d2ad7">SEGMENT_STRAIGHT</a>;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#a212e8bdfd1e8dfb5585f8616d37416c8">new_wp_destination</a> = <span class="keyword">true</span>;   <span class="comment">// flag new waypoint so we can freeze the pos controller&#39;s feed forward and smooth the transition</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    <span class="comment">// initialise the limited speed to current speed along the track</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a> &amp;curr_vel = <a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#a5bfad40c8a4e0ca98aa09c80e17c4ff5">get_velocity</a>();</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    <span class="comment">// get speed along track (note: we convert vertical speed into horizontal speed equivalent)</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <span class="keywordtype">float</span> speed_along_track = curr_vel.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> * <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> + curr_vel.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a> * <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a> + curr_vel.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> * <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a>;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a> = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(speed_along_track,0,<a class="code" href="classAC__WPNav.html#a6341785a5caab8c9addb607d93fb0299">_wp_speed_cms</a>);</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;}</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;</div><div class="line"><a name="l00530"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a7ebe48af2381e791cbcdea94c7af2e3e">  530</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a7ebe48af2381e791cbcdea94c7af2e3e">AC_WPNav::shift_wp_origin_to_current_pos</a>()</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;{</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    <span class="comment">// return immediately if vehicle is not at the origin</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">_track_desired</a> &gt; 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    }</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="comment">// get current and target locations</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a> curr_pos = <a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#a39348dd51a8c32fe16d01dfef284e31a">get_position</a>();</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a> pos_target = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a6b3617b946ffd6935c11a63629f186ec">get_pos_target</a>();</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    <span class="comment">// calculate difference between current position and target</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> pos_diff = curr_pos - pos_target;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    <span class="comment">// shift origin and destination</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <a class="code" href="classAC__WPNav.html#a5d54686767fb1e5c60c8826160e8ac14">_origin</a> += pos_diff;</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    <a class="code" href="classAC__WPNav.html#ae2eba98522934eaa1968e99ecfa91d93">_destination</a> += pos_diff;</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    <span class="comment">// move pos controller target and disable feed forward</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ad70a79da0c5dcde97ccf848b03e7356a">set_pos_target</a>(curr_pos);</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ac150947d527995a72dff6ad0921a1891">freeze_ff_xy</a>();</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aa979d20c99f08a96d0f482c1dad50f78">freeze_ff_z</a>();</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;}</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div><div class="line"><a name="l00555"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a180fb06a829a1e4168ceb24ca0c41e1f">  555</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a180fb06a829a1e4168ceb24ca0c41e1f">AC_WPNav::get_wp_stopping_point_xy</a>(<a class="code" href="classVector3.html">Vector3f</a>&amp; stopping_point)<span class="keyword"> const</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a4054e2d2dc53b9b0c2fd26898781af89">get_stopping_point_xy</a>(stopping_point);</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;}</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div><div class="line"><a name="l00561"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a603ec5c1a7654ccd9a227565cdbee275">  561</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAC__WPNav.html#a603ec5c1a7654ccd9a227565cdbee275">AC_WPNav::advance_wp_target_along_track</a>(<span class="keywordtype">float</span> dt)</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;{</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="keywordtype">float</span> track_covered;        <span class="comment">// distance (in cm) along the track that the vehicle has traveled.  Measured by drawing a perpendicular line from the track to the vehicle.</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> track_error;       <span class="comment">// distance error (in cm) from the track_covered position (i.e. closest point on the line to the vehicle) and the vehicle</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    <span class="keywordtype">float</span> track_desired_max;    <span class="comment">// the farthest distance (in cm) along the track that the leash will allow</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    <span class="keywordtype">float</span> track_leash_slack;    <span class="comment">// additional distance (in cm) along the track from our track_covered position that our leash will allow</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    <span class="keywordtype">bool</span> reached_leash_limit = <span class="keyword">false</span>;   <span class="comment">// true when track has reached leash limit and we need to slow down the target point</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <span class="comment">// get current location</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> curr_pos = <a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#a39348dd51a8c32fe16d01dfef284e31a">get_position</a>();</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    <span class="comment">// calculate terrain adjustments</span></div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <span class="keywordtype">float</span> terr_offset = 0.0f;</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#ad0b9019cec333348644f43112c8b6144">_terrain_alt</a> &amp;&amp; !<a class="code" href="classAC__WPNav.html#a89a2d6885b96dd09bab36ccda16a6dce">get_terrain_offset</a>(terr_offset)) {</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    }</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    <span class="comment">// calculate 3d vector from segment&#39;s origin</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> curr_delta = (curr_pos - <a class="code" href="vector3_8h.html#af345ad77ba5e240c7ab72b4b2077e754">Vector3f</a>(0,0,terr_offset)) - <a class="code" href="classAC__WPNav.html#a5d54686767fb1e5c60c8826160e8ac14">_origin</a>;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    <span class="comment">// calculate how far along the track we are</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    track_covered = curr_delta.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> * <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> + curr_delta.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a> * <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a> + curr_delta.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> * <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a>;</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> track_covered_pos = <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a> * track_covered;</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    track_error = curr_delta - track_covered_pos;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <span class="comment">// calculate the horizontal error</span></div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <span class="keywordtype">float</span> track_error_xy = <a class="code" href="AP__Math_8h.html#a2c34476e01b9988589e9be01e6c8b5f0">norm</a>(track_error.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>, track_error.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>);</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    <span class="comment">// calculate the vertical error</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    <span class="keywordtype">float</span> track_error_z = fabsf(track_error.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a>);</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    <span class="comment">// get position control leash lengths</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="keywordtype">float</span> leash_xy = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aa5759b18c7c1208b6979c728fb85f1e4">get_leash_xy</a>();</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    <span class="keywordtype">float</span> leash_z;</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    <span class="keywordflow">if</span> (track_error.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> &gt;= 0) {</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        leash_z = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ab17ea3a4f6f232c9944712b39e76aac8">get_leash_up_z</a>();</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        leash_z = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aeba418c057fc5aa5aa784d809da98f14">get_leash_down_z</a>();</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    }</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="comment">// calculate how far along the track we could move the intermediate target before reaching the end of the leash</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    track_leash_slack = <a class="code" href="AP__Math_8h.html#a6b187a3fa1e9f663e89175e7e8e213d6">MIN</a>(<a class="code" href="classAC__WPNav.html#a3c60c5ddf37a79af9238249a1784dc23">_track_leash_length</a>*(leash_z-track_error_z)/leash_z, <a class="code" href="classAC__WPNav.html#a3c60c5ddf37a79af9238249a1784dc23">_track_leash_length</a>*(leash_xy-track_error_xy)/leash_xy);</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    <span class="keywordflow">if</span> (track_leash_slack &lt; 0) {</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        track_desired_max = track_covered;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        track_desired_max = track_covered + track_leash_slack;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    }</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    <span class="comment">// check if target is already beyond the leash</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">_track_desired</a> &gt; track_desired_max) {</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        reached_leash_limit = <span class="keyword">true</span>;</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    }</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    <span class="comment">// get current velocity</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a> &amp;curr_vel = <a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#a5bfad40c8a4e0ca98aa09c80e17c4ff5">get_velocity</a>();</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <span class="comment">// get speed along track</span></div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    <span class="keywordtype">float</span> speed_along_track = curr_vel.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> * <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> + curr_vel.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a> * <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a> + curr_vel.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> * <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a>;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="comment">// calculate point at which velocity switches from linear to sqrt</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="keywordtype">float</span> linear_velocity = <a class="code" href="classAC__WPNav.html#a6341785a5caab8c9addb607d93fb0299">_wp_speed_cms</a>;</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    <span class="keywordtype">float</span> kP = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a96d87c601aa6866bd9a743d024a08c51">get_pos_xy_kP</a>();</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <span class="keywordflow">if</span> (kP &gt;= 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {   <span class="comment">// avoid divide by zero</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        linear_velocity = <a class="code" href="classAC__WPNav.html#a3a665f936634a13be4e8382b7924039f">_track_accel</a>/kP;</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    }</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="comment">// let the limited_speed_xy_cms be some range above or below current velocity along track</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    <span class="keywordflow">if</span> (speed_along_track &lt; -linear_velocity) {</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        <span class="comment">// we are traveling fast in the opposite direction of travel to the waypoint so do not move the intermediate point</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        <a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a> = 0;</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        <span class="comment">// increase intermediate target point&#39;s velocity if not yet at the leash limit</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <span class="keywordflow">if</span>(dt &gt; 0 &amp;&amp; !reached_leash_limit) {</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            <a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a> += 2.0f * <a class="code" href="classAC__WPNav.html#a3a665f936634a13be4e8382b7924039f">_track_accel</a> * dt;</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        }</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        <span class="comment">// do not allow speed to be below zero or over top speed</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        <a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a> = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(<a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a>, 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>, <a class="code" href="classAC__WPNav.html#a1df2d6792b0b42b8c60bb57b5c1991cf">_track_speed</a>);</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        <span class="comment">// check if we should begin slowing down</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ad8a49f0a80a119c6cdf901807227251b">fast_waypoint</a>) {</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;            <span class="keywordtype">float</span> dist_to_dest = <a class="code" href="classAC__WPNav.html#ae16c00c6b3774caf40ae1b3820f95496">_track_length</a> - <a class="code" href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">_track_desired</a>;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ab897171ec9375958f7305e81feedf201">slowing_down</a> &amp;&amp; dist_to_dest &lt;= <a class="code" href="classAC__WPNav.html#a0c003971d88dadd9b8101fbf60534280">_slow_down_dist</a>) {</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ab897171ec9375958f7305e81feedf201">slowing_down</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;            }</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            <span class="comment">// if target is slowing down, limit the speed</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ab897171ec9375958f7305e81feedf201">slowing_down</a>) {</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                <a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a> = <a class="code" href="AP__Math_8h.html#a6b187a3fa1e9f663e89175e7e8e213d6">MIN</a>(<a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a>, <a class="code" href="classAC__WPNav.html#aae13f4e84af1728e5d382a3f97a181db">get_slow_down_speed</a>(dist_to_dest, <a class="code" href="classAC__WPNav.html#a3a665f936634a13be4e8382b7924039f">_track_accel</a>));</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;            }</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        }</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        <span class="comment">// if our current velocity is within the linear velocity range limit the intermediate point&#39;s velocity to be no more than the linear_velocity above or below our current velocity</span></div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        <span class="keywordflow">if</span> (fabsf(speed_along_track) &lt; linear_velocity) {</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            <a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a> = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(<a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a>,speed_along_track-linear_velocity,speed_along_track+linear_velocity);</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        }</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;    }</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    <span class="comment">// advance the current target</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    <span class="keywordflow">if</span> (!reached_leash_limit) {</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        <a class="code" href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">_track_desired</a> += <a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a> * dt;</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        <span class="comment">// reduce speed if we reach end of leash</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">_track_desired</a> &gt; track_desired_max) {</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;            <a class="code" href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">_track_desired</a> = track_desired_max;</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;            <a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a> -= 2.0f * <a class="code" href="classAC__WPNav.html#a3a665f936634a13be4e8382b7924039f">_track_accel</a> * dt;</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a> &lt; 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                <a class="code" href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">_limited_speed_xy_cms</a> = 0.0f;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;            }</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;        }</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    }</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <span class="comment">// do not let desired point go past the end of the track unless it&#39;s a fast waypoint</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ad8a49f0a80a119c6cdf901807227251b">fast_waypoint</a>) {</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        <a class="code" href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">_track_desired</a> = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(<a class="code" href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">_track_desired</a>, 0, <a class="code" href="classAC__WPNav.html#ae16c00c6b3774caf40ae1b3820f95496">_track_length</a>);</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        <a class="code" href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">_track_desired</a> = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(<a class="code" href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">_track_desired</a>, 0, <a class="code" href="classAC__WPNav.html#ae16c00c6b3774caf40ae1b3820f95496">_track_length</a> + <a class="code" href="AC__WPNav_8h.html#a0ce9619627236f61455e98b7cdfc0d9d">WPNAV_WP_FAST_OVERSHOOT_MAX</a>);</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    }</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    <span class="comment">// recalculate the desired position</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> final_target = <a class="code" href="classAC__WPNav.html#a5d54686767fb1e5c60c8826160e8ac14">_origin</a> + <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a> * <a class="code" href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">_track_desired</a>;</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    <span class="comment">// convert final_target.z to altitude above the ekf origin</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    final_target.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> += terr_offset;</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ad70a79da0c5dcde97ccf848b03e7356a">set_pos_target</a>(final_target);</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <span class="comment">// check if we&#39;ve reached the waypoint</span></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    <span class="keywordflow">if</span>( !<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#af5ad1453ba2999e97f239a1ee99d1ec1">reached_destination</a> ) {</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        <span class="keywordflow">if</span>( _track_desired &gt;= <a class="code" href="classAC__WPNav.html#ae16c00c6b3774caf40ae1b3820f95496">_track_length</a> ) {</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;            <span class="comment">// &quot;fast&quot; waypoints are complete once the intermediate point reaches the destination</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ad8a49f0a80a119c6cdf901807227251b">fast_waypoint</a>) {</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;                <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#af5ad1453ba2999e97f239a1ee99d1ec1">reached_destination</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;                <span class="comment">// regular waypoints also require the copter to be within the waypoint radius</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;                <a class="code" href="classVector3.html">Vector3f</a> dist_to_dest = (curr_pos - <a class="code" href="vector3_8h.html#af345ad77ba5e240c7ab72b4b2077e754">Vector3f</a>(0,0,terr_offset)) - <a class="code" href="classAC__WPNav.html#ae2eba98522934eaa1968e99ecfa91d93">_destination</a>;</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;                <span class="keywordflow">if</span>( dist_to_dest.<a class="code" href="classVector3.html#ac1fd5514e368a1e1c2d13f71eda18345">length</a>() &lt;= <a class="code" href="classAC__WPNav.html#a90638ba01c06cdbef93d21e7c8877770">_wp_radius_cm</a> ) {</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;                    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#af5ad1453ba2999e97f239a1ee99d1ec1">reached_destination</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;                }</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            }</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        }</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    }</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    <span class="comment">// successfully advanced along track</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;}</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;</div><div class="line"><a name="l00704"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a2ff059085a523215ddb8151c1835d898">  704</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classAC__WPNav.html#a2ff059085a523215ddb8151c1835d898">AC_WPNav::get_wp_distance_to_destination</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    <span class="comment">// get current location</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> curr = <a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#a39348dd51a8c32fe16d01dfef284e31a">get_position</a>();</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="AP__Math_8h.html#a2c34476e01b9988589e9be01e6c8b5f0">norm</a>(<a class="code" href="classAC__WPNav.html#ae2eba98522934eaa1968e99ecfa91d93">_destination</a>.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>-curr.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>,<a class="code" href="classAC__WPNav.html#ae2eba98522934eaa1968e99ecfa91d93">_destination</a>.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>-curr.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>);</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;}</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div><div class="line"><a name="l00712"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#aaf51adb38cdaf72ffa54d2a03a151cfd">  712</a></span>&#160;int32_t <a class="code" href="classAC__WPNav.html#aaf51adb38cdaf72ffa54d2a03a151cfd">AC_WPNav::get_wp_bearing_to_destination</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classAC__WPNav.html#acdde881fbaae3bc13155a34ee88a6e48">get_bearing_cd</a>(<a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#a39348dd51a8c32fe16d01dfef284e31a">get_position</a>(), <a class="code" href="classAC__WPNav.html#ae2eba98522934eaa1968e99ecfa91d93">_destination</a>);</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;}</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;</div><div class="line"><a name="l00718"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a7dc4785fbce8364d7eb3d8e2d0c1b987">  718</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAC__WPNav.html#a7dc4785fbce8364d7eb3d8e2d0c1b987">AC_WPNav::update_wpnav</a>()</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;{</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    <span class="comment">// calculate dt</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    <span class="keywordtype">float</span> dt = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aba69e5af4db360bb85275fe843f7e95e">time_since_last_xy_update</a>();</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    <span class="keywordtype">bool</span> ret = <span class="keyword">true</span>;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    <span class="comment">// update at poscontrol update rate</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    <span class="keywordflow">if</span> (dt &gt;= <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ab4a37d0f0ce8ea8038758158f8d06562">get_dt_xy</a>()) {</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        <span class="comment">// allow the accel and speed values to be set without changing</span></div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        <span class="comment">// out of auto mode. This makes it easier to tune auto flight</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a5e47fd89f68af7f00d9bd59cfcb422a8">set_accel_xy</a>(<a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a>);</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a44ce19c29764128d832fa3c1bc871be4">set_jerk_xy_to_default</a>();</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ad7ef264f7da50fe3f0e035604fdcfea4">set_accel_z</a>(<a class="code" href="classAC__WPNav.html#a4b59ba145a08beb8fe568c997908e34d">_wp_accel_z_cms</a>);</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    </div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        <span class="comment">// sanity check dt</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;        <span class="keywordflow">if</span> (dt &gt;= 0.2<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;            dt = 0.0f;</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        }</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        <span class="comment">// advance the target if necessary</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a603ec5c1a7654ccd9a227565cdbee275">advance_wp_target_along_track</a>(dt)) {</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;            <span class="comment">// To-Do: handle inability to advance along track (probably because of missing terrain data)</span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;            ret = <span class="keyword">false</span>;</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;        }</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        <span class="comment">// freeze feedforwards during known discontinuities</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        <span class="comment">// TODO: why always consider Z axis discontinuous?</span></div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#a212e8bdfd1e8dfb5585f8616d37416c8">new_wp_destination</a>) {</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;            <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#a212e8bdfd1e8dfb5585f8616d37416c8">new_wp_destination</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;            <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ac150947d527995a72dff6ad0921a1891">freeze_ff_xy</a>();</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;        }</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aa979d20c99f08a96d0f482c1dad50f78">freeze_ff_z</a>();</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a497c1799c10d146b6f2e2b542889c083">update_xy_controller</a>(<a class="code" href="classAC__PosControl.html#a773f0830b9aa2c591f5fb2dd6287997ca73eb55dccf01566a1d4d3834572eefaa">AC_PosControl::XY_MODE_POS_ONLY</a>, 1.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>, <span class="keyword">false</span>);</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;        <a class="code" href="classAC__WPNav.html#a508f2bfaf76856a1a6e137cb697fe315">check_wp_leash_length</a>();</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;        <a class="code" href="classAC__WPNav.html#acee5cbca4296027197ee0c892b5dbc38">_wp_last_update</a> = <a class="code" href="namespaceAP__HAL.html#a77dffbb18891996280308e21316ec186">AP_HAL::millis</a>();</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    }</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;}</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="comment">// check_wp_leash_length - check if waypoint leash lengths need to be recalculated</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="comment">//  should be called after _pos_control.update_xy_controller which may have changed the position controller leash lengths</span></div><div class="line"><a name="l00762"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a508f2bfaf76856a1a6e137cb697fe315">  762</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a508f2bfaf76856a1a6e137cb697fe315">AC_WPNav::check_wp_leash_length</a>()</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;{</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="comment">// exit immediately if recalc is not required</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#a093c5f28780c35169320486da9b13a43">recalc_wp_leash</a>) {</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        <a class="code" href="classAC__WPNav.html#a2036d6ad0d72ba04c425a0a68553209b">calculate_wp_leash_length</a>();</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    }</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;}</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;</div><div class="line"><a name="l00771"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a2036d6ad0d72ba04c425a0a68553209b">  771</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a2036d6ad0d72ba04c425a0a68553209b">AC_WPNav::calculate_wp_leash_length</a>()</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;{</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    <span class="comment">// length of the unit direction vector in the horizontal</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    <span class="keywordtype">float</span> pos_delta_unit_xy = <a class="code" href="AP__Math_8h.html#a2c34476e01b9988589e9be01e6c8b5f0">norm</a>(<a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>, <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>);</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    <span class="keywordtype">float</span> pos_delta_unit_z = fabsf(<a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a>);</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    <span class="keywordtype">float</span> speed_z;</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <span class="keywordtype">float</span> leash_z;</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> &gt;= 0.0f) {</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;        speed_z = <a class="code" href="classAC__WPNav.html#a9a04a9cd8aeca3ddaf980dcdec86943b">_wp_speed_up_cms</a>;</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        leash_z = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ab17ea3a4f6f232c9944712b39e76aac8">get_leash_up_z</a>();</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;        speed_z = <a class="code" href="classAC__WPNav.html#ad63cee44ffeaaf4e18f42571a34093b8">_wp_speed_down_cms</a>;</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;        leash_z = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aeba418c057fc5aa5aa784d809da98f14">get_leash_down_z</a>();</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    }</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    <span class="comment">// calculate the maximum acceleration, maximum velocity, and leash length in the direction of travel</span></div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(pos_delta_unit_z) &amp;&amp; <a class="code" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(pos_delta_unit_xy)){</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        <a class="code" href="classAC__WPNav.html#a3a665f936634a13be4e8382b7924039f">_track_accel</a> = 0;</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        <a class="code" href="classAC__WPNav.html#a1df2d6792b0b42b8c60bb57b5c1991cf">_track_speed</a> = 0;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;        <a class="code" href="classAC__WPNav.html#a3c60c5ddf37a79af9238249a1784dc23">_track_leash_length</a> = <a class="code" href="AC__WPNav_8h.html#a3e1d84c583fbfe3086e10b3006a64447">WPNAV_LEASH_LENGTH_MIN</a>;</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(<a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a>.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a>)){</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;        <a class="code" href="classAC__WPNav.html#a3a665f936634a13be4e8382b7924039f">_track_accel</a> = <a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a>/pos_delta_unit_xy;</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;        <a class="code" href="classAC__WPNav.html#a1df2d6792b0b42b8c60bb57b5c1991cf">_track_speed</a> = <a class="code" href="classAC__WPNav.html#a6341785a5caab8c9addb607d93fb0299">_wp_speed_cms</a>/pos_delta_unit_xy;</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;        <a class="code" href="classAC__WPNav.html#a3c60c5ddf37a79af9238249a1784dc23">_track_leash_length</a> = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aa5759b18c7c1208b6979c728fb85f1e4">get_leash_xy</a>()/pos_delta_unit_xy;</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(pos_delta_unit_xy)){</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        <a class="code" href="classAC__WPNav.html#a3a665f936634a13be4e8382b7924039f">_track_accel</a> = <a class="code" href="classAC__WPNav.html#a4b59ba145a08beb8fe568c997908e34d">_wp_accel_z_cms</a>/pos_delta_unit_z;</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        <a class="code" href="classAC__WPNav.html#a1df2d6792b0b42b8c60bb57b5c1991cf">_track_speed</a> = speed_z/pos_delta_unit_z;</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        <a class="code" href="classAC__WPNav.html#a3c60c5ddf37a79af9238249a1784dc23">_track_leash_length</a> = leash_z/pos_delta_unit_z;</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        <a class="code" href="classAC__WPNav.html#a3a665f936634a13be4e8382b7924039f">_track_accel</a> = <a class="code" href="AP__Math_8h.html#a6b187a3fa1e9f663e89175e7e8e213d6">MIN</a>(<a class="code" href="classAC__WPNav.html#a4b59ba145a08beb8fe568c997908e34d">_wp_accel_z_cms</a>/pos_delta_unit_z, <a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a>/pos_delta_unit_xy);</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        <a class="code" href="classAC__WPNav.html#a1df2d6792b0b42b8c60bb57b5c1991cf">_track_speed</a> = <a class="code" href="AP__Math_8h.html#a6b187a3fa1e9f663e89175e7e8e213d6">MIN</a>(speed_z/pos_delta_unit_z, <a class="code" href="classAC__WPNav.html#a6341785a5caab8c9addb607d93fb0299">_wp_speed_cms</a>/pos_delta_unit_xy);</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;        <a class="code" href="classAC__WPNav.html#a3c60c5ddf37a79af9238249a1784dc23">_track_leash_length</a> = <a class="code" href="AP__Math_8h.html#a6b187a3fa1e9f663e89175e7e8e213d6">MIN</a>(leash_z/pos_delta_unit_z, <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aa5759b18c7c1208b6979c728fb85f1e4">get_leash_xy</a>()/pos_delta_unit_xy);</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    }</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    <span class="comment">// calculate slow down distance (the distance from the destination when the target point should begin to slow down)</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    <a class="code" href="classAC__WPNav.html#a4bbed458f180899ecffd17e508ddf408">calc_slow_down_distance</a>(<a class="code" href="classAC__WPNav.html#a1df2d6792b0b42b8c60bb57b5c1991cf">_track_speed</a>, <a class="code" href="classAC__WPNav.html#a3a665f936634a13be4e8382b7924039f">_track_accel</a>);</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    <span class="comment">// set recalc leash flag to false</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#a093c5f28780c35169320486da9b13a43">recalc_wp_leash</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;}</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;</div><div class="line"><a name="l00822"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a9f9b2b3b12fabb2f5b8026018e562d69">  822</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAC__WPNav.html#a9f9b2b3b12fabb2f5b8026018e562d69">AC_WPNav::set_spline_destination</a>(<span class="keyword">const</span> <a class="code" href="classLocation__Class.html">Location_Class</a>&amp; destination, <span class="keywordtype">bool</span> stopped_at_start, <a class="code" href="classAC__WPNav.html#a8dbe5714a3adf0eae1d7dbc6fa738261">spline_segment_end_type</a> seg_end_type, <a class="code" href="classLocation__Class.html">Location_Class</a> next_destination)</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;{</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="comment">// convert destination location to vector</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> dest_neu;</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    <span class="keywordtype">bool</span> dest_terr_alt;</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a91b8fa0d48a6fb79a4d7ef38dfc11123">get_vector_NEU</a>(destination, dest_neu, dest_terr_alt)) {</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    }</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <span class="comment">// make altitude frames consistent</span></div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    <span class="keywordflow">if</span> (!next_destination.<a class="code" href="classLocation__Class.html#a1b58a6a4d185506e76271dee1f047836">change_alt_frame</a>(destination.<a class="code" href="classLocation__Class.html#a12eedb8fc1b0f9391bc07891decf95fc">get_alt_frame</a>())) {</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    }</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="comment">// convert next destination to vector</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> next_dest_neu;</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    <span class="keywordtype">bool</span> next_dest_terr_alt;</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a91b8fa0d48a6fb79a4d7ef38dfc11123">get_vector_NEU</a>(next_destination, next_dest_neu, next_dest_terr_alt)) {</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    }</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <span class="comment">// set target as vector from EKF origin</span></div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classAC__WPNav.html#a9f9b2b3b12fabb2f5b8026018e562d69">set_spline_destination</a>(dest_neu, dest_terr_alt, stopped_at_start, seg_end_type, next_dest_neu);</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;}</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;</div><div class="line"><a name="l00853"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a8caabd95cf51512456cd8d81f38dbff9">  853</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAC__WPNav.html#a9f9b2b3b12fabb2f5b8026018e562d69">AC_WPNav::set_spline_destination</a>(<span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; destination, <span class="keywordtype">bool</span> terrain_alt, <span class="keywordtype">bool</span> stopped_at_start, <a class="code" href="classAC__WPNav.html#a8dbe5714a3adf0eae1d7dbc6fa738261">spline_segment_end_type</a> seg_end_type, <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; next_destination)</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;{</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> origin;</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;    <span class="comment">// if waypoint controller is active and copter has reached the previous waypoint use current pos target as the origin</span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="namespaceAP__HAL.html#a77dffbb18891996280308e21316ec186">AP_HAL::millis</a>() - <a class="code" href="classAC__WPNav.html#acee5cbca4296027197ee0c892b5dbc38">_wp_last_update</a>) &lt; 1000) {</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        origin = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a6b3617b946ffd6935c11a63629f186ec">get_pos_target</a>();</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;        <span class="comment">// otherwise calculate origin from the current position and velocity</span></div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a4054e2d2dc53b9b0c2fd26898781af89">get_stopping_point_xy</a>(origin);</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a20ac6348cbb9a1ac803c626c91ec93e5">get_stopping_point_z</a>(origin);</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    }</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    <span class="comment">// convert origin to alt-above-terrain</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <span class="keywordflow">if</span> (terrain_alt) {</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;        <span class="keywordtype">float</span> terr_offset;</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a89a2d6885b96dd09bab36ccda16a6dce">get_terrain_offset</a>(terr_offset)) {</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        }</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;        origin.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> -= terr_offset;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    }</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;    <span class="comment">// set origin and destination</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classAC__WPNav.html#a0e91b64e0b97a76cbe20478ac438ab1b">set_spline_origin_and_destination</a>(origin, destination, terrain_alt, stopped_at_start, seg_end_type, next_destination);</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;}</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;</div><div class="line"><a name="l00882"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a0e91b64e0b97a76cbe20478ac438ab1b">  882</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAC__WPNav.html#a0e91b64e0b97a76cbe20478ac438ab1b">AC_WPNav::set_spline_origin_and_destination</a>(<span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; origin, <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; destination, <span class="keywordtype">bool</span> terrain_alt, <span class="keywordtype">bool</span> stopped_at_start, <a class="code" href="classAC__WPNav.html#a8dbe5714a3adf0eae1d7dbc6fa738261">spline_segment_end_type</a> seg_end_type, <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; next_destination)</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;{</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    <span class="comment">// mission is &quot;active&quot; if wpnav has been called recently and vehicle reached the previous waypoint</span></div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    <span class="keywordtype">bool</span> prev_segment_exists = (<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#af5ad1453ba2999e97f239a1ee99d1ec1">reached_destination</a> &amp;&amp; ((<a class="code" href="namespaceAP__HAL.html#a77dffbb18891996280308e21316ec186">AP_HAL::millis</a>() - <a class="code" href="classAC__WPNav.html#acee5cbca4296027197ee0c892b5dbc38">_wp_last_update</a>) &lt; 1000));</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="keywordtype">float</span> dt = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ab4a37d0f0ce8ea8038758158f8d06562">get_dt_xy</a>();</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    <span class="comment">// check _wp_accel_cms is reasonable to avoid divide by zero</span></div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a> &lt;= 0) {</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        <a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a>.set_and_save(<a class="code" href="AC__WPNav_8h.html#a0a35073f3a0ea9c0873a2d4327a8619f">WPNAV_ACCELERATION</a>);</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    }</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    <span class="comment">// segment start types</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    <span class="comment">// stop - vehicle is not moving at origin</span></div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    <span class="comment">// straight-fast - vehicle is moving, previous segment is straight.  vehicle will fly straight through the waypoint before beginning it&#39;s spline path to the next wp</span></div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    <span class="comment">//     _flag.segment_type holds whether prev segment is straight vs spline but we don&#39;t know if it has a delay</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="comment">// spline-fast - vehicle is moving, previous segment is splined, vehicle will fly through waypoint but previous segment should have it flying in the correct direction (i.e. exactly parallel to position difference vector from previous segment&#39;s origin to this segment&#39;s destination)</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    <span class="comment">// calculate spline velocity at origin</span></div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    <span class="keywordflow">if</span> (stopped_at_start || !prev_segment_exists) {</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;        <span class="comment">// if vehicle is stopped at the origin, set origin velocity to 0.02 * distance vector from origin to destination</span></div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;        <a class="code" href="classAC__WPNav.html#ae70c4ac2dd6a1f567225bc9f430ba1cd">_spline_origin_vel</a> = (destination - origin) * dt;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;        <a class="code" href="classAC__WPNav.html#aaffcda5dd4da387a0c79a1271269a520">_spline_time</a> = 0.0f;</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;        <a class="code" href="classAC__WPNav.html#a6a6bf7982d149c080ac9eea9db215759">_spline_vel_scaler</a> = 0.0f;</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        <span class="comment">// look at previous segment to determine velocity at origin</span></div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#afe76f469a51fa8525915518f9ca7f42b">segment_type</a> == <a class="code" href="classAC__WPNav.html#a40589bfae2c593c46a05e53601954311a6aef631564494d1c7bc74592e39d2ad7">SEGMENT_STRAIGHT</a>) {</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;            <span class="comment">// previous segment is straight, vehicle is moving so vehicle should fly straight through the origin</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;            <span class="comment">// before beginning it&#39;s spline path to the next waypoint. Note: we are using the previous segment&#39;s origin and destination</span></div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;            <a class="code" href="classAC__WPNav.html#ae70c4ac2dd6a1f567225bc9f430ba1cd">_spline_origin_vel</a> = (<a class="code" href="classAC__WPNav.html#ae2eba98522934eaa1968e99ecfa91d93">_destination</a> - <a class="code" href="classAC__WPNav.html#a5d54686767fb1e5c60c8826160e8ac14">_origin</a>);</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;            <a class="code" href="classAC__WPNav.html#aaffcda5dd4da387a0c79a1271269a520">_spline_time</a> = 0.0f;    <span class="comment">// To-Do: this should be set based on how much overrun there was from straight segment?</span></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;            <a class="code" href="classAC__WPNav.html#a6a6bf7982d149c080ac9eea9db215759">_spline_vel_scaler</a> = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a96906c90e74171ac3fec93c512926207">get_vel_target</a>().<a class="code" href="classVector3.html#ac1fd5514e368a1e1c2d13f71eda18345">length</a>();    <span class="comment">// start velocity target from current target velocity</span></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;        }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;            <span class="comment">// previous segment is splined, vehicle will fly through origin</span></div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;            <span class="comment">// we can use the previous segment&#39;s destination velocity as this segment&#39;s origin velocity</span></div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;            <span class="comment">// Note: previous segment will leave destination velocity parallel to position difference vector</span></div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;            <span class="comment">//       from previous segment&#39;s origin to this segment&#39;s destination)</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;            <a class="code" href="classAC__WPNav.html#ae70c4ac2dd6a1f567225bc9f430ba1cd">_spline_origin_vel</a> = <a class="code" href="classAC__WPNav.html#a44623f917d318231b8468c35aae93ab5">_spline_destination_vel</a>;</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#aaffcda5dd4da387a0c79a1271269a520">_spline_time</a> &gt; 1.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> &amp;&amp; <a class="code" href="classAC__WPNav.html#aaffcda5dd4da387a0c79a1271269a520">_spline_time</a> &lt; 1.1<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {    <span class="comment">// To-Do: remove hard coded 1.1f</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;                <a class="code" href="classAC__WPNav.html#aaffcda5dd4da387a0c79a1271269a520">_spline_time</a> -= 1.0f;</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;            }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;                <a class="code" href="classAC__WPNav.html#aaffcda5dd4da387a0c79a1271269a520">_spline_time</a> = 0.0f;</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;            }</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;            <span class="comment">// Note: we leave _spline_vel_scaler as it was from end of previous segment</span></div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        }</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    }</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    <span class="comment">// calculate spline velocity at destination</span></div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    <span class="keywordflow">switch</span> (seg_end_type) {</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="classAC__WPNav.html#a8dbe5714a3adf0eae1d7dbc6fa738261a7c9cfa20d19d3f51696b1fc8c991a2dd">SEGMENT_END_STOP</a>:</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        <span class="comment">// if vehicle stops at the destination set destination velocity to 0.02 * distance vector from origin to destination</span></div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        <a class="code" href="classAC__WPNav.html#a44623f917d318231b8468c35aae93ab5">_spline_destination_vel</a> = (destination - origin) * dt;</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ad8a49f0a80a119c6cdf901807227251b">fast_waypoint</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="classAC__WPNav.html#a8dbe5714a3adf0eae1d7dbc6fa738261a812f74d3d4b71e281c642c6f07d5457c">SEGMENT_END_STRAIGHT</a>:</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        <span class="comment">// if next segment is straight, vehicle&#39;s final velocity should face along the next segment&#39;s position</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;        <a class="code" href="classAC__WPNav.html#a44623f917d318231b8468c35aae93ab5">_spline_destination_vel</a> = (next_destination - destination);</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;        <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ad8a49f0a80a119c6cdf901807227251b">fast_waypoint</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="classAC__WPNav.html#a8dbe5714a3adf0eae1d7dbc6fa738261a244adee4a19c8f357e6bc4996d61c9e0">SEGMENT_END_SPLINE</a>:</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;        <span class="comment">// if next segment is splined, vehicle&#39;s final velocity should face parallel to the line from the origin to the next destination</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        <a class="code" href="classAC__WPNav.html#a44623f917d318231b8468c35aae93ab5">_spline_destination_vel</a> = (next_destination - origin);</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ad8a49f0a80a119c6cdf901807227251b">fast_waypoint</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    }</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    <span class="comment">// code below ensures we don&#39;t get too much overshoot when the next segment is short</span></div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="keywordtype">float</span> vel_len = <a class="code" href="classAC__WPNav.html#ae70c4ac2dd6a1f567225bc9f430ba1cd">_spline_origin_vel</a>.<a class="code" href="classVector3.html#ac1fd5514e368a1e1c2d13f71eda18345">length</a>() + <a class="code" href="classAC__WPNav.html#a44623f917d318231b8468c35aae93ab5">_spline_destination_vel</a>.<a class="code" href="classVector3.html#ac1fd5514e368a1e1c2d13f71eda18345">length</a>();</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    <span class="keywordtype">float</span> pos_len = (destination - origin).length() * 4.0f;</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    <span class="keywordflow">if</span> (vel_len &gt; pos_len) {</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;        <span class="comment">// if total start+stop velocity is more than twice position difference</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        <span class="comment">// use a scaled down start and stop velocityscale the  start and stop velocities down</span></div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;        <span class="keywordtype">float</span> vel_scaling = pos_len / vel_len;</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        <span class="comment">// update spline calculator</span></div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;        <a class="code" href="classAC__WPNav.html#a455f7b1102bc8e80f18ff80dc415d06d">update_spline_solution</a>(origin, destination, <a class="code" href="classAC__WPNav.html#ae70c4ac2dd6a1f567225bc9f430ba1cd">_spline_origin_vel</a> * vel_scaling, <a class="code" href="classAC__WPNav.html#a44623f917d318231b8468c35aae93ab5">_spline_destination_vel</a> * vel_scaling);</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;    }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;        <span class="comment">// update spline calculator</span></div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        <a class="code" href="classAC__WPNav.html#a455f7b1102bc8e80f18ff80dc415d06d">update_spline_solution</a>(origin, destination, <a class="code" href="classAC__WPNav.html#ae70c4ac2dd6a1f567225bc9f430ba1cd">_spline_origin_vel</a>, <a class="code" href="classAC__WPNav.html#a44623f917d318231b8468c35aae93ab5">_spline_destination_vel</a>);</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    }</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    <span class="comment">// initialise yaw heading to current heading</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    <a class="code" href="classAC__WPNav.html#ae1e4c1e17634f9e8a672b4ed47b76ad8">_yaw</a> = <a class="code" href="classAC__WPNav.html#a17bf8df6a841f35e17641984fa46bab0">_attitude_control</a>.<a class="code" href="classAC__AttitudeControl.html#aec35222c9dee5999aaf029484ea356c9">get_att_target_euler_cd</a>().<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a>;</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;    <span class="comment">// store origin and destination locations</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;    <a class="code" href="classAC__WPNav.html#a5d54686767fb1e5c60c8826160e8ac14">_origin</a> = origin;</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;    <a class="code" href="classAC__WPNav.html#ae2eba98522934eaa1968e99ecfa91d93">_destination</a> = destination;</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    <a class="code" href="classAC__WPNav.html#ad0b9019cec333348644f43112c8b6144">_terrain_alt</a> = terrain_alt;</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    <span class="comment">// calculate slow down distance</span></div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    <a class="code" href="classAC__WPNav.html#a4bbed458f180899ecffd17e508ddf408">calc_slow_down_distance</a>(<a class="code" href="classAC__WPNav.html#a6341785a5caab8c9addb607d93fb0299">_wp_speed_cms</a>, <a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a>);</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;    <span class="comment">// get alt-above-terrain</span></div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    <span class="keywordtype">float</span> terr_offset = 0.0f;</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    <span class="keywordflow">if</span> (terrain_alt) {</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a89a2d6885b96dd09bab36ccda16a6dce">get_terrain_offset</a>(terr_offset)) {</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        }</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    }</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;    <span class="comment">// initialise intermediate point to the origin</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ad70a79da0c5dcde97ccf848b03e7356a">set_pos_target</a>(origin + <a class="code" href="vector3_8h.html#af345ad77ba5e240c7ab72b4b2077e754">Vector3f</a>(0,0,terr_offset));</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#af5ad1453ba2999e97f239a1ee99d1ec1">reached_destination</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#afe76f469a51fa8525915518f9ca7f42b">segment_type</a> = <a class="code" href="classAC__WPNav.html#a40589bfae2c593c46a05e53601954311abc642b8549e3cea95beb0cfddc21954c">SEGMENT_SPLINE</a>;</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#a212e8bdfd1e8dfb5585f8616d37416c8">new_wp_destination</a> = <span class="keyword">true</span>;   <span class="comment">// flag new waypoint so we can freeze the pos controller&#39;s feed forward and smooth the transition</span></div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;}</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;</div><div class="line"><a name="l00993"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#acc138e7bc6435087ab308896358de6a3">  993</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAC__WPNav.html#acc138e7bc6435087ab308896358de6a3">AC_WPNav::update_spline</a>()</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;{</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;    <span class="comment">// exit immediately if this is not a spline segment</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#afe76f469a51fa8525915518f9ca7f42b">segment_type</a> != <a class="code" href="classAC__WPNav.html#a40589bfae2c593c46a05e53601954311abc642b8549e3cea95beb0cfddc21954c">SEGMENT_SPLINE</a>) {</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    }</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    <span class="keywordtype">float</span> dt = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aba69e5af4db360bb85275fe843f7e95e">time_since_last_xy_update</a>();</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    <span class="keywordtype">bool</span> ret = <span class="keyword">true</span>;</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    <span class="comment">// run at poscontrol update rate</span></div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    <span class="keywordflow">if</span> (dt &gt;= <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ab4a37d0f0ce8ea8038758158f8d06562">get_dt_xy</a>()) {</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;        <span class="comment">// sanity check dt</span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        <span class="keywordflow">if</span> (dt &gt;= 0.2<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;            dt = 0.0f;</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;        }</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;        <span class="comment">// advance the target if necessary</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#aa1a3da70925cc9327222d2923807ec21">advance_spline_target_along_track</a>(dt)) {</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;            <span class="comment">// To-Do: handle failure to advance along track (due to missing terrain data)</span></div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;            ret = <span class="keyword">false</span>;</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;        }</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;        <span class="comment">// freeze feedforwards during known discontinuities</span></div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;        <span class="comment">// TODO: why always consider Z axis discontinuous?</span></div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#a212e8bdfd1e8dfb5585f8616d37416c8">new_wp_destination</a>) {</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;            <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#a212e8bdfd1e8dfb5585f8616d37416c8">new_wp_destination</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;            <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ac150947d527995a72dff6ad0921a1891">freeze_ff_xy</a>();</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        }</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aa979d20c99f08a96d0f482c1dad50f78">freeze_ff_z</a>();</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;        <span class="comment">// run horizontal position controller</span></div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#a497c1799c10d146b6f2e2b542889c083">update_xy_controller</a>(<a class="code" href="classAC__PosControl.html#a773f0830b9aa2c591f5fb2dd6287997ca73eb55dccf01566a1d4d3834572eefaa">AC_PosControl::XY_MODE_POS_ONLY</a>, 1.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>, <span class="keyword">false</span>);</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;        <a class="code" href="classAC__WPNav.html#acee5cbca4296027197ee0c892b5dbc38">_wp_last_update</a> = <a class="code" href="namespaceAP__HAL.html#a77dffbb18891996280308e21316ec186">AP_HAL::millis</a>();</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    }</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;}</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;</div><div class="line"><a name="l01034"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a455f7b1102bc8e80f18ff80dc415d06d"> 1034</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a455f7b1102bc8e80f18ff80dc415d06d">AC_WPNav::update_spline_solution</a>(<span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; origin, <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; dest, <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; origin_vel, <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a>&amp; dest_vel)</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;{</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    <a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">_hermite_spline_solution</a>[0] = origin;</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    <a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">_hermite_spline_solution</a>[1] = origin_vel;</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;    <a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">_hermite_spline_solution</a>[2] = -origin*3.0f -origin_vel*2.0f + dest*3.0f - dest_vel;</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    <a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">_hermite_spline_solution</a>[3] = origin*2.0f + origin_vel -dest*2.0f + dest_vel;</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160; }</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;</div><div class="line"><a name="l01043"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#aa1a3da70925cc9327222d2923807ec21"> 1043</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAC__WPNav.html#aa1a3da70925cc9327222d2923807ec21">AC_WPNav::advance_spline_target_along_track</a>(<span class="keywordtype">float</span> dt)</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;{</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#af5ad1453ba2999e97f239a1ee99d1ec1">reached_destination</a>) {</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;        <a class="code" href="classVector3.html">Vector3f</a> target_pos, target_vel;</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;        <span class="comment">// update target position and velocity from spline calculator</span></div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;        <a class="code" href="classAC__WPNav.html#a3bd02c16cf547cd92584d908f65ccb50">calc_spline_pos_vel</a>(<a class="code" href="classAC__WPNav.html#aaffcda5dd4da387a0c79a1271269a520">_spline_time</a>, target_pos, target_vel);</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;        <a class="code" href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">_pos_delta_unit</a> = target_vel/target_vel.<a class="code" href="classVector3.html#ac1fd5514e368a1e1c2d13f71eda18345">length</a>();</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;        <a class="code" href="classAC__WPNav.html#a2036d6ad0d72ba04c425a0a68553209b">calculate_wp_leash_length</a>();</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;        <span class="comment">// get current location</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;        <a class="code" href="classVector3.html">Vector3f</a> curr_pos = <a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#a39348dd51a8c32fe16d01dfef284e31a">get_position</a>();</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;        <span class="comment">// get terrain altitude offset for origin and current position (i.e. change in terrain altitude from a position vs ekf origin)</span></div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;        <span class="keywordtype">float</span> terr_offset = 0.0f;</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#ad0b9019cec333348644f43112c8b6144">_terrain_alt</a> &amp;&amp; !<a class="code" href="classAC__WPNav.html#a89a2d6885b96dd09bab36ccda16a6dce">get_terrain_offset</a>(terr_offset)) {</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;        }</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;        <span class="comment">// calculate position error</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;        <a class="code" href="classVector3.html">Vector3f</a> track_error = curr_pos - target_pos;</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        track_error.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> -= terr_offset;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        <span class="comment">// calculate the horizontal error</span></div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        <span class="keywordtype">float</span> track_error_xy = <a class="code" href="AP__Math_8h.html#a2c34476e01b9988589e9be01e6c8b5f0">norm</a>(track_error.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>, track_error.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>);</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;        <span class="comment">// calculate the vertical error</span></div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;        <span class="keywordtype">float</span> track_error_z = fabsf(track_error.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a>);</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;        <span class="comment">// get position control leash lengths</span></div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;        <span class="keywordtype">float</span> leash_xy = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aa5759b18c7c1208b6979c728fb85f1e4">get_leash_xy</a>();</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;        <span class="keywordtype">float</span> leash_z;</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;        <span class="keywordflow">if</span> (track_error.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> &gt;= 0) {</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;            leash_z = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ab17ea3a4f6f232c9944712b39e76aac8">get_leash_up_z</a>();</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;        }<span class="keywordflow">else</span>{</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;            leash_z = <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#aeba418c057fc5aa5aa784d809da98f14">get_leash_down_z</a>();</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;        }</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;        <span class="comment">// calculate how far along the track we could move the intermediate target before reaching the end of the leash</span></div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;        <span class="keywordtype">float</span> track_leash_slack = <a class="code" href="AP__Math_8h.html#a6b187a3fa1e9f663e89175e7e8e213d6">MIN</a>(<a class="code" href="classAC__WPNav.html#a3c60c5ddf37a79af9238249a1784dc23">_track_leash_length</a>*(leash_z-track_error_z)/leash_z, <a class="code" href="classAC__WPNav.html#a3c60c5ddf37a79af9238249a1784dc23">_track_leash_length</a>*(leash_xy-track_error_xy)/leash_xy);</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;        <span class="keywordflow">if</span> (track_leash_slack &lt; 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;            track_leash_slack = 0.0f;</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        }</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        <span class="comment">// update velocity</span></div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;        <span class="keywordtype">float</span> spline_dist_to_wp = (<a class="code" href="classAC__WPNav.html#ae2eba98522934eaa1968e99ecfa91d93">_destination</a> - target_pos).length();</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        <span class="keywordtype">float</span> vel_limit = <a class="code" href="classAC__WPNav.html#a6341785a5caab8c9addb607d93fb0299">_wp_speed_cms</a>;</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(dt)) {</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;            vel_limit = <a class="code" href="AP__Math_8h.html#a6b187a3fa1e9f663e89175e7e8e213d6">MIN</a>(vel_limit, track_leash_slack/dt);</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;        }</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;        <span class="comment">// if within the stopping distance from destination, set target velocity to sqrt of distance * 2 * acceleration</span></div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#ad8a49f0a80a119c6cdf901807227251b">fast_waypoint</a> &amp;&amp; spline_dist_to_wp &lt; <a class="code" href="classAC__WPNav.html#a0c003971d88dadd9b8101fbf60534280">_slow_down_dist</a>) {</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;            <a class="code" href="classAC__WPNav.html#a6a6bf7982d149c080ac9eea9db215759">_spline_vel_scaler</a> = <a class="code" href="AP__Math_8cpp.html#ac89eb1832d8e4d67fcf1ac07e3c25184">safe_sqrt</a>(spline_dist_to_wp * 2.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> * <a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a>);</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;        }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classAC__WPNav.html#a6a6bf7982d149c080ac9eea9db215759">_spline_vel_scaler</a> &lt; vel_limit) {</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;            <span class="comment">// increase velocity using acceleration</span></div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;            <a class="code" href="classAC__WPNav.html#a6a6bf7982d149c080ac9eea9db215759">_spline_vel_scaler</a> += <a class="code" href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">_wp_accel_cms</a> * dt;</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        }</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        <span class="comment">// constrain target velocity</span></div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;        <a class="code" href="classAC__WPNav.html#a6a6bf7982d149c080ac9eea9db215759">_spline_vel_scaler</a> = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(<a class="code" href="classAC__WPNav.html#a6a6bf7982d149c080ac9eea9db215759">_spline_vel_scaler</a>, 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>, vel_limit);</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;        <span class="comment">// scale the spline_time by the velocity we&#39;ve calculated vs the velocity that came out of the spline calculator</span></div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;        <span class="keywordtype">float</span> target_vel_length = target_vel.<a class="code" href="classVector3.html#ac1fd5514e368a1e1c2d13f71eda18345">length</a>();</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(target_vel_length)) {</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;            <a class="code" href="classAC__WPNav.html#a84657e792587890796f5131ca77e7819">_spline_time_scale</a> = <a class="code" href="classAC__WPNav.html#a6a6bf7982d149c080ac9eea9db215759">_spline_vel_scaler</a>/target_vel_length;</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;        }</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;        <span class="comment">// update target position</span></div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;        target_pos.z += terr_offset;</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;        <a class="code" href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">_pos_control</a>.<a class="code" href="classAC__PosControl.html#ad70a79da0c5dcde97ccf848b03e7356a">set_pos_target</a>(target_pos);</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;        <span class="comment">// update the yaw</span></div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;        <a class="code" href="classAC__WPNav.html#ae1e4c1e17634f9e8a672b4ed47b76ad8">_yaw</a> = <a class="code" href="definitions_8h.html#a96799f9de58a211f6b3bdc96c6e10669">RadiansToCentiDegrees</a>(atan2f(target_vel.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>,target_vel.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>));</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        <span class="comment">// advance spline time to next step</span></div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        <a class="code" href="classAC__WPNav.html#aaffcda5dd4da387a0c79a1271269a520">_spline_time</a> += <a class="code" href="classAC__WPNav.html#a84657e792587890796f5131ca77e7819">_spline_time_scale</a>*dt;</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;        <span class="comment">// we will reach the next waypoint in the next step so set reached_destination flag</span></div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;        <span class="comment">// To-Do: is this one step too early?</span></div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#aaffcda5dd4da387a0c79a1271269a520">_spline_time</a> &gt;= 1.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;            <a class="code" href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">_flags</a>.<a class="code" href="structAC__WPNav_1_1wpnav__flags.html#af5ad1453ba2999e97f239a1ee99d1ec1">reached_destination</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;        }</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;    }</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;}</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;<span class="comment">// calc_spline_pos_vel_accel - calculates target position, velocity and acceleration for the given &quot;spline_time&quot;</span></div><div class="line"><a name="l01133"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a3bd02c16cf547cd92584d908f65ccb50"> 1133</a></span>&#160;<span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a3bd02c16cf547cd92584d908f65ccb50">AC_WPNav::calc_spline_pos_vel</a>(<span class="keywordtype">float</span> spline_time, <a class="code" href="classVector3.html">Vector3f</a>&amp; position, <a class="code" href="classVector3.html">Vector3f</a>&amp; velocity)</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;{</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    <span class="keywordtype">float</span> spline_time_sqrd = spline_time * spline_time;</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    <span class="keywordtype">float</span> spline_time_cubed = spline_time_sqrd * spline_time;</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    position = <a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">_hermite_spline_solution</a>[0] + <a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">\</a></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;<a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">               _hermite_spline_solution</a>[1] * spline_time + <a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">\</a></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;<a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">               _hermite_spline_solution</a>[2] * spline_time_sqrd + <a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">\</a></div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;<a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">               _hermite_spline_solution</a>[3] * spline_time_cubed;</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;    velocity = <a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">_hermite_spline_solution</a>[1] + <a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">\</a></div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;<a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">               _hermite_spline_solution</a>[2] * 2.0f * spline_time + <a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">\</a></div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;<a class="code" href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">               _hermite_spline_solution</a>[3] * 3.0f * spline_time_sqrd;</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;}</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;<span class="comment">// get terrain&#39;s altitude (in cm above the ekf origin) at the current position (+ve means terrain below vehicle is above ekf origin&#39;s altitude)</span></div><div class="line"><a name="l01149"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a89a2d6885b96dd09bab36ccda16a6dce"> 1149</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAC__WPNav.html#a89a2d6885b96dd09bab36ccda16a6dce">AC_WPNav::get_terrain_offset</a>(<span class="keywordtype">float</span>&amp; offset_cm)</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;{</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;<span class="preprocessor">#if AP_TERRAIN_AVAILABLE</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    <span class="comment">// use range finder if connected</span></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#ae14683f14855bb0f7b794f49da0ccd0a">_rangefinder_available</a> &amp;&amp; <a class="code" href="classAC__WPNav.html#adff30a2eb74e9b17040c1398264d324c">_rangefinder_use</a>) {</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a3706d8bb66c86d005c7bc7ddbe6f42c5">_rangefinder_healthy</a>) {</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;            offset_cm = <a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#ac47da3c171cdcaabb4bc3a2749762461">get_altitude</a>() - <a class="code" href="classAC__WPNav.html#a91ab547d049aa41640edca2ad44b60f2">_rangefinder_alt_cm</a>;</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;        }</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;    }</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    <span class="comment">// use terrain database</span></div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;    <span class="keywordtype">float</span> terr_alt = 0.0f;</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAC__WPNav.html#a470012a574b4b6768c9d7904e9438264">_terrain</a> != <span class="keyword">nullptr</span> &amp;&amp; <a class="code" href="classAC__WPNav.html#a470012a574b4b6768c9d7904e9438264">_terrain</a>-&gt;height_above_terrain(terr_alt, <span class="keyword">true</span>)) {</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;        offset_cm = <a class="code" href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">_inav</a>.<a class="code" href="classAP__InertialNav.html#ac47da3c171cdcaabb4bc3a2749762461">get_altitude</a>() - (terr_alt * 100.0f);</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;    }</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;}</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;<span class="comment">// convert location to vector from ekf origin.  terrain_alt is set to true if resulting vector&#39;s z-axis should be treated as alt-above-terrain</span></div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;<span class="comment">//      returns false if conversion failed (likely because terrain data was not available)</span></div><div class="line"><a name="l01174"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a91b8fa0d48a6fb79a4d7ef38dfc11123"> 1174</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAC__WPNav.html#a91b8fa0d48a6fb79a4d7ef38dfc11123">AC_WPNav::get_vector_NEU</a>(<span class="keyword">const</span> <a class="code" href="classLocation__Class.html">Location_Class</a> &amp;loc, <a class="code" href="classVector3.html">Vector3f</a> &amp;vec, <span class="keywordtype">bool</span> &amp;terrain_alt)</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;{</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    <span class="comment">// convert location to NEU vector3f</span></div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    <a class="code" href="classVector3.html">Vector3f</a> res_vec;</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    <span class="keywordflow">if</span> (!loc.<a class="code" href="classLocation__Class.html#a47b0c66dd700f4ea188eb8a58d886e8a">get_vector_xy_from_origin_NEU</a>(res_vec)) {</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    }</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    <span class="comment">// convert altitude</span></div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;    <span class="keywordflow">if</span> (loc.<a class="code" href="classLocation__Class.html#a12eedb8fc1b0f9391bc07891decf95fc">get_alt_frame</a>() == <a class="code" href="classLocation__Class.html#a1031bf89d17b45872147c9ae31ea94b4ae3be3ef31369ccac098e63653eecd4af">Location_Class::ALT_FRAME_ABOVE_TERRAIN</a>) {</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        int32_t terr_alt;</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;        <span class="keywordflow">if</span> (!loc.<a class="code" href="classLocation__Class.html#a94d8de310c8bdf8441c367e90d6b3f90">get_alt_cm</a>(<a class="code" href="classLocation__Class.html#a1031bf89d17b45872147c9ae31ea94b4ae3be3ef31369ccac098e63653eecd4af">Location_Class::ALT_FRAME_ABOVE_TERRAIN</a>, terr_alt)) {</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;        }</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        vec.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> = terr_alt;</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;        terrain_alt = <span class="keyword">true</span>;</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        terrain_alt = <span class="keyword">false</span>;</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        int32_t temp_alt;</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        <span class="keywordflow">if</span> (!loc.<a class="code" href="classLocation__Class.html#a94d8de310c8bdf8441c367e90d6b3f90">get_alt_cm</a>(<a class="code" href="classLocation__Class.html#a1031bf89d17b45872147c9ae31ea94b4a50b327b73c1491bef67e905edc73d929">Location_Class::ALT_FRAME_ABOVE_ORIGIN</a>, temp_alt)) {</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        }</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;        vec.<a class="code" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a> = temp_alt;</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;        terrain_alt = <span class="keyword">false</span>;</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    }</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    <span class="comment">// copy xy (we do this to ensure we do not adjust vector unless the overall conversion is successful</span></div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;    vec.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> = res_vec.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>;</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    vec.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a> = res_vec.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>;</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;}</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;<span class="comment">// get_bearing_cd - return bearing in centi-degrees between two positions</span></div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;<span class="comment">// To-Do: move this to math library</span></div><div class="line"><a name="l01213"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#acdde881fbaae3bc13155a34ee88a6e48"> 1213</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classAC__WPNav.html#acdde881fbaae3bc13155a34ee88a6e48">AC_WPNav::get_bearing_cd</a>(<span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a> &amp;origin, <span class="keyword">const</span> <a class="code" href="classVector3.html">Vector3f</a> &amp;destination)<span class="keyword"> const</span></div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;    <span class="keywordtype">float</span> <a class="code" href="examples_2location_2location_8cpp.html#af6eb7f864211ea48ab64c74d4f69fa41">bearing</a> = 9000 + atan2f(-(destination.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>-origin.<a class="code" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>), destination.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>-origin.<a class="code" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>) * 5729.57795f;</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;    <span class="keywordflow">if</span> (bearing &lt; 0) {</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;        bearing += 36000;</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;    }</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="examples_2location_2location_8cpp.html#af6eb7f864211ea48ab64c74d4f69fa41">bearing</a>;</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;}</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;</div><div class="line"><a name="l01223"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#a4bbed458f180899ecffd17e508ddf408"> 1223</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAC__WPNav.html#a4bbed458f180899ecffd17e508ddf408">AC_WPNav::calc_slow_down_distance</a>(<span class="keywordtype">float</span> speed_cms, <span class="keywordtype">float</span> accel_cmss)</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;{</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;    <span class="comment">// protect against divide by zero</span></div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;    <span class="keywordflow">if</span> (accel_cmss &lt;= 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;        <a class="code" href="classAC__WPNav.html#a0c003971d88dadd9b8101fbf60534280">_slow_down_dist</a> = 0.0f;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    }</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    <span class="comment">// To-Do: should we use a combination of horizontal and vertical speeds?</span></div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;    <span class="comment">// To-Do: update this automatically when speed or acceleration is changed</span></div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    <a class="code" href="classAC__WPNav.html#a0c003971d88dadd9b8101fbf60534280">_slow_down_dist</a> = speed_cms * speed_cms / (4.0f*accel_cmss);</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;}</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;</div><div class="line"><a name="l01236"></a><span class="lineno"><a class="line" href="classAC__WPNav.html#aae13f4e84af1728e5d382a3f97a181db"> 1236</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classAC__WPNav.html#aae13f4e84af1728e5d382a3f97a181db">AC_WPNav::get_slow_down_speed</a>(<span class="keywordtype">float</span> dist_from_dest_cm, <span class="keywordtype">float</span> accel_cmss)</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;{</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    <span class="comment">// return immediately if distance is zero (or less)</span></div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    <span class="keywordflow">if</span> (dist_from_dest_cm &lt;= 0) {</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="AC__WPNav_8h.html#a5bf00641918cf0ac153c0dfb9199d349">WPNAV_WP_TRACK_SPEED_MIN</a>;</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    }</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;    <span class="comment">// calculate desired speed near destination</span></div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;    <span class="keywordtype">float</span> target_speed = <a class="code" href="AP__Math_8cpp.html#ac89eb1832d8e4d67fcf1ac07e3c25184">safe_sqrt</a>(dist_from_dest_cm * 4.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> * accel_cmss);</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    <span class="comment">// ensure desired speed never becomes too low</span></div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    <span class="keywordflow">if</span> (target_speed &lt; <a class="code" href="AC__WPNav_8h.html#a5bf00641918cf0ac153c0dfb9199d349">WPNAV_WP_TRACK_SPEED_MIN</a>) {</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="AC__WPNav_8h.html#a5bf00641918cf0ac153c0dfb9199d349">WPNAV_WP_TRACK_SPEED_MIN</a>;</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;        <span class="keywordflow">return</span> target_speed;</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;    }</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;}</div><div class="ttc" id="classAP__AHRS__View_html"><div class="ttname"><a href="classAP__AHRS__View.html">AP_AHRS_View</a></div><div class="ttdef"><b>Definition:</b> <a href="AP__AHRS__View_8h_source.html#l00025">AP_AHRS_View.h:25</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a3c60c5ddf37a79af9238249a1784dc23"><div class="ttname"><a href="classAC__WPNav.html#a3c60c5ddf37a79af9238249a1784dc23">AC_WPNav::_track_leash_length</a></div><div class="ttdeci">float _track_leash_length</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00348">AC_WPNav.h:348</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a773f0830b9aa2c591f5fb2dd6287997cae87925feecc2a1b521da706d92404e2b"><div class="ttname"><a href="classAC__PosControl.html#a773f0830b9aa2c591f5fb2dd6287997cae87925feecc2a1b521da706d92404e2b">AC_PosControl::XY_MODE_POS_LIMITED_AND_VEL_FF</a></div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00058">AC_PosControl.h:58</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a0ff7209545f3c7169054b2ee79cd4216"><div class="ttname"><a href="classAC__WPNav.html#a0ff7209545f3c7169054b2ee79cd4216">AC_WPNav::set_speed_xy</a></div><div class="ttdeci">void set_speed_xy(float speed_cms)</div><div class="ttdoc">set_speed_xy - allows main code to pass target horizontal velocity for wp navigation ...</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00412">AC_WPNav.cpp:412</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a2ff059085a523215ddb8151c1835d898"><div class="ttname"><a href="classAC__WPNav.html#a2ff059085a523215ddb8151c1835d898">AC_WPNav::get_wp_distance_to_destination</a></div><div class="ttdeci">float get_wp_distance_to_destination() const </div><div class="ttdoc">get_wp_distance_to_destination - get horizontal distance to destination in cm </div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00704">AC_WPNav.cpp:704</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a17bf8df6a841f35e17641984fa46bab0"><div class="ttname"><a href="classAC__WPNav.html#a17bf8df6a841f35e17641984fa46bab0">AC_WPNav::_attitude_control</a></div><div class="ttdeci">const AC_AttitudeControl &amp; _attitude_control</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00316">AC_WPNav.h:316</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a9f10e2f0ea7959fe4f8206cef358e049"><div class="ttname"><a href="classAC__WPNav.html#a9f10e2f0ea7959fe4f8206cef358e049">AC_WPNav::_loiter_jerk_max_cmsss</a></div><div class="ttdeci">AP_Float _loiter_jerk_max_cmsss</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00322">AC_WPNav.h:322</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a508f2bfaf76856a1a6e137cb697fe315"><div class="ttname"><a href="classAC__WPNav.html#a508f2bfaf76856a1a6e137cb697fe315">AC_WPNav::check_wp_leash_length</a></div><div class="ttdeci">void check_wp_leash_length()</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00762">AC_WPNav.cpp:762</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_a4e866b737efa684995b6f4f1fa2cb8d5"><div class="ttname"><a href="AC__WPNav_8h.html#a4e866b737efa684995b6f4f1fa2cb8d5">WPNAV_LOITER_SPEED</a></div><div class="ttdeci">#define WPNAV_LOITER_SPEED</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00017">AC_WPNav.h:17</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_a5bf00641918cf0ac153c0dfb9199d349"><div class="ttname"><a href="AC__WPNav_8h.html#a5bf00641918cf0ac153c0dfb9199d349">WPNAV_WP_TRACK_SPEED_MIN</a></div><div class="ttdeci">#define WPNAV_WP_TRACK_SPEED_MIN</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00025">AC_WPNav.h:25</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a86db328ce60f79e07a417e55bb5deb5f"><div class="ttname"><a href="classAC__PosControl.html#a86db328ce60f79e07a417e55bb5deb5f">AC_PosControl::set_desired_velocity_xy</a></div><div class="ttdeci">void set_desired_velocity_xy(float vel_lat_cms, float vel_lon_cms)</div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00226">AC_PosControl.h:226</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a89a2d6885b96dd09bab36ccda16a6dce"><div class="ttname"><a href="classAC__WPNav.html#a89a2d6885b96dd09bab36ccda16a6dce">AC_WPNav::get_terrain_offset</a></div><div class="ttdeci">bool get_terrain_offset(float &amp;offset_cm)</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l01149">AC_WPNav.cpp:1149</a></div></div>
<div class="ttc" id="classLocation__Class_html_a1031bf89d17b45872147c9ae31ea94b4a50b327b73c1491bef67e905edc73d929"><div class="ttname"><a href="classLocation__Class.html#a1031bf89d17b45872147c9ae31ea94b4a50b327b73c1491bef67e905edc73d929">Location_Class::ALT_FRAME_ABOVE_ORIGIN</a></div><div class="ttdef"><b>Definition:</b> <a href="Location_8h_source.html#l00025">Location.h:25</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a90638ba01c06cdbef93d21e7c8877770"><div class="ttname"><a href="classAC__WPNav.html#a90638ba01c06cdbef93d21e7c8877770">AC_WPNav::_wp_radius_cm</a></div><div class="ttdeci">AP_Float _wp_radius_cm</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00328">AC_WPNav.h:328</a></div></div>
<div class="ttc" id="vector3_8h_html_af345ad77ba5e240c7ab72b4b2077e754"><div class="ttname"><a href="vector3_8h.html#af345ad77ba5e240c7ab72b4b2077e754">Vector3f</a></div><div class="ttdeci">Vector3&lt; float &gt; Vector3f</div><div class="ttdef"><b>Definition:</b> <a href="vector3_8h_source.html#l00235">vector3.h:235</a></div></div>
<div class="ttc" id="classAC__WPNav_html_aae13f4e84af1728e5d382a3f97a181db"><div class="ttname"><a href="classAC__WPNav.html#aae13f4e84af1728e5d382a3f97a181db">AC_WPNav::get_slow_down_speed</a></div><div class="ttdeci">float get_slow_down_speed(float dist_from_dest_cm, float accel_cmss)</div><div class="ttdoc">get_slow_down_speed - returns target speed of target point based on distance from the destination (in...</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l01236">AC_WPNav.cpp:1236</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a6b3617b946ffd6935c11a63629f186ec"><div class="ttname"><a href="classAC__PosControl.html#a6b3617b946ffd6935c11a63629f186ec">AC_PosControl::get_pos_target</a></div><div class="ttdeci">const Vector3f &amp; get_pos_target() const </div><div class="ttdoc">get_pos_target - get target as position vector (from home in cm) </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00206">AC_PosControl.h:206</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a4bbed458f180899ecffd17e508ddf408"><div class="ttname"><a href="classAC__WPNav.html#a4bbed458f180899ecffd17e508ddf408">AC_WPNav::calc_slow_down_distance</a></div><div class="ttdeci">void calc_slow_down_distance(float speed_cms, float accel_cmss)</div><div class="ttdoc">calc_slow_down_distance - calculates distance before waypoint that target point should begin to slow-...</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l01223">AC_WPNav.cpp:1223</a></div></div>
<div class="ttc" id="classAP__InertialNav_html_a39348dd51a8c32fe16d01dfef284e31a"><div class="ttname"><a href="classAP__InertialNav.html#a39348dd51a8c32fe16d01dfef284e31a">AP_InertialNav::get_position</a></div><div class="ttdeci">virtual const Vector3f &amp; get_position() const =0</div></div>
<div class="ttc" id="AP__Math_8h_html_a5c0b5c82749ac54970b2699d3c10ee9b"><div class="ttname"><a href="AP__Math_8h.html#a5c0b5c82749ac54970b2699d3c10ee9b">MAX</a></div><div class="ttdeci">static auto MAX(const A &amp;one, const B &amp;two) -&gt; decltype(one &gt; two?one:two)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00179">AP_Math.h:179</a></div></div>
<div class="ttc" id="AP__Math_8cpp_html_ac89eb1832d8e4d67fcf1ac07e3c25184"><div class="ttname"><a href="AP__Math_8cpp.html#ac89eb1832d8e4d67fcf1ac07e3c25184">safe_sqrt</a></div><div class="ttdeci">float safe_sqrt(const T v)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8cpp_source.html#l00061">AP_Math.cpp:61</a></div></div>
<div class="ttc" id="classAC__WPNav_html_aeff9bc9c5ec596b91408145d615b236f"><div class="ttname"><a href="classAC__WPNav.html#aeff9bc9c5ec596b91408145d615b236f">AC_WPNav::init_loiter_target</a></div><div class="ttdeci">void init_loiter_target()</div><div class="ttdoc">init_loiter_target - initialize&amp;#39;s loiter position and feed-forward velocity from current pos and velo...</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00179">AC_WPNav.cpp:179</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a5d54686767fb1e5c60c8826160e8ac14"><div class="ttname"><a href="classAC__WPNav.html#a5d54686767fb1e5c60c8826160e8ac14">AC_WPNav::_origin</a></div><div class="ttdeci">Vector3f _origin</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00340">AC_WPNav.h:340</a></div></div>
<div class="ttc" id="classAC__WPNav_html_ae1e4c1e17634f9e8a672b4ed47b76ad8"><div class="ttname"><a href="classAC__WPNav.html#ae1e4c1e17634f9e8a672b4ed47b76ad8">AC_WPNav::_yaw</a></div><div class="ttdeci">float _yaw</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00358">AC_WPNav.h:358</a></div></div>
<div class="ttc" id="classAC__AttitudeControl_html_a080c9527e2d43eac62e370fbe61eaa8d"><div class="ttname"><a href="classAC__AttitudeControl.html#a080c9527e2d43eac62e370fbe61eaa8d">AC_AttitudeControl::lean_angle_max</a></div><div class="ttdeci">float lean_angle_max() const </div><div class="ttdef"><b>Definition:</b> <a href="AC__AttitudeControl_8h_source.html#l00214">AC_AttitudeControl.h:214</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a8dbe5714a3adf0eae1d7dbc6fa738261"><div class="ttname"><a href="classAC__WPNav.html#a8dbe5714a3adf0eae1d7dbc6fa738261">AC_WPNav::spline_segment_end_type</a></div><div class="ttdeci">spline_segment_end_type</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00050">AC_WPNav.h:50</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a1e86d7323e71ffd290bc399e7951f17e"><div class="ttname"><a href="classAC__WPNav.html#a1e86d7323e71ffd290bc399e7951f17e">AC_WPNav::_pos_delta_unit</a></div><div class="ttdeci">Vector3f _pos_delta_unit</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00342">AC_WPNav.h:342</a></div></div>
<div class="ttc" id="AP__HAL_8h_html"><div class="ttname"><a href="AP__HAL_8h.html">AP_HAL.h</a></div></div>
<div class="ttc" id="classAC__WPNav_html_ae70c4ac2dd6a1f567225bc9f430ba1cd"><div class="ttname"><a href="classAC__WPNav.html#ae70c4ac2dd6a1f567225bc9f430ba1cd">AC_WPNav::_spline_origin_vel</a></div><div class="ttdeci">Vector3f _spline_origin_vel</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00354">AC_WPNav.h:354</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a9f9b2b3b12fabb2f5b8026018e562d69"><div class="ttname"><a href="classAC__WPNav.html#a9f9b2b3b12fabb2f5b8026018e562d69">AC_WPNav::set_spline_destination</a></div><div class="ttdeci">bool set_spline_destination(const Location_Class &amp;destination, bool stopped_at_start, spline_segment_end_type seg_end_type, Location_Class next_destination)</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00822">AC_WPNav.cpp:822</a></div></div>
<div class="ttc" id="classAC__Avoid_html_abee541d127ce0da1fe6be54f987a0779"><div class="ttname"><a href="classAC__Avoid.html#abee541d127ce0da1fe6be54f987a0779">AC_Avoid::adjust_velocity</a></div><div class="ttdeci">void adjust_velocity(float kP, float accel_cmss, Vector2f &amp;desired_vel)</div><div class="ttdef"><b>Definition:</b> <a href="AC__Avoid_8cpp_source.html#l00041">AC_Avoid.cpp:41</a></div></div>
<div class="ttc" id="classAC__WPNav_html_acaa26f2ac17e44be2ddac9d0d04bb542"><div class="ttname"><a href="classAC__WPNav.html#acaa26f2ac17e44be2ddac9d0d04bb542">AC_WPNav::AC_WPNav</a></div><div class="ttdeci">AC_WPNav(const AP_InertialNav &amp;inav, const AP_AHRS_View &amp;ahrs, AC_PosControl &amp;pos_control, const AC_AttitudeControl &amp;attitude_control)</div><div class="ttdoc">Constructor. </div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00113">AC_WPNav.cpp:113</a></div></div>
<div class="ttc" id="classAC__WPNav_html_ae14683f14855bb0f7b794f49da0ccd0a"><div class="ttname"><a href="classAC__WPNav.html#ae14683f14855bb0f7b794f49da0ccd0a">AC_WPNav::_rangefinder_available</a></div><div class="ttdeci">bool _rangefinder_available</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00363">AC_WPNav.h:363</a></div></div>
<div class="ttc" id="classAC__WPNav_html_acdde881fbaae3bc13155a34ee88a6e48"><div class="ttname"><a href="classAC__WPNav.html#acdde881fbaae3bc13155a34ee88a6e48">AC_WPNav::get_bearing_cd</a></div><div class="ttdeci">float get_bearing_cd(const Vector3f &amp;origin, const Vector3f &amp;destination) const </div><div class="ttdoc">get_bearing_cd - return bearing in centi-degrees between two positions </div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l01213">AC_WPNav.cpp:1213</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a6a6bf7982d149c080ac9eea9db215759"><div class="ttname"><a href="classAC__WPNav.html#a6a6bf7982d149c080ac9eea9db215759">AC_WPNav::_spline_vel_scaler</a></div><div class="ttdeci">float _spline_vel_scaler</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00357">AC_WPNav.h:357</a></div></div>
<div class="ttc" id="structVector2_html_ad8ebafde96f43521d3647e2552387529"><div class="ttname"><a href="structVector2.html#ad8ebafde96f43521d3647e2552387529">Vector2::length</a></div><div class="ttdeci">float length(void) const </div><div class="ttdef"><b>Definition:</b> <a href="vector2_8cpp_source.html#l00024">vector2.cpp:24</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a3bd02c16cf547cd92584d908f65ccb50"><div class="ttname"><a href="classAC__WPNav.html#a3bd02c16cf547cd92584d908f65ccb50">AC_WPNav::calc_spline_pos_vel</a></div><div class="ttdeci">void calc_spline_pos_vel(float spline_time, Vector3f &amp;position, Vector3f &amp;velocity)</div><div class="ttdoc">relies on update_spline_solution being called when the segment&amp;#39;s origin and destination were set ...</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l01133">AC_WPNav.cpp:1133</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_aafb7b61646d88418a26f138e458ad358"><div class="ttname"><a href="AC__WPNav_8h.html#aafb7b61646d88418a26f138e458ad358">WPNAV_WP_SPEED_MIN</a></div><div class="ttdeci">#define WPNAV_WP_SPEED_MIN</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00024">AC_WPNav.h:24</a></div></div>
<div class="ttc" id="classAC__WPNav_html_acc138e7bc6435087ab308896358de6a3"><div class="ttname"><a href="classAC__WPNav.html#acc138e7bc6435087ab308896358de6a3">AC_WPNav::update_spline</a></div><div class="ttdeci">bool update_spline()</div><div class="ttdoc">update_spline - update spline controller </div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00993">AC_WPNav.cpp:993</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a8dbe5714a3adf0eae1d7dbc6fa738261a812f74d3d4b71e281c642c6f07d5457c"><div class="ttname"><a href="classAC__WPNav.html#a8dbe5714a3adf0eae1d7dbc6fa738261a812f74d3d4b71e281c642c6f07d5457c">AC_WPNav::SEGMENT_END_STRAIGHT</a></div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00052">AC_WPNav.h:52</a></div></div>
<div class="ttc" id="classAC__PosControl_html_aba69e5af4db360bb85275fe843f7e95e"><div class="ttname"><a href="classAC__PosControl.html#aba69e5af4db360bb85275fe843f7e95e">AC_PosControl::time_since_last_xy_update</a></div><div class="ttdeci">float time_since_last_xy_update() const </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00690">AC_PosControl.cpp:690</a></div></div>
<div class="ttc" id="AP__Param_8h_html_a78a408c84f2a1bafde256ac650142e4d"><div class="ttname"><a href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a></div><div class="ttdeci">#define AP_GROUPINFO(name, idx, clazz, element, def)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Param_8h_source.html#l00087">AP_Param.h:87</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a497c1799c10d146b6f2e2b542889c083"><div class="ttname"><a href="classAC__PosControl.html#a497c1799c10d146b6f2e2b542889c083">AC_PosControl::update_xy_controller</a></div><div class="ttdeci">void update_xy_controller(xy_mode mode, float ekfNavVelGainScaler, bool use_althold_lean_angle)</div><div class="ttdoc">update_xy_controller - run the horizontal position controller - should be called at 100hz or higher ...</div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00659">AC_PosControl.cpp:659</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a9b3fd8fd5c74d31ebffa89cdf98f570a"><div class="ttname"><a href="classAC__WPNav.html#a9b3fd8fd5c74d31ebffa89cdf98f570a">AC_WPNav::loiter_soften_for_landing</a></div><div class="ttdeci">void loiter_soften_for_landing()</div><div class="ttdoc">loiter_soften_for_landing - reduce response for landing </div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00211">AC_WPNav.cpp:211</a></div></div>
<div class="ttc" id="classAC__WPNav_html_ada03f68aff5eac18bfe30935dbeb7857"><div class="ttname"><a href="classAC__WPNav.html#ada03f68aff5eac18bfe30935dbeb7857">AC_WPNav::_limited_speed_xy_cms</a></div><div class="ttdeci">float _limited_speed_xy_cms</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00345">AC_WPNav.h:345</a></div></div>
<div class="ttc" id="classAC__WPNav_html_aa1a3da70925cc9327222d2923807ec21"><div class="ttname"><a href="classAC__WPNav.html#aa1a3da70925cc9327222d2923807ec21">AC_WPNav::advance_spline_target_along_track</a></div><div class="ttdeci">bool advance_spline_target_along_track(float dt)</div><div class="ttdoc">advance_spline_target_along_track - move target location along track from origin to destination ...</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l01043">AC_WPNav.cpp:1043</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a75b14352ec1c95a8276af9a0813cfdc3"><div class="ttname"><a href="AP__Math_8h.html#a75b14352ec1c95a8276af9a0813cfdc3">radians</a></div><div class="ttdeci">static float radians(float deg)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00135">AP_Math.h:135</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a8821ae5e4e14b610f8c24f4d0bdc64d6"><div class="ttname"><a href="classAC__WPNav.html#a8821ae5e4e14b610f8c24f4d0bdc64d6">AC_WPNav::set_pilot_desired_acceleration</a></div><div class="ttdeci">void set_pilot_desired_acceleration(float control_roll, float control_pitch)</div><div class="ttdoc">set_pilot_desired_acceleration - sets pilot desired acceleration from roll and pitch stick input ...</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00221">AC_WPNav.cpp:221</a></div></div>
<div class="ttc" id="classAC__WPNav_html"><div class="ttname"><a href="classAC__WPNav.html">AC_WPNav</a></div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00045">AC_WPNav.h:45</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a84657e792587890796f5131ca77e7819"><div class="ttname"><a href="classAC__WPNav.html#a84657e792587890796f5131ca77e7819">AC_WPNav::_spline_time_scale</a></div><div class="ttdeci">float _spline_time_scale</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00353">AC_WPNav.h:353</a></div></div>
<div class="ttc" id="classLocation__Class_html_a94d8de310c8bdf8441c367e90d6b3f90"><div class="ttname"><a href="classLocation__Class.html#a94d8de310c8bdf8441c367e90d6b3f90">Location_Class::get_alt_cm</a></div><div class="ttdeci">bool get_alt_cm(ALT_FRAME desired_frame, int32_t &amp;ret_alt_cm) const </div><div class="ttdoc">get altitude in desired frame </div><div class="ttdef"><b>Definition:</b> <a href="Location_8cpp_source.html#l00115">Location.cpp:115</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_ab26b1996242bdebba7fee78f241f52c3"><div class="ttname"><a href="AC__WPNav_8h.html#ab26b1996242bdebba7fee78f241f52c3">WPNAV_WP_ACCEL_Z_DEFAULT</a></div><div class="ttdeci">#define WPNAV_WP_ACCEL_Z_DEFAULT</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00031">AC_WPNav.h:31</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_a27f238a17bad0c20692630a6173e888f"><div class="ttname"><a href="AC__WPNav_8h.html#a27f238a17bad0c20692630a6173e888f">WPNAV_LOITER_SPEED_MIN</a></div><div class="ttdeci">#define WPNAV_LOITER_SPEED_MIN</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00018">AC_WPNav.h:18</a></div></div>
<div class="ttc" id="classAC__PosControl_html_adfe1243326de1130e9a5a7d031c00ebb"><div class="ttname"><a href="classAC__PosControl.html#adfe1243326de1130e9a5a7d031c00ebb">AC_PosControl::set_jerk_xy</a></div><div class="ttdeci">void set_jerk_xy(float jerk_cmsss)</div><div class="ttdoc">set_jerk_xy - set max horizontal jerk in cm/s/s/s </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00194">AC_PosControl.h:194</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a14948dc8bc1df3823bd6ccfa22122dfa"><div class="ttname"><a href="classAC__WPNav.html#a14948dc8bc1df3823bd6ccfa22122dfa">AC_WPNav::_inav</a></div><div class="ttdeci">const AP_InertialNav &amp; _inav</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00313">AC_WPNav.h:313</a></div></div>
<div class="ttc" id="classAC__PosControl_html_ab17ea3a4f6f232c9944712b39e76aac8"><div class="ttname"><a href="classAC__PosControl.html#ab17ea3a4f6f232c9944712b39e76aac8">AC_PosControl::get_leash_up_z</a></div><div class="ttdeci">float get_leash_up_z() const </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00168">AC_PosControl.h:168</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a96d87c601aa6866bd9a743d024a08c51"><div class="ttname"><a href="classAC__PosControl.html#a96d87c601aa6866bd9a743d024a08c51">AC_PosControl::get_pos_xy_kP</a></div><div class="ttdeci">float get_pos_xy_kP() const </div><div class="ttdoc">get_pos_xy_kP - returns xy position controller&amp;#39;s kP gain </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00280">AC_PosControl.h:280</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_a490177d11b3e775c323cff9462edf5c7"><div class="ttname"><a href="AC__WPNav_8h.html#a490177d11b3e775c323cff9462edf5c7">WPNAV_YAW_DIST_MIN</a></div><div class="ttdeci">#define WPNAV_YAW_DIST_MIN</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00041">AC_WPNav.h:41</a></div></div>
<div class="ttc" id="classAP__InertialNav_html"><div class="ttname"><a href="classAP__InertialNav.html">AP_InertialNav</a></div><div class="ttdef"><b>Definition:</b> <a href="AP__InertialNav_8h_source.html#l00023">AP_InertialNav.h:23</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a3a665f936634a13be4e8382b7924039f"><div class="ttname"><a href="classAC__WPNav.html#a3a665f936634a13be4e8382b7924039f">AC_WPNav::_track_accel</a></div><div class="ttdeci">float _track_accel</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00346">AC_WPNav.h:346</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_a3e1d84c583fbfe3086e10b3006a64447"><div class="ttname"><a href="AC__WPNav_8h.html#a3e1d84c583fbfe3086e10b3006a64447">WPNAV_LEASH_LENGTH_MIN</a></div><div class="ttdeci">#define WPNAV_LEASH_LENGTH_MIN</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00033">AC_WPNav.h:33</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a2ed86e41fc51c2ea822711ea95d055f0"><div class="ttname"><a href="classAC__WPNav.html#a2ed86e41fc51c2ea822711ea95d055f0">AC_WPNav::init_brake_target</a></div><div class="ttdeci">void init_brake_target(float accel_cmss)</div><div class="ttdoc">init_brake_target - initializes stop position from current position and velocity </div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00341">AC_WPNav.cpp:341</a></div></div>
<div class="ttc" id="ModuleTest_8cpp_html_a0a15280249072432f8c559cc00d09dee"><div class="ttname"><a href="ModuleTest_8cpp.html#a0a15280249072432f8c559cc00d09dee">ahrs</a></div><div class="ttdeci">AP_AHRS_DCM ahrs(ins, baro, gps)</div></div>
<div class="ttc" id="classAC__WPNav_html_a44623f917d318231b8468c35aae93ab5"><div class="ttname"><a href="classAC__WPNav.html#a44623f917d318231b8468c35aae93ab5">AC_WPNav::_spline_destination_vel</a></div><div class="ttdeci">Vector3f _spline_destination_vel</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00355">AC_WPNav.h:355</a></div></div>
<div class="ttc" id="classAC__AttitudeControl_html_aec35222c9dee5999aaf029484ea356c9"><div class="ttname"><a href="classAC__AttitudeControl.html#aec35222c9dee5999aaf029484ea356c9">AC_AttitudeControl::get_att_target_euler_cd</a></div><div class="ttdeci">Vector3f get_att_target_euler_cd() const </div><div class="ttdef"><b>Definition:</b> <a href="AC__AttitudeControl_8h_source.html#l00148">AC_AttitudeControl.h:148</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a455f7b1102bc8e80f18ff80dc415d06d"><div class="ttname"><a href="classAC__WPNav.html#a455f7b1102bc8e80f18ff80dc415d06d">AC_WPNav::update_spline_solution</a></div><div class="ttdeci">void update_spline_solution(const Vector3f &amp;origin, const Vector3f &amp;dest, const Vector3f &amp;origin_vel, const Vector3f &amp;dest_vel)</div><div class="ttdoc">spline protected functions </div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l01034">AC_WPNav.cpp:1034</a></div></div>
<div class="ttc" id="classAC__PosControl_html_ac150947d527995a72dff6ad0921a1891"><div class="ttname"><a href="classAC__PosControl.html#ac150947d527995a72dff6ad0921a1891">AC_PosControl::freeze_ff_xy</a></div><div class="ttdeci">void freeze_ff_xy()</div><div class="ttdoc">freeze_ff_xy - used to stop the feed forward being calculated during a known discontinuity ...</div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00239">AC_PosControl.h:239</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a7e131ba7b7deffa86cbf343c495bdf4e"><div class="ttname"><a href="classAC__WPNav.html#a7e131ba7b7deffa86cbf343c495bdf4e">AC_WPNav::set_wp_destination</a></div><div class="ttdeci">bool set_wp_destination(const Location_Class &amp;destination)</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00425">AC_WPNav.cpp:425</a></div></div>
<div class="ttc" id="structAC__WPNav_1_1wpnav__flags_html_ab897171ec9375958f7305e81feedf201"><div class="ttname"><a href="structAC__WPNav_1_1wpnav__flags.html#ab897171ec9375958f7305e81feedf201">AC_WPNav::wpnav_flags::slowing_down</a></div><div class="ttdeci">uint8_t slowing_down</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00276">AC_WPNav.h:276</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_a299b77621fbad732495365c3d7ba70c2"><div class="ttname"><a href="AC__WPNav_8h.html#a299b77621fbad732495365c3d7ba70c2">WPNAV_WP_RADIUS</a></div><div class="ttdeci">#define WPNAV_WP_RADIUS</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00026">AC_WPNav.h:26</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a773f0830b9aa2c591f5fb2dd6287997ca73eb55dccf01566a1d4d3834572eefaa"><div class="ttname"><a href="classAC__PosControl.html#a773f0830b9aa2c591f5fb2dd6287997ca73eb55dccf01566a1d4d3834572eefaa">AC_PosControl::XY_MODE_POS_ONLY</a></div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00057">AC_PosControl.h:57</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a1acdd0aec3b36ec2fad0b05cbca0c252"><div class="ttname"><a href="classAC__PosControl.html#a1acdd0aec3b36ec2fad0b05cbca0c252">AC_PosControl::set_xy_target</a></div><div class="ttdeci">void set_xy_target(float x, float y)</div><div class="ttdoc">set_xy_target in cm from home </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00543">AC_PosControl.cpp:543</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a3af4062bf565318b87f922ff2ae613d0"><div class="ttname"><a href="classAC__WPNav.html#a3af4062bf565318b87f922ff2ae613d0">AC_WPNav::_avoid</a></div><div class="ttdeci">AC_Avoid * _avoid</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00318">AC_WPNav.h:318</a></div></div>
<div class="ttc" id="definitions_8h_html_a96799f9de58a211f6b3bdc96c6e10669"><div class="ttname"><a href="definitions_8h.html#a96799f9de58a211f6b3bdc96c6e10669">RadiansToCentiDegrees</a></div><div class="ttdeci">#define RadiansToCentiDegrees(x)</div><div class="ttdef"><b>Definition:</b> <a href="definitions_8h_source.html#l00039">definitions.h:39</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a2b0f45cd553e217e5ee44dfef68a674c"><div class="ttname"><a href="classAC__WPNav.html#a2b0f45cd553e217e5ee44dfef68a674c">AC_WPNav::get_loiter_stopping_point_xy</a></div><div class="ttdeci">void get_loiter_stopping_point_xy(Vector3f &amp;stopping_point) const </div><div class="ttdoc">get_stopping_point - returns vector to stopping point based on a horizontal position and velocity ...</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00229">AC_WPNav.cpp:229</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html"><div class="ttname"><a href="AC__WPNav_8h.html">AC_WPNav.h</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a8dbe5714a3adf0eae1d7dbc6fa738261a7c9cfa20d19d3f51696b1fc8c991a2dd"><div class="ttname"><a href="classAC__WPNav.html#a8dbe5714a3adf0eae1d7dbc6fa738261a7c9cfa20d19d3f51696b1fc8c991a2dd">AC_WPNav::SEGMENT_END_STOP</a></div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00051">AC_WPNav.h:51</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_a0ce9619627236f61455e98b7cdfc0d9d"><div class="ttname"><a href="AC__WPNav_8h.html#a0ce9619627236f61455e98b7cdfc0d9d">WPNAV_WP_FAST_OVERSHOOT_MAX</a></div><div class="ttdeci">#define WPNAV_WP_FAST_OVERSHOOT_MAX</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00035">AC_WPNav.h:35</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a0e91b64e0b97a76cbe20478ac438ab1b"><div class="ttname"><a href="classAC__WPNav.html#a0e91b64e0b97a76cbe20478ac438ab1b">AC_WPNav::set_spline_origin_and_destination</a></div><div class="ttdeci">bool set_spline_origin_and_destination(const Vector3f &amp;origin, const Vector3f &amp;destination, bool terrain_alt, bool stopped_at_start, spline_segment_end_type seg_end_type, const Vector3f &amp;next_destination)</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00882">AC_WPNav.cpp:882</a></div></div>
<div class="ttc" id="structVector2_html_a6cfed8355591aa269f4dba43bd806ef9"><div class="ttname"><a href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">Vector2::y</a></div><div class="ttdeci">T y</div><div class="ttdef"><b>Definition:</b> <a href="vector2_8h_source.html#l00037">vector2.h:37</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a7dc4785fbce8364d7eb3d8e2d0c1b987"><div class="ttname"><a href="classAC__WPNav.html#a7dc4785fbce8364d7eb3d8e2d0c1b987">AC_WPNav::update_wpnav</a></div><div class="ttdeci">bool update_wpnav()</div><div class="ttdoc">update_wpnav - run the wp controller - should be called at 100hz or higher </div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00718">AC_WPNav.cpp:718</a></div></div>
<div class="ttc" id="classAC__WPNav_html_ae2eba98522934eaa1968e99ecfa91d93"><div class="ttname"><a href="classAC__WPNav.html#ae2eba98522934eaa1968e99ecfa91d93">AC_WPNav::_destination</a></div><div class="ttdeci">Vector3f _destination</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00341">AC_WPNav.h:341</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a981d111207940127f931ac397b14b660"><div class="ttname"><a href="classAC__WPNav.html#a981d111207940127f931ac397b14b660">AC_WPNav::_wp_accel_cms</a></div><div class="ttdeci">AP_Float _wp_accel_cms</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00329">AC_WPNav.h:329</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a96906c90e74171ac3fec93c512926207"><div class="ttname"><a href="classAC__PosControl.html#a96906c90e74171ac3fec93c512926207">AC_PosControl::get_vel_target</a></div><div class="ttdeci">const Vector3f &amp; get_vel_target() const </div><div class="ttdoc">accessors for reporting </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00283">AC_PosControl.h:283</a></div></div>
<div class="ttc" id="classAC__WPNav_html_ae16c00c6b3774caf40ae1b3820f95496"><div class="ttname"><a href="classAC__WPNav.html#ae16c00c6b3774caf40ae1b3820f95496">AC_WPNav::_track_length</a></div><div class="ttdeci">float _track_length</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00343">AC_WPNav.h:343</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a6341785a5caab8c9addb607d93fb0299"><div class="ttname"><a href="classAC__WPNav.html#a6341785a5caab8c9addb607d93fb0299">AC_WPNav::_wp_speed_cms</a></div><div class="ttdeci">AP_Float _wp_speed_cms</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00325">AC_WPNav.h:325</a></div></div>
<div class="ttc" id="classAP__HAL_1_1HAL_html"><div class="ttname"><a href="classAP__HAL_1_1HAL.html">AP_HAL::HAL</a></div><div class="ttdef"><b>Definition:</b> <a href="HAL_8h_source.html#l00018">HAL.h:18</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a99c2bd62c329b3ff1a40a55c789070c3"><div class="ttname"><a href="classAC__WPNav.html#a99c2bd62c329b3ff1a40a55c789070c3">AC_WPNav::_track_desired</a></div><div class="ttdeci">float _track_desired</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00344">AC_WPNav.h:344</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a40589bfae2c593c46a05e53601954311abc642b8549e3cea95beb0cfddc21954c"><div class="ttname"><a href="classAC__WPNav.html#a40589bfae2c593c46a05e53601954311abc642b8549e3cea95beb0cfddc21954c">AC_WPNav::SEGMENT_SPLINE</a></div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00269">AC_WPNav.h:269</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a2016e7949dc1d451bdfd72285ea38cec"><div class="ttname"><a href="classAC__WPNav.html#a2016e7949dc1d451bdfd72285ea38cec">AC_WPNav::var_info</a></div><div class="ttdeci">static const struct AP_Param::GroupInfo var_info[]</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00262">AC_WPNav.h:262</a></div></div>
<div class="ttc" id="classAP__AHRS__View_html_a5cba0e970b7df616645025113e75ee41"><div class="ttname"><a href="classAP__AHRS__View.html#a5cba0e970b7df616645025113e75ee41">AP_AHRS_View::sin_yaw</a></div><div class="ttdeci">float sin_yaw</div><div class="ttdef"><b>Definition:</b> <a href="AP__AHRS__View_8h_source.html#l00181">AP_AHRS_View.h:181</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a2a12cce483e9b870da70d30406d82c60"><div class="ttname"><a href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a></div><div class="ttdeci">bool is_zero(const T fVal1)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00039">AP_Math.h:39</a></div></div>
<div class="ttc" id="DerivativeFilter_8cpp_html_a357394e0f6f88c8a57bd893ab28dc8f8"><div class="ttname"><a href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a></div><div class="ttdeci">#define f(i)</div></div>
<div class="ttc" id="structVector2_html"><div class="ttname"><a href="structVector2.html">Vector2&lt; float &gt;</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a00c096173bddaaf24655ef9f43e9eae9"><div class="ttname"><a href="classAC__WPNav.html#a00c096173bddaaf24655ef9f43e9eae9">AC_WPNav::_loiter_accel_cmss</a></div><div class="ttdeci">AP_Float _loiter_accel_cmss</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00323">AC_WPNav.h:323</a></div></div>
<div class="ttc" id="classAC__PosControl_html_ae1676c283b03793693b7c94cecdcd0b2"><div class="ttname"><a href="classAC__PosControl.html#ae1676c283b03793693b7c94cecdcd0b2">AC_PosControl::init_xy_controller</a></div><div class="ttdeci">void init_xy_controller(bool reset_I=true)</div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00636">AC_PosControl.cpp:636</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_a64569eb424dab8704616603a54f01ca4"><div class="ttname"><a href="AC__WPNav_8h.html#a64569eb424dab8704616603a54f01ca4">WPNAV_LOITER_ACCEL_MIN</a></div><div class="ttdeci">#define WPNAV_LOITER_ACCEL_MIN</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00020">AC_WPNav.h:20</a></div></div>
<div class="ttc" id="classVector3_html_a561df88b28e106e337a25bb86554a569"><div class="ttname"><a href="classVector3.html#a561df88b28e106e337a25bb86554a569">Vector3::y</a></div><div class="ttdeci">T y</div><div class="ttdef"><b>Definition:</b> <a href="vector3_8h_source.html#l00067">vector3.h:67</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a4d39e0c0d33f5f6ca20461ad64982e8f"><div class="ttname"><a href="classAC__PosControl.html#a4d39e0c0d33f5f6ca20461ad64982e8f">AC_PosControl::set_speed_z</a></div><div class="ttdeci">void set_speed_z(float speed_down, float speed_up)</div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00107">AC_PosControl.cpp:107</a></div></div>
<div class="ttc" id="namespaceAP__HAL_html_a77dffbb18891996280308e21316ec186"><div class="ttname"><a href="namespaceAP__HAL.html#a77dffbb18891996280308e21316ec186">AP_HAL::millis</a></div><div class="ttdeci">uint32_t millis()</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__Linux_2system_8cpp_source.html#l00043">system.cpp:43</a></div></div>
<div class="ttc" id="examples_2location_2location_8cpp_html_af6eb7f864211ea48ab64c74d4f69fa41"><div class="ttname"><a href="examples_2location_2location_8cpp.html#af6eb7f864211ea48ab64c74d4f69fa41">bearing</a></div><div class="ttdeci">float bearing</div><div class="ttdef"><b>Definition:</b> <a href="examples_2location_2location_8cpp_source.html#l00089">location.cpp:89</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a20ac6348cbb9a1ac803c626c91ec93e5"><div class="ttname"><a href="classAC__PosControl.html#a20ac6348cbb9a1ac803c626c91ec93e5">AC_PosControl::get_stopping_point_z</a></div><div class="ttdeci">void get_stopping_point_z(Vector3f &amp;stopping_point) const </div><div class="ttdoc">get_stopping_point_z - calculates stopping point based on current position, velocity, vehicle acceleration </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00260">AC_PosControl.cpp:260</a></div></div>
<div class="ttc" id="classAC__PosControl_html_acac2980eb3698791d55ca8fa260ab5af"><div class="ttname"><a href="classAC__PosControl.html#acac2980eb3698791d55ca8fa260ab5af">AC_PosControl::calc_leash_length_z</a></div><div class="ttdeci">void calc_leash_length_z()</div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00345">AC_PosControl.cpp:345</a></div></div>
<div class="ttc" id="classVector3_html_ab3e7f5401dd6e951978bfa746809f74f"><div class="ttname"><a href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">Vector3::z</a></div><div class="ttdeci">T z</div><div class="ttdef"><b>Definition:</b> <a href="vector3_8h_source.html#l00067">vector3.h:67</a></div></div>
<div class="ttc" id="structAC__WPNav_1_1wpnav__flags_html_af5ad1453ba2999e97f239a1ee99d1ec1"><div class="ttname"><a href="structAC__WPNav_1_1wpnav__flags.html#af5ad1453ba2999e97f239a1ee99d1ec1">AC_WPNav::wpnav_flags::reached_destination</a></div><div class="ttdeci">uint8_t reached_destination</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00274">AC_WPNav.h:274</a></div></div>
<div class="ttc" id="structAP__Param_1_1GroupInfo_html"><div class="ttname"><a href="structAP__Param_1_1GroupInfo.html">AP_Param::GroupInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="AP__Param_8h_source.html#l00126">AP_Param.h:126</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a4b59ba145a08beb8fe568c997908e34d"><div class="ttname"><a href="classAC__WPNav.html#a4b59ba145a08beb8fe568c997908e34d">AC_WPNav::_wp_accel_z_cms</a></div><div class="ttdeci">AP_Float _wp_accel_z_cms</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00330">AC_WPNav.h:330</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_ab7e7ba5b4c350908eb8e2f50674f81b7"><div class="ttname"><a href="AC__WPNav_8h.html#ab7e7ba5b4c350908eb8e2f50674f81b7">WPNAV_WP_SPEED_UP</a></div><div class="ttdeci">#define WPNAV_WP_SPEED_UP</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00028">AC_WPNav.h:28</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a91b8fa0d48a6fb79a4d7ef38dfc11123"><div class="ttname"><a href="classAC__WPNav.html#a91b8fa0d48a6fb79a4d7ef38dfc11123">AC_WPNav::get_vector_NEU</a></div><div class="ttdeci">bool get_vector_NEU(const Location_Class &amp;loc, Vector3f &amp;vec, bool &amp;terrain_alt)</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l01174">AC_WPNav.cpp:1174</a></div></div>
<div class="ttc" id="classAC__WPNav_html_aa218844a5ba6f88bf67ae4a8f188f962"><div class="ttname"><a href="classAC__WPNav.html#aa218844a5ba6f88bf67ae4a8f188f962">AC_WPNav::set_wp_origin_and_destination</a></div><div class="ttdeci">bool set_wp_origin_and_destination(const Vector3f &amp;origin, const Vector3f &amp;destination, bool terrain_alt=false)</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00470">AC_WPNav.cpp:470</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a4054e2d2dc53b9b0c2fd26898781af89"><div class="ttname"><a href="classAC__PosControl.html#a4054e2d2dc53b9b0c2fd26898781af89">AC_PosControl::get_stopping_point_xy</a></div><div class="ttdeci">void get_stopping_point_xy(Vector3f &amp;stopping_point) const </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00576">AC_PosControl.cpp:576</a></div></div>
<div class="ttc" id="classAC__WPNav_html_aee3a84147a966fd219eca67beb9d5b5f"><div class="ttname"><a href="classAC__WPNav.html#aee3a84147a966fd219eca67beb9d5b5f">AC_WPNav::_pos_control</a></div><div class="ttdeci">AC_PosControl &amp; _pos_control</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00315">AC_WPNav.h:315</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a7ebe48af2381e791cbcdea94c7af2e3e"><div class="ttname"><a href="classAC__WPNav.html#a7ebe48af2381e791cbcdea94c7af2e3e">AC_WPNav::shift_wp_origin_to_current_pos</a></div><div class="ttdeci">void shift_wp_origin_to_current_pos()</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00530">AC_WPNav.cpp:530</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_afd0c5b0592bf3eaffe783f3323d5fa8a"><div class="ttname"><a href="AC__WPNav_8h.html#afd0c5b0592bf3eaffe783f3323d5fa8a">WPNAV_WP_SPEED</a></div><div class="ttdeci">#define WPNAV_WP_SPEED</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00023">AC_WPNav.h:23</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a47964df8ebcc78bb101f328a23187e65"><div class="ttname"><a href="classAC__WPNav.html#a47964df8ebcc78bb101f328a23187e65">AC_WPNav::wp_and_spline_init</a></div><div class="ttdeci">void wp_and_spline_init()</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00383">AC_WPNav.cpp:383</a></div></div>
<div class="ttc" id="classAC__PosControl_html_ac4f923c39399266568b9ae9419a0596f"><div class="ttname"><a href="classAC__PosControl.html#ac4f923c39399266568b9ae9419a0596f">AC_PosControl::calc_leash_length_xy</a></div><div class="ttdeci">void calc_leash_length_xy()</div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00783">AC_PosControl.cpp:783</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a3706d8bb66c86d005c7bc7ddbe6f42c5"><div class="ttname"><a href="classAC__WPNav.html#a3706d8bb66c86d005c7bc7ddbe6f42c5">AC_WPNav::_rangefinder_healthy</a></div><div class="ttdeci">bool _rangefinder_healthy</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00365">AC_WPNav.h:365</a></div></div>
<div class="ttc" id="classAC__PosControl_html_ad7ef264f7da50fe3f0e035604fdcfea4"><div class="ttname"><a href="classAC__PosControl.html#ad7ef264f7da50fe3f0e035604fdcfea4">AC_PosControl::set_accel_z</a></div><div class="ttdeci">void set_accel_z(float accel_cmss)</div><div class="ttdoc">set_accel_z - set vertical acceleration in cm/s/s </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00121">AC_PosControl.cpp:121</a></div></div>
<div class="ttc" id="classAC__WPNav_html_adfbcedde5162905fbfe40f4f395ee6cc"><div class="ttname"><a href="classAC__WPNav.html#adfbcedde5162905fbfe40f4f395ee6cc">AC_WPNav::_pilot_accel_fwd_cms</a></div><div class="ttdeci">int16_t _pilot_accel_fwd_cms</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00333">AC_WPNav.h:333</a></div></div>
<div class="ttc" id="dsp__functions_8cpp_html_a09aece9652e49e731cfcf26eb28ba268"><div class="ttname"><a href="dsp__functions_8cpp.html#a09aece9652e49e731cfcf26eb28ba268">GRAVITY_MSS</a></div><div class="ttdeci">const float GRAVITY_MSS</div><div class="ttdef"><b>Definition:</b> <a href="dsp__functions_8cpp_source.html#l00047">dsp_functions.cpp:47</a></div></div>
<div class="ttc" id="classAC__WPNav_html_aaffcda5dd4da387a0c79a1271269a520"><div class="ttname"><a href="classAC__WPNav.html#aaffcda5dd4da387a0c79a1271269a520">AC_WPNav::_spline_time</a></div><div class="ttdeci">float _spline_time</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00352">AC_WPNav.h:352</a></div></div>
<div class="ttc" id="classAC__PosControl_html_ab4a37d0f0ce8ea8038758158f8d06562"><div class="ttname"><a href="classAC__PosControl.html#ab4a37d0f0ce8ea8038758158f8d06562">AC_PosControl::get_dt_xy</a></div><div class="ttdeci">float get_dt_xy() const </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00073">AC_PosControl.h:73</a></div></div>
<div class="ttc" id="classVector3_html_ac1fd5514e368a1e1c2d13f71eda18345"><div class="ttname"><a href="classVector3.html#ac1fd5514e368a1e1c2d13f71eda18345">Vector3::length</a></div><div class="ttdeci">float length(void) const </div><div class="ttdef"><b>Definition:</b> <a href="vector3_8cpp_source.html#l00273">vector3.cpp:273</a></div></div>
<div class="ttc" id="classLocation__Class_html_a1b58a6a4d185506e76271dee1f047836"><div class="ttname"><a href="classLocation__Class.html#a1b58a6a4d185506e76271dee1f047836">Location_Class::change_alt_frame</a></div><div class="ttdeci">bool change_alt_frame(ALT_FRAME desired_frame)</div><div class="ttdef"><b>Definition:</b> <a href="Location_8cpp_source.html#l00089">Location.cpp:89</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a1e63036613974da2e10198975df8af01"><div class="ttname"><a href="classAC__WPNav.html#a1e63036613974da2e10198975df8af01">AC_WPNav::_loiter_speed_cms</a></div><div class="ttdeci">AP_Float _loiter_speed_cms</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00321">AC_WPNav.h:321</a></div></div>
<div class="ttc" id="classLocation__Class_html"><div class="ttname"><a href="classLocation__Class.html">Location_Class</a></div><div class="ttdef"><b>Definition:</b> <a href="Location_8h_source.html#l00017">Location.h:17</a></div></div>
<div class="ttc" id="classAC__PosControl_html_ad70a79da0c5dcde97ccf848b03e7356a"><div class="ttname"><a href="classAC__PosControl.html#ad70a79da0c5dcde97ccf848b03e7356a">AC_PosControl::set_pos_target</a></div><div class="ttdeci">void set_pos_target(const Vector3f &amp;position)</div><div class="ttdoc">set_pos_target in cm from home </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00530">AC_PosControl.cpp:530</a></div></div>
<div class="ttc" id="classAC__WPNav_html_adff30a2eb74e9b17040c1398264d324c"><div class="ttname"><a href="classAC__WPNav.html#adff30a2eb74e9b17040c1398264d324c">AC_WPNav::_rangefinder_use</a></div><div class="ttdeci">AP_Int8 _rangefinder_use</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00364">AC_WPNav.h:364</a></div></div>
<div class="ttc" id="classLocation__Class_html_a47b0c66dd700f4ea188eb8a58d886e8a"><div class="ttname"><a href="classLocation__Class.html#a47b0c66dd700f4ea188eb8a58d886e8a">Location_Class::get_vector_xy_from_origin_NEU</a></div><div class="ttdeci">bool get_vector_xy_from_origin_NEU(Vector3f &amp;vec_neu) const </div><div class="ttdef"><b>Definition:</b> <a href="Location_8cpp_source.html#l00193">Location.cpp:193</a></div></div>
<div class="ttc" id="classAC__WPNav_html_aac3305ed35e3f43e62a291f6a5c76b71"><div class="ttname"><a href="classAC__WPNav.html#aac3305ed35e3f43e62a291f6a5c76b71">AC_WPNav::_hermite_spline_solution</a></div><div class="ttdeci">Vector3f _hermite_spline_solution[4]</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00356">AC_WPNav.h:356</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a7f711c7661c335417cbcc28f9546688c"><div class="ttname"><a href="classAC__WPNav.html#a7f711c7661c335417cbcc28f9546688c">AC_WPNav::get_loiter_bearing_to_target</a></div><div class="ttdeci">int32_t get_loiter_bearing_to_target() const </div><div class="ttdoc">get_loiter_bearing_to_target - get bearing to loiter target in centi-degrees </div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00311">AC_WPNav.cpp:311</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a3dbf7bda89b127cdc81bca29e2af25de"><div class="ttname"><a href="classAC__WPNav.html#a3dbf7bda89b127cdc81bca29e2af25de">AC_WPNav::calc_loiter_desired_velocity</a></div><div class="ttdeci">void calc_loiter_desired_velocity(float nav_dt, float ekfGndSpdLimit)</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00236">AC_WPNav.cpp:236</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a72ad66f06a4ace213b5f53898e9ee2fb"><div class="ttname"><a href="classAC__WPNav.html#a72ad66f06a4ace213b5f53898e9ee2fb">AC_WPNav::_loiter_desired_accel</a></div><div class="ttdeci">Vector2f _loiter_desired_accel</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00335">AC_WPNav.h:335</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a470012a574b4b6768c9d7904e9438264"><div class="ttname"><a href="classAC__WPNav.html#a470012a574b4b6768c9d7904e9438264">AC_WPNav::_terrain</a></div><div class="ttdeci">AP_Terrain * _terrain</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00317">AC_WPNav.h:317</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a6b187a3fa1e9f663e89175e7e8e213d6"><div class="ttname"><a href="AP__Math_8h.html#a6b187a3fa1e9f663e89175e7e8e213d6">MIN</a></div><div class="ttdeci">static auto MIN(const A &amp;one, const B &amp;two) -&gt; decltype(one&lt; two?one:two)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00173">AP_Math.h:173</a></div></div>
<div class="ttc" id="classAC__PosControl_html_aa979d20c99f08a96d0f482c1dad50f78"><div class="ttname"><a href="classAC__PosControl.html#aa979d20c99f08a96d0f482c1dad50f78">AC_PosControl::freeze_ff_z</a></div><div class="ttdeci">void freeze_ff_z()</div><div class="ttdoc">freeze_ff_z - used to stop the feed forward being calculated during a known discontinuity ...</div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00236">AC_PosControl.h:236</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a472f9c88311c7c7b04fdfa4446663fad"><div class="ttname"><a href="classAC__WPNav.html#a472f9c88311c7c7b04fdfa4446663fad">AC_WPNav::_loiter_accel_min_cmss</a></div><div class="ttdeci">AP_Float _loiter_accel_min_cmss</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00324">AC_WPNav.h:324</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a3d9cd8d29a9ce76bb5b6d757aac7626f"><div class="ttname"><a href="classAC__PosControl.html#a3d9cd8d29a9ce76bb5b6d757aac7626f">AC_PosControl::get_desired_velocity</a></div><div class="ttdeci">const Vector3f &amp; get_desired_velocity()</div><div class="ttdoc">get_desired_velocity - returns xy desired velocity (i.e. feed forward) in cm/s in lat and lon directi...</div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00218">AC_PosControl.h:218</a></div></div>
<div class="ttc" id="AP__Math_8h_html_ad525609d9dba6ffa556a0fbf08a3f9b4"><div class="ttname"><a href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a></div><div class="ttdeci">float constrain_float(const float amt, const float low, const float high)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00119">AP_Math.h:119</a></div></div>
<div class="ttc" id="structVector2_html_a78fa1f2ed5e261c7fbeb8f3536a1ee34"><div class="ttname"><a href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">Vector2::x</a></div><div class="ttdeci">T x</div><div class="ttdef"><b>Definition:</b> <a href="vector2_8h_source.html#l00037">vector2.h:37</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_a9bbb7bad46d20edbe3fa0e06c9b2d14e"><div class="ttname"><a href="AC__WPNav_8h.html#a9bbb7bad46d20edbe3fa0e06c9b2d14e">WPNAV_LOITER_ACCEL</a></div><div class="ttdeci">#define WPNAV_LOITER_ACCEL</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00019">AC_WPNav.h:19</a></div></div>
<div class="ttc" id="classAC__PosControl_html_aa5759b18c7c1208b6979c728fb85f1e4"><div class="ttname"><a href="classAC__PosControl.html#aa5759b18c7c1208b6979c728fb85f1e4">AC_PosControl::get_leash_xy</a></div><div class="ttdeci">float get_leash_xy() const </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00277">AC_PosControl.h:277</a></div></div>
<div class="ttc" id="classAC__WPNav_html_ad63cee44ffeaaf4e18f42571a34093b8"><div class="ttname"><a href="classAC__WPNav.html#ad63cee44ffeaaf4e18f42571a34093b8">AC_WPNav::_wp_speed_down_cms</a></div><div class="ttdeci">AP_Float _wp_speed_down_cms</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00327">AC_WPNav.h:327</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a5e47fd89f68af7f00d9bd59cfcb422a8"><div class="ttname"><a href="classAC__PosControl.html#a5e47fd89f68af7f00d9bd59cfcb422a8">AC_PosControl::set_accel_xy</a></div><div class="ttdeci">void set_accel_xy(float accel_cmss)</div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00509">AC_PosControl.cpp:509</a></div></div>
<div class="ttc" id="structAC__WPNav_1_1wpnav__flags_html_a093c5f28780c35169320486da9b13a43"><div class="ttname"><a href="structAC__WPNav_1_1wpnav__flags.html#a093c5f28780c35169320486da9b13a43">AC_WPNav::wpnav_flags::recalc_wp_leash</a></div><div class="ttdeci">uint8_t recalc_wp_leash</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00277">AC_WPNav.h:277</a></div></div>
<div class="ttc" id="classAC__WPNav_html_ad0b9019cec333348644f43112c8b6144"><div class="ttname"><a href="classAC__WPNav.html#ad0b9019cec333348644f43112c8b6144">AC_WPNav::_terrain_alt</a></div><div class="ttdeci">bool _terrain_alt</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00361">AC_WPNav.h:361</a></div></div>
<div class="ttc" id="classAC__WPNav_html_acee5cbca4296027197ee0c892b5dbc38"><div class="ttname"><a href="classAC__WPNav.html#acee5cbca4296027197ee0c892b5dbc38">AC_WPNav::_wp_last_update</a></div><div class="ttdeci">uint32_t _wp_last_update</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00338">AC_WPNav.h:338</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a8dbe5714a3adf0eae1d7dbc6fa738261a244adee4a19c8f357e6bc4996d61c9e0"><div class="ttname"><a href="classAC__WPNav.html#a8dbe5714a3adf0eae1d7dbc6fa738261a244adee4a19c8f357e6bc4996d61c9e0">AC_WPNav::SEGMENT_END_SPLINE</a></div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00053">AC_WPNav.h:53</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_afaee23265da0f07dc72f1c225bffbef9"><div class="ttname"><a href="AC__WPNav_8h.html#afaee23265da0f07dc72f1c225bffbef9">WPNAV_LOITER_JERK_MAX_DEFAULT</a></div><div class="ttdeci">#define WPNAV_LOITER_JERK_MAX_DEFAULT</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00021">AC_WPNav.h:21</a></div></div>
<div class="ttc" id="classAC__WPNav_html_af9d3f98ad44166d4c5d072bf3ba4a3db"><div class="ttname"><a href="classAC__WPNav.html#af9d3f98ad44166d4c5d072bf3ba4a3db">AC_WPNav::update_brake</a></div><div class="ttdeci">void update_brake(float ekfGndSpdLimit, float ekfNavVelGainScaler)</div><div class="ttdoc">update_brake - run the brake controller - should be called at 400hz </div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00362">AC_WPNav.cpp:362</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a0375e3d67fd3911cacee5c3e1408c0f2"><div class="ttname"><a href="AP__Math_8h.html#a0375e3d67fd3911cacee5c3e1408c0f2">sq</a></div><div class="ttdeci">float sq(const T val)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00147">AP_Math.h:147</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a0a434270245fd8641352af387700dc82"><div class="ttname"><a href="classAC__WPNav.html#a0a434270245fd8641352af387700dc82">AC_WPNav::update_loiter</a></div><div class="ttdeci">void update_loiter(float ekfGndSpdLimit, float ekfNavVelGainScaler)</div><div class="ttdoc">update_loiter - run the loiter controller - should be called at 10hz </div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00317">AC_WPNav.cpp:317</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a1df2d6792b0b42b8c60bb57b5c1991cf"><div class="ttname"><a href="classAC__WPNav.html#a1df2d6792b0b42b8c60bb57b5c1991cf">AC_WPNav::_track_speed</a></div><div class="ttdeci">float _track_speed</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00347">AC_WPNav.h:347</a></div></div>
<div class="ttc" id="structAC__WPNav_1_1wpnav__flags_html_afe76f469a51fa8525915518f9ca7f42b"><div class="ttname"><a href="structAC__WPNav_1_1wpnav__flags.html#afe76f469a51fa8525915518f9ca7f42b">AC_WPNav::wpnav_flags::segment_type</a></div><div class="ttdeci">SegmentType segment_type</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00279">AC_WPNav.h:279</a></div></div>
<div class="ttc" id="classVector3_html"><div class="ttname"><a href="classVector3.html">Vector3&lt; float &gt;</a></div></div>
<div class="ttc" id="classAC__PosControl_html"><div class="ttname"><a href="classAC__PosControl.html">AC_PosControl</a></div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00045">AC_PosControl.h:45</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a9a04a9cd8aeca3ddaf980dcdec86943b"><div class="ttname"><a href="classAC__WPNav.html#a9a04a9cd8aeca3ddaf980dcdec86943b">AC_WPNav::_wp_speed_up_cms</a></div><div class="ttdeci">AP_Float _wp_speed_up_cms</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00326">AC_WPNav.h:326</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a2c34476e01b9988589e9be01e6c8b5f0"><div class="ttname"><a href="AP__Math_8h.html#a2c34476e01b9988589e9be01e6c8b5f0">norm</a></div><div class="ttdeci">float norm(const T first, const Params...parameters)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00167">AP_Math.h:167</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a2036d6ad0d72ba04c425a0a68553209b"><div class="ttname"><a href="classAC__WPNav.html#a2036d6ad0d72ba04c425a0a68553209b">AC_WPNav::calculate_wp_leash_length</a></div><div class="ttdeci">void calculate_wp_leash_length()</div><div class="ttdoc">calculate_wp_leash_length - calculates track speed, acceleration and leash lengths for waypoint contr...</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00771">AC_WPNav.cpp:771</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a40589bfae2c593c46a05e53601954311a6aef631564494d1c7bc74592e39d2ad7"><div class="ttname"><a href="classAC__WPNav.html#a40589bfae2c593c46a05e53601954311a6aef631564494d1c7bc74592e39d2ad7">AC_WPNav::SEGMENT_STRAIGHT</a></div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00268">AC_WPNav.h:268</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_a0a35073f3a0ea9c0873a2d4327a8619f"><div class="ttname"><a href="AC__WPNav_8h.html#a0a35073f3a0ea9c0873a2d4327a8619f">WPNAV_ACCELERATION</a></div><div class="ttdeci">#define WPNAV_ACCELERATION</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00014">AC_WPNav.h:14</a></div></div>
<div class="ttc" id="classAP__InertialNav_html_a5bfad40c8a4e0ca98aa09c80e17c4ff5"><div class="ttname"><a href="classAP__InertialNav.html#a5bfad40c8a4e0ca98aa09c80e17c4ff5">AP_InertialNav::get_velocity</a></div><div class="ttdeci">virtual const Vector3f &amp; get_velocity() const =0</div></div>
<div class="ttc" id="classAC__WPNav_html_aaf51adb38cdaf72ffa54d2a03a151cfd"><div class="ttname"><a href="classAC__WPNav.html#aaf51adb38cdaf72ffa54d2a03a151cfd">AC_WPNav::get_wp_bearing_to_destination</a></div><div class="ttdeci">int32_t get_wp_bearing_to_destination() const </div><div class="ttdoc">get_bearing_to_destination - get bearing to next waypoint in centi-degrees </div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00712">AC_WPNav.cpp:712</a></div></div>
<div class="ttc" id="classAC__AttitudeControl_html"><div class="ttname"><a href="classAC__AttitudeControl.html">AC_AttitudeControl</a></div><div class="ttdef"><b>Definition:</b> <a href="AC__AttitudeControl_8h_source.html#l00045">AC_AttitudeControl.h:45</a></div></div>
<div class="ttc" id="classLocation__Class_html_a12eedb8fc1b0f9391bc07891decf95fc"><div class="ttname"><a href="classLocation__Class.html#a12eedb8fc1b0f9391bc07891decf95fc">Location_Class::get_alt_frame</a></div><div class="ttdeci">ALT_FRAME get_alt_frame() const </div><div class="ttdef"><b>Definition:</b> <a href="Location_8cpp_source.html#l00100">Location.cpp:100</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a93d757decf91ba7281d3856cc82c788b"><div class="ttname"><a href="classAC__WPNav.html#a93d757decf91ba7281d3856cc82c788b">AC_WPNav::_flags</a></div><div class="ttdeci">struct AC_WPNav::wpnav_flags _flags</div></div>
<div class="ttc" id="classLocation__Class_html_a1031bf89d17b45872147c9ae31ea94b4ae3be3ef31369ccac098e63653eecd4af"><div class="ttname"><a href="classLocation__Class.html#a1031bf89d17b45872147c9ae31ea94b4ae3be3ef31369ccac098e63653eecd4af">Location_Class::ALT_FRAME_ABOVE_TERRAIN</a></div><div class="ttdef"><b>Definition:</b> <a href="Location_8h_source.html#l00026">Location.h:26</a></div></div>
<div class="ttc" id="AC__WPNav_8h_html_a3f11d50939feb2deddb76540c377632e"><div class="ttname"><a href="AC__WPNav_8h.html#a3f11d50939feb2deddb76540c377632e">WPNAV_WP_SPEED_DOWN</a></div><div class="ttdeci">#define WPNAV_WP_SPEED_DOWN</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00029">AC_WPNav.h:29</a></div></div>
<div class="ttc" id="AC__WPNav_8cpp_html_ae08c3ca4ba26b63cda0bb3e3c6c02785"><div class="ttname"><a href="AC__WPNav_8cpp.html#ae08c3ca4ba26b63cda0bb3e3c6c02785">hal</a></div><div class="ttdeci">const AP_HAL::HAL &amp; hal</div><div class="ttdef"><b>Definition:</b> <a href="AC__PID__test_8cpp_source.html#l00010">AC_PID_test.cpp:10</a></div></div>
<div class="ttc" id="structAC__WPNav_1_1wpnav__flags_html_a212e8bdfd1e8dfb5585f8616d37416c8"><div class="ttname"><a href="structAC__WPNav_1_1wpnav__flags.html#a212e8bdfd1e8dfb5585f8616d37416c8">AC_WPNav::wpnav_flags::new_wp_destination</a></div><div class="ttdeci">uint8_t new_wp_destination</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00278">AC_WPNav.h:278</a></div></div>
<div class="ttc" id="structAC__WPNav_1_1wpnav__flags_html_ad8a49f0a80a119c6cdf901807227251b"><div class="ttname"><a href="structAC__WPNav_1_1wpnav__flags.html#ad8a49f0a80a119c6cdf901807227251b">AC_WPNav::wpnav_flags::fast_waypoint</a></div><div class="ttdeci">uint8_t fast_waypoint</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00275">AC_WPNav.h:275</a></div></div>
<div class="ttc" id="classAC__WPNav_html_ada2525084222dd59a209b2d1870dbdd3"><div class="ttname"><a href="classAC__WPNav.html#ada2525084222dd59a209b2d1870dbdd3">AC_WPNav::_ahrs</a></div><div class="ttdeci">const AP_AHRS_View &amp; _ahrs</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00314">AC_WPNav.h:314</a></div></div>
<div class="ttc" id="classAP__InertialNav_html_ac47da3c171cdcaabb4bc3a2749762461"><div class="ttname"><a href="classAP__InertialNav.html#ac47da3c171cdcaabb4bc3a2749762461">AP_InertialNav::get_altitude</a></div><div class="ttdeci">virtual float get_altitude() const =0</div></div>
<div class="ttc" id="classAC__PosControl_html_aeba418c057fc5aa5aa784d809da98f14"><div class="ttname"><a href="classAC__PosControl.html#aeba418c057fc5aa5aa784d809da98f14">AC_PosControl::get_leash_down_z</a></div><div class="ttdeci">float get_leash_down_z() const </div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00167">AC_PosControl.h:167</a></div></div>
<div class="ttc" id="classAC__PosControl_html_aeb636a56d87a2495d86e394ff6ac7549"><div class="ttname"><a href="classAC__PosControl.html#aeb636a56d87a2495d86e394ff6ac7549">AC_PosControl::set_speed_xy</a></div><div class="ttdeci">void set_speed_xy(float speed_cms)</div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8cpp_source.html#l00520">AC_PosControl.cpp:520</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a91ab547d049aa41640edca2ad44b60f2"><div class="ttname"><a href="classAC__WPNav.html#a91ab547d049aa41640edca2ad44b60f2">AC_WPNav::_rangefinder_alt_cm</a></div><div class="ttdeci">float _rangefinder_alt_cm</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00366">AC_WPNav.h:366</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a180fb06a829a1e4168ceb24ca0c41e1f"><div class="ttname"><a href="classAC__WPNav.html#a180fb06a829a1e4168ceb24ca0c41e1f">AC_WPNav::get_wp_stopping_point_xy</a></div><div class="ttdeci">void get_wp_stopping_point_xy(Vector3f &amp;stopping_point) const </div><div class="ttdoc">get_wp_stopping_point_xy - returns vector to stopping point based on a horizontal position and veloci...</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00555">AC_WPNav.cpp:555</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a0c003971d88dadd9b8101fbf60534280"><div class="ttname"><a href="classAC__WPNav.html#a0c003971d88dadd9b8101fbf60534280">AC_WPNav::_slow_down_dist</a></div><div class="ttdeci">float _slow_down_dist</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00349">AC_WPNav.h:349</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a06f91bbbcdecb2132214a8d6de0dd5d8"><div class="ttname"><a href="classAC__WPNav.html#a06f91bbbcdecb2132214a8d6de0dd5d8">AC_WPNav::_pilot_accel_rgt_cms</a></div><div class="ttdeci">int16_t _pilot_accel_rgt_cms</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8h_source.html#l00334">AC_WPNav.h:334</a></div></div>
<div class="ttc" id="AP__Param_8h_html_a0f9acb038a5283b964b862aea8cc5051"><div class="ttname"><a href="AP__Param_8h.html#a0f9acb038a5283b964b862aea8cc5051">AP_GROUPEND</a></div><div class="ttdeci">#define AP_GROUPEND</div><div class="ttdef"><b>Definition:</b> <a href="AP__Param_8h_source.html#l00102">AP_Param.h:102</a></div></div>
<div class="ttc" id="classAC__WPNav_html_a603ec5c1a7654ccd9a227565cdbee275"><div class="ttname"><a href="classAC__WPNav.html#a603ec5c1a7654ccd9a227565cdbee275">AC_WPNav::advance_wp_target_along_track</a></div><div class="ttdeci">bool advance_wp_target_along_track(float dt)</div><div class="ttdoc">advance_wp_target_along_track - move target location along track from origin to destination ...</div><div class="ttdef"><b>Definition:</b> <a href="AC__WPNav_8cpp_source.html#l00561">AC_WPNav.cpp:561</a></div></div>
<div class="ttc" id="classVector3_html_a1a0f7e168c71ca798099f0ba8a444244"><div class="ttname"><a href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">Vector3::x</a></div><div class="ttdeci">T x</div><div class="ttdef"><b>Definition:</b> <a href="vector3_8h_source.html#l00067">vector3.h:67</a></div></div>
<div class="ttc" id="classAP__AHRS__View_html_a3f98bb641a87a41f52f532747ca7c9b5"><div class="ttname"><a href="classAP__AHRS__View.html#a3f98bb641a87a41f52f532747ca7c9b5">AP_AHRS_View::cos_yaw</a></div><div class="ttdeci">float cos_yaw</div><div class="ttdef"><b>Definition:</b> <a href="AP__AHRS__View_8h_source.html#l00178">AP_AHRS_View.h:178</a></div></div>
<div class="ttc" id="classAC__PosControl_html_a44ce19c29764128d832fa3c1bc871be4"><div class="ttname"><a href="classAC__PosControl.html#a44ce19c29764128d832fa3c1bc871be4">AC_PosControl::set_jerk_xy_to_default</a></div><div class="ttdeci">void set_jerk_xy_to_default()</div><div class="ttdef"><b>Definition:</b> <a href="AC__PosControl_8h_source.html#l00195">AC_PosControl.h:195</a></div></div>
<div class="ttc" id="classAP__Param_html_a5f6dcfce1c0a79cf5bd81283e22f3201"><div class="ttname"><a href="classAP__Param.html#a5f6dcfce1c0a79cf5bd81283e22f3201">AP_Param::setup_object_defaults</a></div><div class="ttdeci">static void setup_object_defaults(const void *object_pointer, const struct GroupInfo *group_info)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Param_8cpp_source.html#l01195">AP_Param.cpp:1195</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Apr 14 2017 11:51:09 for APM:Libraries by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
