<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>APM:Libraries: libraries/APM_Control/AP_SteerController.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">APM:Libraries
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_bc0718b08fb2015b8e59c47b2805f60c.html">libraries</a></li><li class="navelem"><a class="el" href="dir_50866fe7c3a898cfa96b79f21ec45884.html">APM_Control</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">AP_SteerController.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="AP__SteerController_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">   This program is free software: you can redistribute it and/or modify</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">   it under the terms of the GNU General Public License as published by</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">   the Free Software Foundation, either version 3 of the License, or</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">   (at your option) any later version.</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">   This program is distributed in the hope that it will be useful,</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">   GNU General Public License for more details.</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">   You should have received a copy of the GNU General Public License</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">   along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">//  Code by Andrew Tridgell</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">//  Based upon the roll controller by Paul Riseborough and Jon Challinger</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="AP__Math_8h.html">AP_Math/AP_Math.h</a>&gt;</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="AP__HAL_8h.html">AP_HAL/AP_HAL.h</a>&gt;</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="AP__SteerController_8h.html">AP_SteerController.h</a>&quot;</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">extern</span> <span class="keyword">const</span> <a class="code" href="classAP__HAL_1_1HAL.html">AP_HAL::HAL</a>&amp; <a class="code" href="AP__SteerController_8cpp.html#ae08c3ca4ba26b63cda0bb3e3c6c02785">hal</a>;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="keyword">const</span> <a class="code" href="structAP__Param_1_1GroupInfo.html">AP_Param::GroupInfo</a> <a class="code" href="classAP__SteerController.html#afda95cde8bbceff648ac1c56e5800e1c">AP_SteerController::var_info</a>[] = {</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;    <span class="comment">// @Param: TCONST</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    <span class="comment">// @DisplayName: Steering Time Constant</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    <span class="comment">// @Description: This controls the time constant in seconds from demanded to achieved steering angle. A value of 0.75 is a good default and will work with nearly all rovers. Ground steering in aircraft needs a bit smaller time constant, and a value of 0.5 is recommended for best ground handling in fixed wing aircraft. A value of 0.75 means that the controller will try to correct any deviation between the desired and actual steering angle in 0.75 seconds. Advanced users may want to reduce this time to obtain a faster response but there is no point setting a time less than the vehicle can achieve.</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <span class="comment">// @Range: 0.4 1.0</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    <span class="comment">// @Units: seconds</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    <span class="comment">// @Increment: 0.1</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    <span class="comment">// @User: Advanced</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;TCONST&quot;</span>,      0, <a class="code" href="classAP__SteerController.html">AP_SteerController</a>, _tau,       0.75<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    <span class="comment">// @Param: P</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    <span class="comment">// @DisplayName: Steering turning gain</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <span class="comment">// @Description: The proportional gain for steering. This should be approximately equal to the diameter of the turning circle of the vehicle at low speed and maximum steering angle</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <span class="comment">// @Range: 0.1 10.0</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <span class="comment">// @Increment: 0.1</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="comment">// @User: User</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;P&quot;</span>,      1, <a class="code" href="classAP__SteerController.html">AP_SteerController</a>, _K_P,        1.8<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="comment">// @Param: I</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="comment">// @DisplayName: Integrator Gain</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="comment">// @Description: This is the gain from the integral of steering angle. Increasing this gain causes the controller to trim out steady offsets due to an out of trim vehicle.</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="comment">// @Range: 0 1.0</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="comment">// @Increment: 0.05</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="comment">// @User: User</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;I&quot;</span>,        3, <a class="code" href="classAP__SteerController.html">AP_SteerController</a>, _K_I,        0.2<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="comment">// @Param: D</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="comment">// @DisplayName: Damping Gain</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="comment">// @Description: This adjusts the damping of the steering control loop. This gain helps to reduce steering jitter with vibration. It should be increased in 0.01 increments as too high a value can lead to a high frequency steering oscillation that could overstress the vehicle.</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="comment">// @Range: 0 0.1</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="comment">// @Increment: 0.01</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <span class="comment">// @User: User</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;D&quot;</span>,        4, <a class="code" href="classAP__SteerController.html">AP_SteerController</a>, _K_D,        0.005<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="comment">// @Param: IMAX</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="comment">// @DisplayName: Integrator limit</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="comment">// @Description: This limits the number of degrees of steering in centi-degrees over which the integrator will operate. At the default setting of 1500 centi-degrees, the integrator will be limited to +- 15 degrees of servo travel. The maximum servo deflection is +- 45 centi-degrees, so the default value represents a 1/3rd of the total control throw which is adequate unless the vehicle is severely out of trim.</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="comment">// @Range: 0 4500</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">// @Increment: 1</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="comment">// @User: Advanced</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;IMAX&quot;</span>,     5, <a class="code" href="classAP__SteerController.html">AP_SteerController</a>, _imax,        1500),</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="comment">// @Param: MINSPD</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="comment">// @DisplayName: Minimum speed</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <span class="comment">// @Description: This is the minimum assumed ground speed in meters/second for steering. Having a minimum speed prevents oscillations when the vehicle first starts moving. The vehicle can still drive slower than this limit, but the steering calculations will be done based on this minimum speed.</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="comment">// @Range: 0 5</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="comment">// @Increment: 0.1</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="comment">// @Units: m/s</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="comment">// @User: User</span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;MINSPD&quot;</span>,   6, <a class="code" href="classAP__SteerController.html">AP_SteerController</a>, _minspeed,    1.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="comment">// @Param: FF</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="comment">// @DisplayName: Steering feed forward</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="comment">// @Description: The feed forward gain for steering this is the ratio of the achieved turn rate to applied steering. A value of 1 means that the vehicle would yaw at a rate of 45 degrees per second with full steering deflection at 1m/s ground speed.</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="comment">// @Range: 0.0 10.0</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="comment">// @Increment: 0.1</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="comment">// @User: User</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;FF&quot;</span>,      7, <a class="code" href="classAP__SteerController.html">AP_SteerController</a>, _K_FF,        0),</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="comment">// @Param: DRTSPD</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="comment">// @DisplayName: Derating speed</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="comment">// @Description: Speed after that the maximum degree of steering will start to derate. Set this speed to a maximum speed that a plane can do controlled turn at maximum angle of steering wheel without rolling to wing. If 0 then no derating is used.</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="comment">// @Range: 0.0 30.0</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="comment">// @Increment: 0.1</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="comment">// @Units: m/s</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="comment">// @User: Advanced</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;DRTSPD&quot;</span>,  8, <a class="code" href="classAP__SteerController.html">AP_SteerController</a>, _deratespeed,        0),</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <span class="comment">// @Param: DRTFCT</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="comment">// @DisplayName: Derating factor</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="comment">// @Description: Degrees of steering wheel to derate at each additional m/s of speed above &quot;Derating speed&quot;. Should be set so that at higher speeds the plane does not roll to the wing in turns.</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="comment">// @Range: 0.0 50.0</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="comment">// @Increment: 0.1</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <span class="comment">// @Units: degree/(m/s)</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="comment">// @User: Advanced</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;DRTFCT&quot;</span>, 9, <a class="code" href="classAP__SteerController.html">AP_SteerController</a>, _deratefactor,        10),</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <span class="comment">// @Param: DRTMIN</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="comment">// @DisplayName: Minimum angle of wheel</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="comment">// @Description: The angle that limits smallest angle of steering wheel at maximum speed. Even if it should derate below, it will stop derating at this angle.</span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <span class="comment">// @Range: 0.0 4500.0</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="comment">// @Increment: 0.1</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="comment">// @Units: Centidegrees</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="comment">// @User: Advanced</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;DRTMIN&quot;</span>, 10, <a class="code" href="classAP__SteerController.html">AP_SteerController</a>, _mindegree,        4500),</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <a class="code" href="AP__Param_8h.html#a0f9acb038a5283b964b862aea8cc5051">AP_GROUPEND</a></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;};</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">  steering rate controller. Returns servo out -4500 to 4500 given</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment">  desired yaw rate in degrees/sec. Positive yaw rate means clockwise yaw.</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00122"></a><span class="lineno"><a class="line" href="classAP__SteerController.html#aaf42965b867c847976199bb550f7a529">  122</a></span>&#160;int32_t <a class="code" href="classAP__SteerController.html#aaf42965b867c847976199bb550f7a529">AP_SteerController::get_steering_out_rate</a>(<span class="keywordtype">float</span> desired_rate)</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;{</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    uint32_t tnow = <a class="code" href="namespaceAP__HAL.html#a77dffbb18891996280308e21316ec186">AP_HAL::millis</a>();</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    uint32_t dt = tnow - <a class="code" href="classAP__SteerController.html#a9c0010547b39dacee51168be499a0302">_last_t</a>;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">if</span> (_last_t == 0 || dt &gt; 1000) {</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        dt = 0;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    }</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    _last_t = tnow;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="keywordtype">float</span> speed = <a class="code" href="classAP__SteerController.html#a40d629a25fa92f1a392553813174866b">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a11efcc2b48256bf736f33ac26063ae16">groundspeed</a>();</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <span class="keywordflow">if</span> (speed &lt; <a class="code" href="classAP__SteerController.html#afa9eb418deb8746e4dc7f7563e6e201d">_minspeed</a>) {</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="comment">// assume a minimum speed. This stops oscillations when first starting to move</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        speed = <a class="code" href="classAP__SteerController.html#afa9eb418deb8746e4dc7f7563e6e201d">_minspeed</a>;</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    }</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <span class="comment">// this is a linear approximation of the inverse steering</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <span class="comment">// equation for a ground vehicle. It returns steering as an angle from -45 to 45</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="keywordtype">float</span> scaler = 1.0f / speed;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#a039854d85412b90657a08d11358a286a">desired</a> = desired_rate;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="comment">// Calculate the steering rate error (deg/sec) and apply gain scaler</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="comment">// We do this in earth frame to allow for rover leaning over in hard corners</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="keywordtype">float</span> yaw_rate_earth = <a class="code" href="AP__Common_8h.html#a3c9d151923236c7e8ccccf86f131e550">ToDeg</a>(<a class="code" href="classAP__SteerController.html#a40d629a25fa92f1a392553813174866b">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a26a38955546934cac5b94125ebf87cfe">get_yaw_rate_earth</a>());</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAP__SteerController.html#a5050abe38b7b2969ce6a2e780a9f60c2">_reverse</a>) {</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        yaw_rate_earth = <a class="code" href="AP__Math_8cpp.html#a603d717bc95dd546b9e2c4da57b88a39">wrap_180</a>(180 + yaw_rate_earth);</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    }</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="keywordtype">float</span> rate_error = (desired_rate - yaw_rate_earth) * scaler;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    </div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="comment">// Calculate equivalent gains so that values for K_P and K_I can be taken across from the old PID law</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <span class="comment">// No conversion is required for K_D</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="keywordtype">float</span> ki_rate = <a class="code" href="classAP__SteerController.html#acd31b38382cb4c935417585d2177ec40">_K_I</a> * <a class="code" href="classAP__SteerController.html#a403813143945c830c573f03079393228">_tau</a> * 45.0f;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordtype">float</span> kp_ff = <a class="code" href="AP__Math_8h.html#a5c0b5c82749ac54970b2699d3c10ee9b">MAX</a>((<a class="code" href="classAP__SteerController.html#af7d4a8ee3c8ec0cd6da820f6c542d7a7">_K_P</a> - <a class="code" href="classAP__SteerController.html#acd31b38382cb4c935417585d2177ec40">_K_I</a> * <a class="code" href="classAP__SteerController.html#a403813143945c830c573f03079393228">_tau</a>) * _tau  - <a class="code" href="classAP__SteerController.html#a267a9ae84472fc704e7eb9c82cc82aee">_K_D</a> , 0) * 45.0f;</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="keywordtype">float</span> k_ff = <a class="code" href="classAP__SteerController.html#af20c84279bda606f69e2ce4b932218e5">_K_FF</a> * 45.0f;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <span class="keywordtype">float</span> delta_time    = (float)dt * 0.001<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    </div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <span class="comment">// Multiply yaw rate error by _ki_rate and integrate</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <span class="comment">// Don&#39;t integrate if in stabilize mode as the integrator will wind up against the pilots inputs</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <span class="keywordflow">if</span> (ki_rate &gt; 0 &amp;&amp; speed &gt;= <a class="code" href="classAP__SteerController.html#afa9eb418deb8746e4dc7f7563e6e201d">_minspeed</a>) {</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        <span class="comment">// only integrate if gain and time step are positive.</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        <span class="keywordflow">if</span> (dt &gt; 0) {</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            <span class="keywordtype">float</span> integrator_delta = rate_error * ki_rate * delta_time * scaler;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;            <span class="comment">// prevent the integrator from increasing if steering defln demand is above the upper limit</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="classAP__SteerController.html#a00380bb52421fff63822e3014d8f6844">_last_out</a> &lt; -45) {</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                integrator_delta = <a class="code" href="AP__Math_8h.html#a5c0b5c82749ac54970b2699d3c10ee9b">MAX</a>(integrator_delta , 0);</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classAP__SteerController.html#a00380bb52421fff63822e3014d8f6844">_last_out</a> &gt; 45) {</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                <span class="comment">// prevent the integrator from decreasing if steering defln demand is below the lower limit</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;                integrator_delta = <a class="code" href="AP__Math_8h.html#a6b187a3fa1e9f663e89175e7e8e213d6">MIN</a>(integrator_delta, 0);</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            }</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;            <a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#a224dedbec9a0e3d1a5e160c2827d1551">I</a> += integrator_delta;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        }</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        <a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#a224dedbec9a0e3d1a5e160c2827d1551">I</a> = 0;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    }</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    </div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="comment">// Scale the integration limit</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <span class="keywordtype">float</span> intLimScaled = <a class="code" href="classAP__SteerController.html#aedd8ad2008dfaca62ec16664aa152f45">_imax</a> * 0.01f;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="comment">// Constrain the integrator state</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#a224dedbec9a0e3d1a5e160c2827d1551">I</a> = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(<a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#a224dedbec9a0e3d1a5e160c2827d1551">I</a>, -intLimScaled, intLimScaled);</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#a2c4183a4b3eaf152eb2d910eefee495c">D</a> = rate_error * <a class="code" href="classAP__SteerController.html#a267a9ae84472fc704e7eb9c82cc82aee">_K_D</a> * 4.0f; </div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#afded67a27b416d1a7d5a7af84c782de6">P</a> = (<a class="code" href="AP__Common_8h.html#a728f9499baea61e7df3ae70a374f2512">ToRad</a>(desired_rate) * kp_ff) * scaler;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#af1dd0ab3a1d25f7f93b6a97c51ae4a15">FF</a> = (<a class="code" href="AP__Common_8h.html#a728f9499baea61e7df3ae70a374f2512">ToRad</a>(desired_rate) * k_ff) * scaler;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    </div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="comment">// Calculate the demanded control surface deflection</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <a class="code" href="classAP__SteerController.html#a00380bb52421fff63822e3014d8f6844">_last_out</a> = <a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#a2c4183a4b3eaf152eb2d910eefee495c">D</a> + <a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#af1dd0ab3a1d25f7f93b6a97c51ae4a15">FF</a> + <a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#afded67a27b416d1a7d5a7af84c782de6">P</a> + <a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#a224dedbec9a0e3d1a5e160c2827d1551">I</a>;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    </div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="keywordtype">float</span> derate_constraint = 4500;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="comment">// Calculate required constrain based on speed</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(<a class="code" href="classAP__SteerController.html#afdb1a4d1e274a901b1af7a616fbcf8c9">_deratespeed</a>) &amp;&amp; speed &gt; <a class="code" href="classAP__SteerController.html#afdb1a4d1e274a901b1af7a616fbcf8c9">_deratespeed</a>) {</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        derate_constraint = 4500 - (speed - <a class="code" href="classAP__SteerController.html#afdb1a4d1e274a901b1af7a616fbcf8c9">_deratespeed</a>) * <a class="code" href="classAP__SteerController.html#a38c31ad23a2f3b46c0ee2e8f33aca31c">_deratefactor</a> * 100;</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="keywordflow">if</span> (derate_constraint &lt; <a class="code" href="classAP__SteerController.html#aaddb47f5f1afab6b88e22bbdc5f09df8">_mindegree</a>) {</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            derate_constraint = <a class="code" href="classAP__SteerController.html#aaddb47f5f1afab6b88e22bbdc5f09df8">_mindegree</a>;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        }</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    }</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="comment">// Convert to centi-degrees and constrain</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(<a class="code" href="classAP__SteerController.html#a00380bb52421fff63822e3014d8f6844">_last_out</a> * 100, -derate_constraint, derate_constraint);</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;}</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="comment">  lateral acceleration controller. Returns servo value -4500 to 4500</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment">  given a desired lateral acceleration</span></div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00209"></a><span class="lineno"><a class="line" href="classAP__SteerController.html#a6285aeb38fd5614ecd53ae0b83d162ba">  209</a></span>&#160;int32_t <a class="code" href="classAP__SteerController.html#a6285aeb38fd5614ecd53ae0b83d162ba">AP_SteerController::get_steering_out_lat_accel</a>(<span class="keywordtype">float</span> desired_accel)</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;{</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keywordtype">float</span> speed = <a class="code" href="classAP__SteerController.html#a40d629a25fa92f1a392553813174866b">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a11efcc2b48256bf736f33ac26063ae16">groundspeed</a>();</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keywordflow">if</span> (speed &lt; <a class="code" href="classAP__SteerController.html#afa9eb418deb8746e4dc7f7563e6e201d">_minspeed</a>) {</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        <span class="comment">// assume a minimum speed. This reduces osciallations when first starting to move</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        speed = <a class="code" href="classAP__SteerController.html#afa9eb418deb8746e4dc7f7563e6e201d">_minspeed</a>;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    }</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="comment">// Calculate the desired steering rate given desired_accel and speed</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordtype">float</span> desired_rate = <a class="code" href="AP__Common_8h.html#a3c9d151923236c7e8ccccf86f131e550">ToDeg</a>(desired_accel / speed);</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAP__SteerController.html#a5050abe38b7b2969ce6a2e780a9f60c2">_reverse</a>) {</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        desired_rate *= -1;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    }</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classAP__SteerController.html#aaf42965b867c847976199bb550f7a529">get_steering_out_rate</a>(desired_rate);</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;}</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">  return a steering servo value from -4500 to 4500 given an angular</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">  steering error in centidegrees.</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00229"></a><span class="lineno"><a class="line" href="classAP__SteerController.html#a58fa2b841c4507318c4560ff237b4db9">  229</a></span>&#160;int32_t <a class="code" href="classAP__SteerController.html#a58fa2b841c4507318c4560ff237b4db9">AP_SteerController::get_steering_out_angle_error</a>(int32_t angle_err)</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;{</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAP__SteerController.html#a403813143945c830c573f03079393228">_tau</a> &lt; 0.1<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <a class="code" href="classAP__SteerController.html#a403813143945c830c573f03079393228">_tau</a> = 0.1f;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    }</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    </div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="comment">// Calculate the desired steering rate (deg/sec) from the angle error</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordtype">float</span> desired_rate = angle_err * 0.01f / <a class="code" href="classAP__SteerController.html#a403813143945c830c573f03079393228">_tau</a>;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classAP__SteerController.html#aaf42965b867c847976199bb550f7a529">get_steering_out_rate</a>(desired_rate);</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;}</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno"><a class="line" href="classAP__SteerController.html#ac8c0b959eaff74c682bf1f64aea6c930">  241</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAP__SteerController.html#ac8c0b959eaff74c682bf1f64aea6c930">AP_SteerController::reset_I</a>()</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;{</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <a class="code" href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">_pid_info</a>.<a class="code" href="structDataFlash__Class_1_1PID__Info.html#a224dedbec9a0e3d1a5e160c2827d1551">I</a> = 0;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;}</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div><div class="ttc" id="classAP__SteerController_html_acd31b38382cb4c935417585d2177ec40"><div class="ttname"><a href="classAP__SteerController.html#acd31b38382cb4c935417585d2177ec40">AP_SteerController::_K_I</a></div><div class="ttdeci">AP_Float _K_I</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00055">AP_SteerController.h:55</a></div></div>
<div class="ttc" id="classAP__SteerController_html_a5050abe38b7b2969ce6a2e780a9f60c2"><div class="ttname"><a href="classAP__SteerController.html#a5050abe38b7b2969ce6a2e780a9f60c2">AP_SteerController::_reverse</a></div><div class="ttdeci">bool _reverse</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00070">AP_SteerController.h:70</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a5c0b5c82749ac54970b2699d3c10ee9b"><div class="ttname"><a href="AP__Math_8h.html#a5c0b5c82749ac54970b2699d3c10ee9b">MAX</a></div><div class="ttdeci">static auto MAX(const A &amp;one, const B &amp;two) -&gt; decltype(one &gt; two?one:two)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00179">AP_Math.h:179</a></div></div>
<div class="ttc" id="classAP__SteerController_html_af20c84279bda606f69e2ce4b932218e5"><div class="ttname"><a href="classAP__SteerController.html#af20c84279bda606f69e2ce4b932218e5">AP_SteerController::_K_FF</a></div><div class="ttdeci">AP_Float _K_FF</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00053">AP_SteerController.h:53</a></div></div>
<div class="ttc" id="structDataFlash__Class_1_1PID__Info_html_a2c4183a4b3eaf152eb2d910eefee495c"><div class="ttname"><a href="structDataFlash__Class_1_1PID__Info.html#a2c4183a4b3eaf152eb2d910eefee495c">DataFlash_Class::PID_Info::D</a></div><div class="ttdeci">float D</div><div class="ttdef"><b>Definition:</b> <a href="DataFlash_8h_source.html#l00160">DataFlash.h:160</a></div></div>
<div class="ttc" id="AP__HAL_8h_html"><div class="ttname"><a href="AP__HAL_8h.html">AP_HAL.h</a></div></div>
<div class="ttc" id="AP__Common_8h_html_a728f9499baea61e7df3ae70a374f2512"><div class="ttname"><a href="AP__Common_8h.html#a728f9499baea61e7df3ae70a374f2512">ToRad</a></div><div class="ttdeci">#define ToRad(x)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Common_8h_source.html#l00042">AP_Common.h:42</a></div></div>
<div class="ttc" id="classAP__SteerController_html_aedd8ad2008dfaca62ec16664aa152f45"><div class="ttname"><a href="classAP__SteerController.html#aedd8ad2008dfaca62ec16664aa152f45">AP_SteerController::_imax</a></div><div class="ttdeci">AP_Int16 _imax</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00058">AP_SteerController.h:58</a></div></div>
<div class="ttc" id="classAP__SteerController_html_af7d4a8ee3c8ec0cd6da820f6c542d7a7"><div class="ttname"><a href="classAP__SteerController.html#af7d4a8ee3c8ec0cd6da820f6c542d7a7">AP_SteerController::_K_P</a></div><div class="ttdeci">AP_Float _K_P</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00054">AP_SteerController.h:54</a></div></div>
<div class="ttc" id="classAP__SteerController_html_afdb1a4d1e274a901b1af7a616fbcf8c9"><div class="ttname"><a href="classAP__SteerController.html#afdb1a4d1e274a901b1af7a616fbcf8c9">AP_SteerController::_deratespeed</a></div><div class="ttdeci">AP_Float _deratespeed</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00062">AP_SteerController.h:62</a></div></div>
<div class="ttc" id="structDataFlash__Class_1_1PID__Info_html_afded67a27b416d1a7d5a7af84c782de6"><div class="ttname"><a href="structDataFlash__Class_1_1PID__Info.html#afded67a27b416d1a7d5a7af84c782de6">DataFlash_Class::PID_Info::P</a></div><div class="ttdeci">float P</div><div class="ttdef"><b>Definition:</b> <a href="DataFlash_8h_source.html#l00158">DataFlash.h:158</a></div></div>
<div class="ttc" id="classAP__SteerController_html"><div class="ttname"><a href="classAP__SteerController.html">AP_SteerController</a></div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00008">AP_SteerController.h:8</a></div></div>
<div class="ttc" id="AP__Param_8h_html_a78a408c84f2a1bafde256ac650142e4d"><div class="ttname"><a href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a></div><div class="ttdeci">#define AP_GROUPINFO(name, idx, clazz, element, def)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Param_8h_source.html#l00087">AP_Param.h:87</a></div></div>
<div class="ttc" id="classAP__AHRS_html_a26a38955546934cac5b94125ebf87cfe"><div class="ttname"><a href="classAP__AHRS.html#a26a38955546934cac5b94125ebf87cfe">AP_AHRS::get_yaw_rate_earth</a></div><div class="ttdeci">float get_yaw_rate_earth(void) const </div><div class="ttdef"><b>Definition:</b> <a href="AP__AHRS_8h_source.html#l00208">AP_AHRS.h:208</a></div></div>
<div class="ttc" id="AP__Common_8h_html_a3c9d151923236c7e8ccccf86f131e550"><div class="ttname"><a href="AP__Common_8h.html#a3c9d151923236c7e8ccccf86f131e550">ToDeg</a></div><div class="ttdeci">#define ToDeg(x)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Common_8h_source.html#l00043">AP_Common.h:43</a></div></div>
<div class="ttc" id="structDataFlash__Class_1_1PID__Info_html_af1dd0ab3a1d25f7f93b6a97c51ae4a15"><div class="ttname"><a href="structDataFlash__Class_1_1PID__Info.html#af1dd0ab3a1d25f7f93b6a97c51ae4a15">DataFlash_Class::PID_Info::FF</a></div><div class="ttdeci">float FF</div><div class="ttdef"><b>Definition:</b> <a href="DataFlash_8h_source.html#l00161">DataFlash.h:161</a></div></div>
<div class="ttc" id="AP__SteerController_8h_html"><div class="ttname"><a href="AP__SteerController_8h.html">AP_SteerController.h</a></div></div>
<div class="ttc" id="classAP__SteerController_html_a38c31ad23a2f3b46c0ee2e8f33aca31c"><div class="ttname"><a href="classAP__SteerController.html#a38c31ad23a2f3b46c0ee2e8f33aca31c">AP_SteerController::_deratefactor</a></div><div class="ttdeci">AP_Float _deratefactor</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00063">AP_SteerController.h:63</a></div></div>
<div class="ttc" id="classAP__SteerController_html_ac8c0b959eaff74c682bf1f64aea6c930"><div class="ttname"><a href="classAP__SteerController.html#ac8c0b959eaff74c682bf1f64aea6c930">AP_SteerController::reset_I</a></div><div class="ttdeci">void reset_I()</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8cpp_source.html#l00241">AP_SteerController.cpp:241</a></div></div>
<div class="ttc" id="classAP__SteerController_html_afa9eb418deb8746e4dc7f7563e6e201d"><div class="ttname"><a href="classAP__SteerController.html#afa9eb418deb8746e4dc7f7563e6e201d">AP_SteerController::_minspeed</a></div><div class="ttdeci">AP_Float _minspeed</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00057">AP_SteerController.h:57</a></div></div>
<div class="ttc" id="AP__Math_8cpp_html_a603d717bc95dd546b9e2c4da57b88a39"><div class="ttname"><a href="AP__Math_8cpp.html#a603d717bc95dd546b9e2c4da57b88a39">wrap_180</a></div><div class="ttdeci">float wrap_180(const T angle, float unit_mod)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8cpp_source.html#l00093">AP_Math.cpp:93</a></div></div>
<div class="ttc" id="classAP__HAL_1_1HAL_html"><div class="ttname"><a href="classAP__HAL_1_1HAL.html">AP_HAL::HAL</a></div><div class="ttdef"><b>Definition:</b> <a href="HAL_8h_source.html#l00018">HAL.h:18</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a2a12cce483e9b870da70d30406d82c60"><div class="ttname"><a href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a></div><div class="ttdeci">bool is_zero(const T fVal1)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00039">AP_Math.h:39</a></div></div>
<div class="ttc" id="DerivativeFilter_8cpp_html_a357394e0f6f88c8a57bd893ab28dc8f8"><div class="ttname"><a href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a></div><div class="ttdeci">#define f(i)</div></div>
<div class="ttc" id="namespaceAP__HAL_html_a77dffbb18891996280308e21316ec186"><div class="ttname"><a href="namespaceAP__HAL.html#a77dffbb18891996280308e21316ec186">AP_HAL::millis</a></div><div class="ttdeci">uint32_t millis()</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__Linux_2system_8cpp_source.html#l00043">system.cpp:43</a></div></div>
<div class="ttc" id="structAP__Param_1_1GroupInfo_html"><div class="ttname"><a href="structAP__Param_1_1GroupInfo.html">AP_Param::GroupInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="AP__Param_8h_source.html#l00126">AP_Param.h:126</a></div></div>
<div class="ttc" id="classAP__SteerController_html_a40d629a25fa92f1a392553813174866b"><div class="ttname"><a href="classAP__SteerController.html#a40d629a25fa92f1a392553813174866b">AP_SteerController::_ahrs</a></div><div class="ttdeci">AP_AHRS &amp; _ahrs</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00068">AP_SteerController.h:68</a></div></div>
<div class="ttc" id="classAP__SteerController_html_a6285aeb38fd5614ecd53ae0b83d162ba"><div class="ttname"><a href="classAP__SteerController.html#a6285aeb38fd5614ecd53ae0b83d162ba">AP_SteerController::get_steering_out_lat_accel</a></div><div class="ttdeci">int32_t get_steering_out_lat_accel(float desired_accel)</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8cpp_source.html#l00209">AP_SteerController.cpp:209</a></div></div>
<div class="ttc" id="AP__Math_8h_html"><div class="ttname"><a href="AP__Math_8h.html">AP_Math.h</a></div></div>
<div class="ttc" id="classAP__SteerController_html_aaddb47f5f1afab6b88e22bbdc5f09df8"><div class="ttname"><a href="classAP__SteerController.html#aaddb47f5f1afab6b88e22bbdc5f09df8">AP_SteerController::_mindegree</a></div><div class="ttdeci">AP_Float _mindegree</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00064">AP_SteerController.h:64</a></div></div>
<div class="ttc" id="classAP__SteerController_html_a267a9ae84472fc704e7eb9c82cc82aee"><div class="ttname"><a href="classAP__SteerController.html#a267a9ae84472fc704e7eb9c82cc82aee">AP_SteerController::_K_D</a></div><div class="ttdeci">AP_Float _K_D</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00056">AP_SteerController.h:56</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a6b187a3fa1e9f663e89175e7e8e213d6"><div class="ttname"><a href="AP__Math_8h.html#a6b187a3fa1e9f663e89175e7e8e213d6">MIN</a></div><div class="ttdeci">static auto MIN(const A &amp;one, const B &amp;two) -&gt; decltype(one&lt; two?one:two)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00173">AP_Math.h:173</a></div></div>
<div class="ttc" id="AP__Math_8h_html_ad525609d9dba6ffa556a0fbf08a3f9b4"><div class="ttname"><a href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a></div><div class="ttdeci">float constrain_float(const float amt, const float low, const float high)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00119">AP_Math.h:119</a></div></div>
<div class="ttc" id="classAP__SteerController_html_a403813143945c830c573f03079393228"><div class="ttname"><a href="classAP__SteerController.html#a403813143945c830c573f03079393228">AP_SteerController::_tau</a></div><div class="ttdeci">AP_Float _tau</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00052">AP_SteerController.h:52</a></div></div>
<div class="ttc" id="AP__SteerController_8cpp_html_ae08c3ca4ba26b63cda0bb3e3c6c02785"><div class="ttname"><a href="AP__SteerController_8cpp.html#ae08c3ca4ba26b63cda0bb3e3c6c02785">hal</a></div><div class="ttdeci">const AP_HAL::HAL &amp; hal</div><div class="ttdoc">-*- tab-width: 4; Mode: C++; c-basic-offset: 4; indent-tabs-mode: nil -*- </div><div class="ttdef"><b>Definition:</b> <a href="AC__PID__test_8cpp_source.html#l00010">AC_PID_test.cpp:10</a></div></div>
<div class="ttc" id="structDataFlash__Class_1_1PID__Info_html_a039854d85412b90657a08d11358a286a"><div class="ttname"><a href="structDataFlash__Class_1_1PID__Info.html#a039854d85412b90657a08d11358a286a">DataFlash_Class::PID_Info::desired</a></div><div class="ttdeci">float desired</div><div class="ttdef"><b>Definition:</b> <a href="DataFlash_8h_source.html#l00157">DataFlash.h:157</a></div></div>
<div class="ttc" id="classAP__SteerController_html_ae41f9b579fbd29cef4ac04fd6a3e43c2"><div class="ttname"><a href="classAP__SteerController.html#ae41f9b579fbd29cef4ac04fd6a3e43c2">AP_SteerController::_pid_info</a></div><div class="ttdeci">DataFlash_Class::PID_Info _pid_info</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00066">AP_SteerController.h:66</a></div></div>
<div class="ttc" id="classAP__SteerController_html_aaf42965b867c847976199bb550f7a529"><div class="ttname"><a href="classAP__SteerController.html#aaf42965b867c847976199bb550f7a529">AP_SteerController::get_steering_out_rate</a></div><div class="ttdeci">int32_t get_steering_out_rate(float desired_rate)</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8cpp_source.html#l00122">AP_SteerController.cpp:122</a></div></div>
<div class="ttc" id="classAP__SteerController_html_afda95cde8bbceff648ac1c56e5800e1c"><div class="ttname"><a href="classAP__SteerController.html#afda95cde8bbceff648ac1c56e5800e1c">AP_SteerController::var_info</a></div><div class="ttdeci">static const struct AP_Param::GroupInfo var_info[]</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00043">AP_SteerController.h:43</a></div></div>
<div class="ttc" id="classAP__SteerController_html_a00380bb52421fff63822e3014d8f6844"><div class="ttname"><a href="classAP__SteerController.html#a00380bb52421fff63822e3014d8f6844">AP_SteerController::_last_out</a></div><div class="ttdeci">float _last_out</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00060">AP_SteerController.h:60</a></div></div>
<div class="ttc" id="classAP__AHRS_html_a11efcc2b48256bf736f33ac26063ae16"><div class="ttname"><a href="classAP__AHRS.html#a11efcc2b48256bf736f33ac26063ae16">AP_AHRS::groundspeed</a></div><div class="ttdeci">float groundspeed(void)</div><div class="ttdef"><b>Definition:</b> <a href="AP__AHRS_8h_source.html#l00359">AP_AHRS.h:359</a></div></div>
<div class="ttc" id="classAP__SteerController_html_a9c0010547b39dacee51168be499a0302"><div class="ttname"><a href="classAP__SteerController.html#a9c0010547b39dacee51168be499a0302">AP_SteerController::_last_t</a></div><div class="ttdeci">uint32_t _last_t</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8h_source.html#l00059">AP_SteerController.h:59</a></div></div>
<div class="ttc" id="classAP__SteerController_html_a58fa2b841c4507318c4560ff237b4db9"><div class="ttname"><a href="classAP__SteerController.html#a58fa2b841c4507318c4560ff237b4db9">AP_SteerController::get_steering_out_angle_error</a></div><div class="ttdeci">int32_t get_steering_out_angle_error(int32_t angle_err)</div><div class="ttdef"><b>Definition:</b> <a href="AP__SteerController_8cpp_source.html#l00229">AP_SteerController.cpp:229</a></div></div>
<div class="ttc" id="AP__Param_8h_html_a0f9acb038a5283b964b862aea8cc5051"><div class="ttname"><a href="AP__Param_8h.html#a0f9acb038a5283b964b862aea8cc5051">AP_GROUPEND</a></div><div class="ttdeci">#define AP_GROUPEND</div><div class="ttdef"><b>Definition:</b> <a href="AP__Param_8h_source.html#l00102">AP_Param.h:102</a></div></div>
<div class="ttc" id="structDataFlash__Class_1_1PID__Info_html_a224dedbec9a0e3d1a5e160c2827d1551"><div class="ttname"><a href="structDataFlash__Class_1_1PID__Info.html#a224dedbec9a0e3d1a5e160c2827d1551">DataFlash_Class::PID_Info::I</a></div><div class="ttdeci">float I</div><div class="ttdef"><b>Definition:</b> <a href="DataFlash_8h_source.html#l00159">DataFlash.h:159</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Apr 14 2017 11:51:15 for APM:Libraries by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
